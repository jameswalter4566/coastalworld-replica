//  Merci-Michel [R]
//  https://www.merci-michel.com/
//  Build 20250626-165126

import{aM as e,aN as t,aO as s,aP as i,aQ as o,aR as a,aS as n,aT as r,aU as l,aV as c,aW as h,aX as u,aY as d,a9 as p,aZ as f,s as m,a_ as g,a$ as y,b0 as b,w as v,a8 as w,b1 as _,b2 as x,b3 as S,b4 as M,b5 as T,b6 as O,b7 as P,b8 as A,b9 as I,ba as C,bb as R,bc as k,bd as D,be as L,bf as E,bg as F,j as U,bh as z,bi as B,bj as N,bk as j,bl as V,bm as H,y as W,aA as G,bn as q,G as Y,ah as K,bo as X,bp as $,bq as Z,br as J,bs as Q,bt as ee,bu as te,bv as se,bw as ie,bx as oe,by as ae,bz as ne,O as re,bA as le,bB as ce,bC as he,i as ue,bD as de,bE as pe,bF as fe,bG as me,bH as ge,bI as ye,bJ as be,bK as ve,bL as we,bM as _e,bN as xe,bO as Se,bP as Me,bQ as Te,bR as Oe,aH as Pe,bS as Ae,bT as Ie,bU as Ce,bV as Re,bW as ke,bX as De,bY as Le,bZ as Ee,b_ as Fe,b$ as Ue,c0 as ze,c1 as Be,c2 as Ne,c3 as je,c4 as Ve,c5 as He,c6 as We,c7 as Ge,c8 as qe,c9 as Ye,ca as Ke,cb as Xe,cc as $e,cd as Ze,ce as Je,cf as Qe,cg as et,ch as tt,ci as st,cj as it,ck as ot,cl as at,cm as nt,cn as rt,co as lt,cp as ct,cq as ht,cr as ut,cs as dt,ct as pt,cu as ft,cv as mt,cw as gt,cx as yt,cy as bt,cz as vt,a as wt,cA as _t,cB as xt,cC as St,cD as Mt,cE as Tt,cF as Ot,cG as Pt,ae as At,cH as It,cI as Ct,cJ as Rt,cK as kt,cL as Dt,cM as Lt,aC as Et,cN as Ft,cO as Ut,cP as zt,cQ as Bt,h as Nt,cR as jt,cS as Vt,cT as Ht,cU as Wt,cV as Gt,cW as qt,cX as Yt,cY as Kt,cZ as Xt,c_ as $t,c$ as Zt,d0 as Jt,d1 as Qt,d2 as es,d3 as ts,d4 as ss,d5 as is,d6 as os,d7 as as,d8 as ns,d9 as rs,da as ls,ad as cs,db as hs}from"./vendor.75f6e6ae65453426.js";const us=Object.freeze(Object.defineProperty({__proto__:null,default:"#ifndef FOG_FAR_MULT\n#define FOG_FAR_MULT 1.\n#endif\n#ifdef USE_FOG\n#ifndef USE_MAP_MODE\nfloat _fogNear=fogNear;float fogFactor=smoothstep(_fogNear*1.1,fogFar*FOG_FAR_MULT,vFogDepth);float fogFactor2=smoothstep(_fogNear*0.7,fogFar*0.9*FOG_FAR_MULT,vFogDepth);fogFactor2*=1.-fogFactor;const vec3 fogColor=FOG_FAR;const vec3 fogColor2=FOG_NEAR;gl_FragColor.rgb=mix(gl_FragColor.rgb,fogColor2,clamp(fogFactor2*1.1,0.,1.));gl_FragColor.rgb=mix(gl_FragColor.rgb,fogColor,clamp(fogFactor*0.7,0.,1.));\n#endif\n#endif"},Symbol.toStringTag,{value:"Module"})),ds=Object.freeze(Object.defineProperty({__proto__:null,default:"uniform float fogNear;uniform float fogFar;varying float vFogDepth;"},Symbol.toStringTag,{value:"Module"})),ps=Object.freeze(Object.defineProperty({__proto__:null,default:"vec3 bigShadowDist=(cameraPosition-vWorldPos.xyz)*bigShadowFalloff;float bigShadowLen=dot(bigShadowDist,bigShadowDist);float bigShadowWeight=clamp(bigShadowLen*bigShadowLen*bigShadowLen*bigShadowLen,.0,1.);directionalLight=directionalLights[0];getDirectionalLightInfo(directionalLight,geometry,directLight);directionalLightShadow=directionalLightShadows[0];float invBigShadowDynamicChunks=(1.-bigShadowDynamicChunks);float shadow=all(bvec3(directLight.visible,receiveShadow,bigShadowWeight<0.999))?getShadow(directionalShadowMap[0],directionalLightShadow.shadowMapSize,directionalLightShadow.shadowBias,directionalLightShadow.shadowRadius,vDirectionalShadowCoord[0]):1.0;float shadowBig=bigShadowWeight>(0.001-invBigShadowDynamicChunks)?getShadow(bigShadowMap,bigShadow.mapSize,bigShadow.bias,bigShadow.radius,vBigShadowDirectionalCoords):1.;float shadowFade=1.-bigShadowWeight*invBigShadowDynamicChunks;shadow=1.-(1.-smoothstep(0.4,0.92,shadow))*shadowFade;shadowBig=1.-(1.-smoothstep(0.4,0.92,shadowBig))*1.;vec3 shadowColor=mix(SHADOW_COLOR,vec3(1.),shadow);vec3 shadowBigColor=mix(SHADOW_COLOR,vec3(1.),shadowBig);vec3 allDynColor=mix(shadowColor,shadowBigColor,bigShadowWeight);vec3 nonDynColor=min(shadowColor,shadowBigColor);directLight.color*=mix(nonDynColor,allDynColor,bigShadowDynamicChunks);RE_Direct(directLight,geometry,material,reflectedLight);"},Symbol.toStringTag,{value:"Module"})),fs=Object.freeze(Object.defineProperty({__proto__:null,default:"#define USE_BIG_SHADOWMAP\nstruct BigShadow{vec2 mapSize;float bias;float radius;};uniform BigShadow bigShadow;uniform float bigShadowFalloff;uniform float bigShadowDynamicChunks;uniform sampler2D bigShadowMap;varying vec4 vBigShadowDirectionalCoords;"},Symbol.toStringTag,{value:"Module"})),ms=Object.freeze(Object.defineProperty({__proto__:null,default:"float blendOverlay(float base,float blend){return base<0.5?(2.0*base*blend):(1.0-2.0*(1.0-base)*(1.0-blend));}vec3 blendOverlay(vec3 base,vec3 blend){return vec3(blendOverlay(base.r,blend.r),blendOverlay(base.g,blend.g),blendOverlay(base.b,blend.b));}vec3 blendOverlay(vec3 base,vec3 blend,float opacity){return(blendOverlay(base,blend)*opacity+base*(1.0-opacity));}"},Symbol.toStringTag,{value:"Module"})),gs=Object.freeze(Object.defineProperty({__proto__:null,default:"vec2 cT=vec2(-0.0012,0.)*time;\n#ifdef IS_MOBILE\nfloat cB=texture2D(noise,vWorldPos.xz*0.0012+cT).r;float clouds=smoothstep(0.45,0.34,cB);\n#ifndef IS_MAP_MODE\ndiffuseColor.rgb+=diffuseColor.rgb*clouds*-0.10*CLOUDS_COLOR;\n#endif\n#else\nfloat cA=texture2D(noise,vWorldPos.xz*0.009+cT).r;float cB=texture2D(noise,vWorldPos.xz*0.001+cT+cA*0.005).r;float clouds=smoothstep(0.45,0.38,cB);\n#ifndef IS_MAP_MODE\ndiffuseColor.rgb+=diffuseColor.rgb*clouds*-0.11*CLOUDS_COLOR;\n#endif\n#endif"},Symbol.toStringTag,{value:"Module"})),ys=Object.freeze(Object.defineProperty({__proto__:null,default:"float between(float x,vec2 hit){return min(1.,smoothstep(hit.x+0.25,hit.x-0.25,x)+smoothstep(hit.y-0.25,hit.y+0.25,x));}float when_gt(float x,float y){return max(sign(x-y),0.0);}float when_lt(float x,float y){return max(sign(y-x),0.0);}"},Symbol.toStringTag,{value:"Module"})),bs=Object.freeze(Object.defineProperty({__proto__:null,default:"#ifndef HAS_WEBXR\nvec2 dpUV=(gl_FragCoord.xy*pixelRatio)*0.15;dpUV.x+=step(1.,mod(dpUV.y,2.))*0.5;dpUV=fract(dpUV);float dpLimit=smoothstep(0.3,0.999,gl_FragCoord.w);float dpMask=smoothstep(dpLimit-0.2,dpLimit,length(dpUV-vec2(0.5)));if(dpMask<0.5){discard;}\n#endif"},Symbol.toStringTag,{value:"Module"})),vs=Object.freeze(Object.defineProperty({__proto__:null,default:"#ifndef PI\n#define PI 3.141592653589793\n#endif\n#ifndef HALF_PI\n#define HALF_PI 1.5707963267948966\n#endif\nfloat backInOut(const in float t){float f=t<.5?2.*t:1.-(2.*t-1.);float g=pow(f,3.)-f*sin(f*PI);return t<.5?.5*g:.5*(1.-g)+.5;}float backIn(float t){return pow(t,3.)-t*sin(t*PI);}float backOut(float t){float f=1.-t;return 1.-(pow(f,3.)-f*sin(f*PI));}float bounceOut(float t){const float a=4./11.;const float b=8./11.;const float c=9./10.;const float ca=4356./361.;const float cb=35442./1805.;const float cc=16061./1805.;float t2=t*t;return t<a?7.5625*t2:t<b?9.075*t2-9.9*t+3.4:t<c?ca*t2-cb*t+cc:10.8*t*t-20.52*t+10.72;}float bounceInOut(float t){return t<.5?.5*(1.-bounceOut(1.-t*2.)):.5*bounceOut(t*2.-1.)+.5;}float bounceIn(float t){return 1.-bounceOut(1.-t);}float circularIn(float t){return 1.-sqrt(1.-t*t);}float circularOut(float t){return sqrt((2.-t)*t);}float circularInOut(float t){return t<.5?.5*(1.-sqrt(1.-4.*t*t)):.5*(sqrt((3.-2.*t)*(2.*t-1.))+1.);}float cubicInOut(float t){return t<.5?4.*t*t*t:.5*pow(2.*t-2.0,3.)+1.;}float cubicIn(float t){return t*t*t;}float cubicOut(float t){float f=t-1.;return f*f*f+1.;}float elasticIn(float t){return sin(13.*t*HALF_PI)*pow(2.0,10.*(t-1.));}float elasticOut(float t){return sin(-13.*(t+1.)*HALF_PI)*pow(2.0,-10.*t)+1.;}float elasticInOut(float t){return t<.5?.5*sin(+13.*HALF_PI*2.*t)*pow(2.0,10.*(2.*t-1.)):.5*sin(-13.*HALF_PI*((2.*t-1.)+1.))*pow(2.0,-10.*(2.*t-1.))+1.;}float exponentialIn(float t){return t==.0?t:pow(2.0,10.*(t-1.));}float exponentialOut(float t){return t==1.?t:1.-pow(2.0,-10.*t);}float exponentialInOut(float t){return t==.0||t==1.?t:t<.5?+0.5*pow(2.0,(20.*t)-10.):-0.5*pow(2.0,10.-(t*20.))+1.;}float quadraticIn(float t){return t*t;}float quadraticOut(float t){return-t*(t-2.);}float quadraticInOut(float t){float p=2.*t*t;return t<.5?p:-p+(4.*t)-1.;}float quarticIn(float t){return pow(t,4.);}float quarticOut(float t){return pow(t-1.0,3.)*(1.-t)+1.;}float quarticInOut(float t){return t<.5?+8.*pow(t,4.):-8.*pow(t-1.0,4.)+1.;}float qinticIn(float t){return pow(t,5.);}float qinticOut(float t){return 1.-(pow(t-1.0,5.));}float qinticInOut(float t){return t<.5?+16.*pow(t,5.):-.5*pow(2.*t-2.0,5.)+1.;}float sineInOut(float t){return-0.5*(cos(PI*t)-1.);}float sineIn(float t){return sin((t-1.)*HALF_PI)+1.;}float sineOut(float t){return sin(t*HALF_PI);}float linear(float t){return t;}"},Symbol.toStringTag,{value:"Module"})),ws=Object.freeze(Object.defineProperty({__proto__:null,default:"mat4 getInstanceMatrix(vec3 p,vec4 q,vec3 s){mat4 m;float x=q.x;float y=q.y;float z=q.z;float w=q.w;float x2=x+x;float y2=y+y;float z2=z+z;float xx=x*x2;float xy=x*y2;float xz=x*z2;float yy=y*y2;float yz=y*z2;float zz=z*z2;float wx=w*x2;float wy=w*y2;float wz=w*z2;float sx=s.x;float sy=s.y;float sz=s.z;m[0][0]=(1.-(yy+zz))*sx;m[0][1]=(xy+wz)*sx;m[0][2]=(xz-wy)*sx;m[0][3]=0.;m[1][0]=(xy-wz)*sy;m[1][1]=(1.-(xx+zz))*sy;m[1][2]=(yz+wx)*sy;m[1][3]=0.;m[2][0]=(xz+wy)*sz;m[2][1]=(yz-wx)*sz;m[2][2]=(1.-(xx+yy))*sz;m[2][3]=0.;m[3][0]=p.x;m[3][1]=p.y;m[3][2]=p.z;m[3][3]=1.;return m;}"},Symbol.toStringTag,{value:"Module"})),_s=Object.freeze(Object.defineProperty({__proto__:null,default:"GeometricContext geometry;geometry.position=-vViewPosition;geometry.normal=normal;geometry.viewDir=(isOrthographic)?vec3(0,0,1):normalize(vViewPosition);\n#ifdef CLEARCOAT\ngeometry.clearcoatNormal=clearcoatNormal;\n#endif\nIncidentLight directLight;\n#if (NUM_POINT_LIGHTS>0)&&defined(RE_Direct)\nPointLight pointLight;\n#if defined(USE_SHADOWMAP)&&NUM_POINT_LIGHT_SHADOWS>0\nPointLightShadow pointLightShadow;\n#endif\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_POINT_LIGHTS;i++){pointLight=pointLights[i];getPointLightInfo(pointLight,geometry,directLight);\n#if defined(USE_SHADOWMAP)&&(UNROLLED_LOOP_INDEX<NUM_POINT_LIGHT_SHADOWS)\npointLightShadow=pointLightShadows[i];directLight.color*=all(bvec2(directLight.visible,receiveShadow))?getPointShadow(pointShadowMap[i],pointLightShadow.shadowMapSize,pointLightShadow.shadowBias,pointLightShadow.shadowRadius,vPointShadowCoord[i],pointLightShadow.shadowCameraNear,pointLightShadow.shadowCameraFar):1.0;\n#endif\nRE_Direct(directLight,geometry,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if (NUM_SPOT_LIGHTS>0)&&defined(RE_Direct)\nSpotLight spotLight;\n#if defined(USE_SHADOWMAP)&&NUM_SPOT_LIGHT_SHADOWS>0\nSpotLightShadow spotLightShadow;\n#endif\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_SPOT_LIGHTS;i++){spotLight=spotLights[i];getSpotLightInfo(spotLight,geometry,directLight);\n#if defined(USE_SHADOWMAP)&&(UNROLLED_LOOP_INDEX<NUM_SPOT_LIGHT_SHADOWS)\nspotLightShadow=spotLightShadows[i];directLight.color*=all(bvec2(directLight.visible,receiveShadow))?getShadow(spotShadowMap[i],spotLightShadow.shadowMapSize,spotLightShadow.shadowBias,spotLightShadow.shadowRadius,vSpotShadowCoord[i]):1.0;\n#endif\nRE_Direct(directLight,geometry,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if (NUM_DIR_LIGHTS>0)&&defined(RE_Direct)\nDirectionalLight directionalLight;\n#if defined(USE_SHADOWMAP)&&NUM_DIR_LIGHT_SHADOWS>0\nDirectionalLightShadow directionalLightShadow;\n#endif\n#if defined(USE_SHADOWMAP)&&defined(USE_BIG_SHADOWMAP)&&NUM_DIR_LIGHT_SHADOWS==1\n#include <big_shadow>\n#elif \n#pragma unroll_loop_start\nfor(int i=0;i<NUM_DIR_LIGHTS;i++){}\n#pragma unroll_loop_end\n#endif\n#endif\n#if (NUM_RECT_AREA_LIGHTS>0)&&defined(RE_Direct_RectArea)\nRectAreaLight rectAreaLight;\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_RECT_AREA_LIGHTS;i++){rectAreaLight=rectAreaLights[i];RE_Direct_RectArea(rectAreaLight,geometry,material,reflectedLight);}\n#pragma unroll_loop_end\n#endif\n#if defined(RE_IndirectDiffuse)\nvec3 iblIrradiance=vec3(0.0);vec3 irradiance=getAmbientLightIrradiance(ambientLightColor);\n#if (NUM_HEMI_LIGHTS>0)\n#pragma unroll_loop_start\nfor(int i=0;i<NUM_HEMI_LIGHTS;i++){irradiance+=getHemisphereLightIrradiance(hemisphereLights[i],geometry);}\n#pragma unroll_loop_end\n#endif\n#endif\n#if defined(RE_IndirectSpecular)\nvec3 radiance=vec3(0.0);vec3 clearcoatRadiance=vec3(0.0);\n#endif"},Symbol.toStringTag,{value:"Module"})),xs=Object.freeze(Object.defineProperty({__proto__:null,default:"float linearstep(float start,float end,float value){return(clamp(value,start,end)-start)/(end-start);}"},Symbol.toStringTag,{value:"Module"})),Ss=Object.freeze(Object.defineProperty({__proto__:null,default:"float luma(vec3 color){return dot(color,vec3(0.299,0.587,0.114));}"},Symbol.toStringTag,{value:"Module"})),Ms=Object.freeze(Object.defineProperty({__proto__:null,default:"vec2 screenSpaceUv=vec2(gl_FragCoord.xy)/res.xy;vec2 ratio=vec2(clamp(0.,1.,res.x/res.y),clamp(0.,1.,res.y/res.x));screenSpaceUv.x*=ratio.x;screenSpaceUv.y*=ratio.y;screenSpaceUv.x+=(1.-ratio.x)/2.;screenSpaceUv.y+=(1.-ratio.y)/2.;float circle=distance(screenSpaceUv,vec2(0.5));circle=1.-step(circle,maskRadius);"},Symbol.toStringTag,{value:"Module"})),Ts=Object.freeze(Object.defineProperty({__proto__:null,default:"uniform float road;uniform float sea;uniform float games;uniform float maskRadius;"},Symbol.toStringTag,{value:"Module"})),Os=Object.freeze(Object.defineProperty({__proto__:null,default:"vec3 wColor=gl_FragColor.xyz-wet*0.09;vec3 underwaterColor=(wColor*waterTopColor)*UNDERWATER_MULT+0.4;\n#ifdef IS_MAP_MODE\nif(hasWater>0.9999){discard;}\n#else\nwColor=mix(wColor,underwaterColor,hasWater*0.8);wColor=mix(wColor,waterColor,hasWater*waterDepth);wColor=mix(wColor,vec3(1.),hasFoam*1.);\n#endif\n#if defined(IS_BIOME_TESTLAB)\nfloat d=distance(vWorldPos.xz,vec2(0.));wColor=mix(wColor,gl_FragColor.xyz,step(40.,d));\n#endif\ngl_FragColor.xyz=vec3(wColor);"},Symbol.toStringTag,{value:"Module"})),Ps=Object.freeze(Object.defineProperty({__proto__:null,default:"float wpy=vWorldPos.y;float waterDepth=1.-linearstep(WATER_MAX_DEPTH,WATER_BASE_LEVEL,wpy);float foamY=cos((vWorldPos.z+vWorldPos.x)*0.9+time*1.4)*0.015-0.0075;float waterLevel=WATER_BASE_LEVEL+waterProgress+foamY;float wetBaseLevel=WATER_BASE_LEVEL-waterLevel*0.1;float wet=max(0.2,sin(time-PI*0.5))*smoothstep(wetBaseLevel+0.43,wetBaseLevel+0.3,wpy)*when_gt(wpy,waterLevel);float hasFoam=when_gt(wpy,waterLevel)*when_lt(wpy,waterLevel+WATER_FOAM_HEIGHT);float hasWater=when_lt(wpy,waterLevel);"},Symbol.toStringTag,{value:"Module"})),As=Object.freeze(Object.defineProperty({__proto__:null,default:"vWorldPos=modelMatrix*vec4(transformed,1.);"},Symbol.toStringTag,{value:"Module"})),Is=Object.freeze(Object.defineProperty({__proto__:null,default:"varying vec4 vWorldPos;"},Symbol.toStringTag,{value:"Module"})),Cs=Object.assign({"./bg_fog.glsl":us,"./bg_fog_pars.glsl":ds,"./big_shadow.glsl":ps,"./big_shadow_pars.glsl":fs,"./blend_modes.glsl":ms,"./clouds.glsl":gs,"./conditionals.glsl":ys,"./depth_dither.glsl":bs,"./eases.glsl":vs,"./get_instance_matrix.glsl":ws,"./lights_fragment_begin.glsl":_s,"./linear_step.glsl":xs,"./luma.glsl":Ss,"./transition_mask.glsl":Ms,"./transition_mask_pars.glsl":Ts,"./water_depth_frag.glsl":Os,"./water_depth_frag_pre.glsl":Ps,"./world_pos.glsl":As,"./world_pos_pars.glsl":Is});let Rs=null;const ks={autostart:!0,selfdestruct:!1,standalone:!1};class Ds extends t{created(){Rs||(Rs=s());const e=this.base;e.timers=[],this.options.extendProto?(this.extendProto("wait",Ls),this.extendProto("timer",Es),this.extendProto("clearTimers",Fs)):(e.wait=i(Ls,e,1),e.timer=i(Es,e,2),e.clearTimers=i(Fs,e,0))}update(){const e=Rs.time.dt,t=this.base.timers;let s=t.length;for(;s--;)t[s].update(e),t[s]._stopped&&(t[s].dispose(),t.splice(s,1))}destroyed(){this.base.clearTimers()}}function Ls(e){return this.timer(e)}function Es(e,t){if(!this.destroyed){if(t){const s=o(e,t,ks);return this.timers.push(s),s}return new Promise((t=>{const s=o(e,t,ks);this.timers.push(s)}))}}function Fs(){for(let e=0,t=this.timers.length;e<t;e++){const t=this.timers[e];t&&t.dispose()}this.timers.length=0}class Us extends t{created(){const e=this.base;e.timers=[],e._disposablesSignals=[],e.store||(e.store={}),e.hooks||(e.hooks={}),this.options.extendProto?(this.extendProto("watchSignal",Bs),this.extendProto("watchSignalImmediate",Ns),this.extendProto("disposableSignal",zs),this.extendProto("autoUnwatch",zs)):(e.watchSignal=i(Bs,e,4),e.watchSignalImmediate=i(Ns,e,3),e.disposableSignal=i(zs,e,1),e.autoUnwatch=e.disposableSignal)}destroyed(){const e=this.base;for(let t=0,s=e._disposablesSignals.length;t<s;t++){const s=e._disposablesSignals[t];if(s.unwatchAll)s.unwatchAll();else{const s=e._disposablesSignals[t].owner;s&&s.unwatch(e._disposablesSignals[t])}}for(let t in e.store){const s=e.store[t];s.unwatchAll&&s.unwatchAll()}for(let t in e.hooks){const s=e.hooks[t];s.unwatchAll&&s.unwatchAll()}e.store=e.hooks=null,e._disposablesSignals=null}}function zs(e){if(Array.isArray(e))for(let t=0,s=e.length;t<s;t++)this._disposablesSignals.push(e[t]);else this._disposablesSignals.push(e);return e}function Bs(e,t,s,i=!1){"string"==typeof t&&(t=this[t]),s||(s=this);const o=i?e.watchImmediate(t,s):e.watch(t,s);return this._disposablesSignals.push(o),o}function Ns(e,t,s){return this.watchSignal(e,t,s,!0)}class js extends t{created(){const e=this.base;this.extendProto("updateDynamicProps",Ws),this.extendProto("initDynamicProps",Hs),Vs.call(e)}destroyed(){this.base}}function Vs(){const e=this.props,t=e.sceneID,s=this.webgl.resources.scenes[t],i=this.dynamicProps=e.dynamicProps||{};this.dynamicPropsAlloc=s.dynamicPropsAllocs[e.uid],this.dynamicPropsVertices=s.dynamicPropsVertices[e.uid],this.dynamicPropsPhysicsLayers={},this.dynamicPropsState={},this.dynamicPropsStateUpdated=this.autoUnwatch(a());for(let o in i){const e=i[o];this.dynamicPropsState[o]=!!e.default,e.physicsLayer&&!this.dynamicPropsPhysicsLayers[e.physicsLayer]&&(this.dynamicPropsPhysicsLayers[e.physicsLayer]={collider:e.collider,previousVisibility:null,visible:null})}}function Hs(){this.initDynamicPropsState&&this.initDynamicPropsState(this.dynamicPropsState);for(let e in this.dynamicProps)qs.call(this,e,this.dynamicPropsState[e]),this.scene.physics.isReady?Gs.call(this):this.scene.physics.readyPromise.then((()=>{this.destroyed||Gs.call(this)}))}function Ws(e={},t=!1){const s=this.dynamicPropsState;let i=!1;for(let o in e)null!=s[o]&&(t||s[o]!=e[o])&&(s[o]=e[o],qs.call(this,o,e[o]),i=!0);i&&(Gs.call(this),this.dynamicPropsStateUpdated.emit())}function Gs(){const e=this.dynamicPropsPhysicsLayers;for(let t in e){const s=e[t];s.previousVisibility=s.visible,s.visible=!1}for(let t in this.dynamicProps){const s=this.dynamicProps[t];if(!s.physicsLayer)continue;const i=this.dynamicPropsState[t];e[s.physicsLayer].visible|=i}for(let t in e){const s=e[t];s.visible!==s.previousVisibility&&this.scene.physics.toggleLayer(t,s.visible)}}function qs(e,t){if(null==this.dynamicPropsState[e])return;const s=this.dynamicPropsVertices[e];if(s){const i=this.webgl.resources.scenes[this.props.sceneID].chunks,o=this.dynamicPropsAlloc[e],a=i[o.chunk].attributes.position,n=o.start,r=o.start+o.count;t?a.array.set(s,n):a.array.fill(1e7,n,r);const l=a.updateRange,c=Math.max(0,l.offset+l.count);l.offset=l.count<0?n:Math.min(l.offset,n);const h=Math.max(c,r);l.count=h-l.offset,a.needsUpdate=!0}}const Ys=new n;new r;const Ks=new l,Xs=new c,$s=new h;function Zs(e,t,s=0){Ys.copy(t).project(e);const i=Ys.x,o=Ys.y,a=1+s,n=-1-s;return i<a&&i>n&&o<a&&o>n}const Js=[],Qs=new l;class ei extends u{init(){this.prevCheck=0,this.forceUpdate=!0,this.broadphase=this.scene.add(d,{onChange:()=>this.forceUpdate=!0}),this.prevVector=null,this.prevPosition=new n,this.currentEl=null,this.prevContainedPosition=new n,this.lastDateWithoutZone=0,this.frustum=new c,this.muteDelay=0,this.webgl.store.interactionVisibles.watch(this.updateForce,this),setTimeout((()=>this.updateForce()),1500),this.updateForceDeffer=()=>{this.detroyed||(this.forceUpdate=!0,this.update())}}updateForce(){this.detroyed||(this.forceUpdate=!0,this.update(),clearTimeout(this.updateForceTimer),this.updateForceTimer=setTimeout(this.updateForceDeffer,200))}update(){const e=this.scene.getCurrentCamera();Qs.multiplyMatrices(e.cam.projectionMatrix,e.cam.matrixWorldInverse),this.frustum.setFromProjectionMatrix(Qs);const t=e.playerCanInteract?this.scene.player.base.position:e.cam.position;t!==this.prevVector&&(this.forceUpdate=!0),this.prevVector=t;const s=performance.now(),i=s-this.prevCheck,o=this.prevPosition.distanceToSquared(t),a=this.forceUpdate||o>.05;if(!a&&i<700)return;if(this.prevPosition.copy(t),!this.forceUpdate&&i<100)return;if(this.prevCheck=s,!this.scene.player.canMove)return;Js.length=0;let n=!1;const r=this.broadphase.getCell(t);for(let c=0,h=r.items.length;c<h;c++){const s=r.items[c].element;if(!a&&!s.isMoving&&s!==this.currentEl)continue;if(!s.boundingSphere.containsPoint(t))continue;let i=Zs(e.cam,s.iconPosition,.1);if(i&&s===this.currentEl&&(n=!0),i=Zs(e.cam,s.iconPosition,-.2),i)if(1!==s.spheres.length)for(let e=0,o=s.spheres.length;e<o;e++){if(s.spheres[e].containsPoint(t)){Js.push(s);break}}else Js.push(s)}let l;if(Js.length>1){this.prevContainedPosition.copy(t),this.lastDateWithoutZone=s;let e=Number.POSITIVE_INFINITY;for(let s=0,i=Js.length;s<i;s++){const i=Js[s],o=i.iconPosition.distanceToSquared(t);o>e||(e=o,l=i)}}else 1===Js.length?(l=Js[0],this.prevContainedPosition.copy(t),this.lastDateWithoutZone=s):0===Js.length&&n&&this.prevContainedPosition.distanceToSquared(t)<2?(l=this.currentEl,this.lastDateWithoutZone=0):l=0===Js.length&&this.currentEl&&!this.forceUpdate&&s-this.lastDateWithoutZone<20?this.currentEl:null;this.webgl.store.interactionVisibles.value||(l=null),this.muteDelay>0?this.muteDelay-=this.webgl.time.dt:(this.currentEl!==l&&(l&&l.onEnabled(),this.currentEl&&this.currentEl.onDisabled(),this.webgl.store.interactionButton.set(l&&l.buttonState)),Js.length=0,this.currentEl=l,this.forceUpdate=!1)}beforeDestroy(){this.webgl.store.interactionButton.set(null),this.webgl.store.interactionVisibles.unwatch(this.updateForce,this)}}new g(1,2);const ti=()=>{},si=new n;new y({side:b});class ii extends u{initInteractiveZonesController(){this.scene.interactiveZones||(this.scene.interactiveZones=this.scene.add(ei))}init(){this.initInteractiveZonesController(),this.isMoving=this.props.isMoving,this.useCollapsedQuestMark=this.props.useCollapsedQuestMark;const e=this.props.icon||"bubble_talk",t="bubble_quest"===e?"bubble_collapsed_alt":"bubble_collapsed";this.audioEnabled=this.props.audioEnabled||"sfx_UI_notif_quest_object",this.icons={normal:e,locked:this.props.iconLocked||"bubble_lock",collapsed:this.props.iconCollapsed||t},this.props.locked&&(this.iconID=this.iconLockedID),this.timeOffset=this.props.timeOffset||0,this.progress=0,this.buttonState={speed:this.props.buttonSpeed||1,icon:this.props.buttonIcon||"interactions-yes",mode:this.props.buttonMode||"click",onStart:this.props.onStart||ti,onProgress:e=>{this.progress=e,this.props.onProgress&&this.props.onProgress(e)},onStop:this.props.onStop||ti,locked:this.props.locked,onDone:this.bind("onDone",1)},"tap"===this.buttonState.mode&&(this.buttonState.onTap=()=>{this.scene.playerCam.shake(350,.035,!0,!0),this.props.onTap&&this.props.onTap()}),this.matrix=this.props.matrix||this.parent.props.transformMatrix,this.target=this.props.target||new n,this.iconPosition=this.props.iconPosition||new n,this.previousPosition=new n,this.boundingSphere=null,this.spheres=[],this.matrix&&this.previousPosition.applyMatrix4(this.matrix),this.matrix&&this.iconPosition.applyMatrix4(this.matrix);const s=this.props.zones||[];this.props.zone&&!s.length?s.push(this.props.zone):s.length||s.push({center:new n,radius:this.props.activationRadius||1});for(let o=0,a=s.length;o<a;o++){const e=s[o],t=new h(e.center,e.radius);this.spheres.push(t),this.matrix&&t.applyMatrix4(this.matrix),this.boundingSphere||(this.boundingSphere=t.clone()),this.boundingSphere.union(t)}const i=this.props.activationRadius;i&&this.boundingSphere.radius<i&&(this.boundingSphere.radius=i),this.ixItem=this.scene.interactiveZones.broadphase.add(this,{refreshDelay:(this.isMoving,200),position:this.boundingSphere.center,radius:this.boundingSphere.radius,debug:!1}),this.enabledScale=9.32,this.disabledScale=p.app.$device.type.mobile?8:6.8,this.sprite=new f({batcher:"depthSDF",sprite:"bubble_quest",scale:this.disabledScale,angle:0,billboard:!0,position:this.iconPosition,sortable:!0}),this.spring=m({initial:this.disabledScale}),this.visibilitySpring=m({initial:1}),this.enabled=!0,this.onDisabled(),this.spring.setValue(.001),this.done=!1}get icon(){return this.icons.normal}set icon(e){e!==this.icons.normal&&(this.icons.normal=e,this.enabled&&this.refreshIcon())}get iconCollapsed(){return this.icons.collapsed}set iconCollapsed(e){e!==this.icons.collapsed&&(this.icons.collapsed=e,this.enabled||this.refreshIcon())}get iconLocked(){return this.icons.locked}set iconLocked(e){e!==this.icons.locked&&(this.icons.locked=e,this.locked&&this.refreshIcon())}get locked(){return this.buttonState.locked}set locked(e){if(e===this.buttonState.locked)return;this.buttonState.locked=e;const t=this.webgl.store.interactionButton;this.refreshIcon(),t.value===this.buttonState&&this.webgl.store.interactionButton.set(this.buttonState,!0)}refreshIcon(){if(this.destroyed)return;if(!this.sprite.sprite)return;const e=this.locked,t=!this.enabled,s=this.sprite.sprite;let i=this.icons.normal;if(e&&t?i="bubble_collapsed_locked":e?i=this.icons.locked:t&&(i=this.icons.collapsed),i===s)return;this.sprite.sprite.change({id:i});const o=t?this.disabledScale:this.enabledScale;this.spring.setTarget(o),this.spring.setValue(.001)}onDone(){this.done=!0,this.props.onDone&&this.props.onDone(),this.spring.setTarget(.001),this.scene.interactiveZones.muteDelay=800}onDisabled(){this.done||this.destroyed||this.sprite.sprite&&this.enabled&&(this.enabled=!1,this.refreshIcon(),this.spring.setValue(1.75*this.disabledScale))}onEnabled(){if(this.done)return;if(this.enabled)return;this.enabled=!0,this.refreshIcon();const e=this.webgl.audio;this.locked?e.playSound("sfx_quest_locked"):this.sprite&&"bubble_talked"===this.sprite.sprite.id?e.playSound("sfx_UI_dialog_next",{volume:.8}):e.playSound(this.audioEnabled),this.spring.setValue(.25*this.enabledScale)}beforeUpdate(){this.enabled&&"interactions-chat"===this.buttonState.icon&&"click"===this.buttonState.mode&&this.scene.raycastableBubble.use(this.iconPosition,this.buttonState.onDone)}update(){const e=this.scene.getCurrentCamera().cam;this.sprite.visible=function(e,t,s=0){return Ks.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),Xs.setFromProjectionMatrix(Ks),s&&($s.center.copy(t),$s.radius=s),s?Xs.intersectsSphere($s):Xs.containsPoint(t)}(e,this.sprite.position,1.5),this.sprite.visible&&(this.spring.update(this.webgl.time.dt),this.visibilitySpring.update(this.webgl.time.dt),this.sprite.scale.x=this.sprite.scale.y=Math.max(0,this.spring.value*this.visibilitySpring.value),this.sprite.angle=this.done?.4*this.spring.velocity:.7*this.spring.velocity,this.done&&this.spring.value<=.005?this.destroy():this.enabled||(this.sprite.position.y=this.iconPosition.y+.05*Math.sin(.01*this.webgl.time.elapsed+this.timeOffset)))}show(){const e=this.visibilitySpring;this.isHidden=!1,e.setTarget(1),e.setTension(.1),e.setFriction(.2),e.setMass(1)}hide(){const e=this.visibilitySpring;e.setTarget(0),e.setTension(.1),e.setFriction(.4),e.setMass(.7),this.isHidden=!0}updateOpacity(e){this.sprite.alpha=e}updatePosition(e){const t=si.subVectors(e,this.previousPosition);this.previousPosition.copy(e),this.boundingSphere.translate(t),this.ixItem.update();for(let s=0,i=this.spheres.length;s<i;s++)this.spheres[s].translate(t);this.iconPosition.add(t),this.sprite.position.copy(this.iconPosition)}beforeDestroy(){this.sprite.destroy(),this.ixItem.destroy(),super.beforeDestroy&&super.beforeDestroy()}}const oi=()=>{},ai=new n,ni=new n;class ri extends t{created(){this.extendProto("setupInteraction",li),this.extendProto("removeInteraction",ci)}destroyed(){const e=this.base;e.unwatchLockCondition&&e.unwatchLockCondition(),e.removeInteraction&&e.removeInteraction()}}function li(e={}){this.removeInteraction();let t=!1;if(e.item){const s=p.app.$quests.getFromItem(e.item);if(s&&s.item){const i=s.item;e.unlockedWhen||(e.unlockedWhen=i.variable),e.buttonIcon||(e.buttonIcon="interactions-"+i.image),e.iconLocked||(e.iconLocked="bubble_"+i.image),e.icon||(e.icon="bubble_quest"),t=!0}}let s,i,o=!1,a=!1;if(e.unlockedWhen){const t=e.unlockedWhen;a=!this.webgl.savestate.getVariable(t),a&&(this.unwatchLockCondition=v((()=>this.webgl.savestate.game.vars[t]),(e=>{e&&this.interactionZone&&(this.unwatchLockCondition&&this.unwatchLockCondition(),this.interactionZone.locked=!1,this.unwatchLockCondition=null)})))}this.isBigInteraction="tap"===e.buttonMode||"hold"===e.buttonMode||"hold-infinite"===e.buttonMode,this.useCamera=this.isBigInteraction&&(e.cameraHeight||e.cameraTarget||e.cameraDistance);let r,l=null==e.skipCamAfterDone||e.skipCamAfterDone;if(this.useCamera){const t=e.cameraHeight||1,o=e.cameraDistance||1;r=e.cameraTarget||new n(0,1,0),r.applyMatrix4(this.props.transformMatrix);let a=!1;s=()=>{if(a)return;a=!0;const s=r,i=this.scene.playerCam,n=i.basePosition||i.base.position,l=ni.copy(n).sub(ai.setScalar(0).applyMatrix4(this.props.transformMatrix)).normalize();ai.x=n.x+l.x*o,ai.z=n.z+l.z*o,ai.y=n.y+t,i.setTarget({id:this.uid,lockPlayer:!0,position:ai,lookAt:s,posEase:e.posEase||.09,lookAtEase:e.lookAtEase||.1,isAction:!0})},i=()=>{if(!a)return;a=!1;this.scene.playerCam.removeTarget({id:this.uid,posEase:e.posEase||.09,lookAtEase:e.lookAtEase||.1})}}const c=e.playerActionPreset||"Default",h=e.onStart,u=e.onProgress,d=e.onStop,f=e.onAnimStart,m=e.onAnimStop,g=e.onDone?()=>e.onDone():this.startPropsTransition?this.startPropsTransition:this.onInteractionDone||oi;let y,b=!1,_=0,x=0;const S=this.webgl.audio.list[e.sound],M=S&&S.id,T=S&&S.loop,O=M&&!T?()=>{if(!this.interactionZone)return;const e=w(this.interactionZone.progress,0,1,.98,1.02);M&&!T&&this.webgl.audio.playSound(M,{playbackRate:e})}:void 0,P=()=>{b||(b=!0,this.interactionZone&&this.interactionZone.hide(),this.scene.player.actionStart(c),T&&!y&&(y=this.webgl.audio.playSound(M)),this.useCamera&&s(),f&&f())},A=e=>{if(y&&(y.stop(),y=null),!b)return;b=!1,!o&&this.interactionZone&&this.interactionZone.show(),this.scene.player.actionDone();const t=e||!o||!l;this.useCamera&&t&&i(),m&&m(e)};this.cancelAnim=()=>A(!0);this.interactionZone=this.add(ii,{isMoving:this.isMoving,debug:e.debug,icon:e.icon,iconLocked:e.iconLocked,iconCollapsed:e.iconCollapsed,iconPosition:e.iconPosition||new n,audioEnabled:e.audioEnabled,zone:e.zone||{center:new n(0,0,0),radius:6},zones:e.zones,matrix:e.matrix,locked:a||e.locked,buttonIcon:e.buttonIcon||"interactions-yes",buttonMode:e.buttonMode||"click",buttonSpeed:e.buttonSpeed||1,onTap:O,onStart:()=>{h&&h()},onProgress:e=>{if(u&&u(e),!o){if(e>.01&&e>_?(x=e,P()):x-e>.11&&A(),b){const e=this.scene.player;if(e.rotateAt){const t=this.interactionZone,s=r||t&&t.iconPosition;s&&e.rotateAt(s)}}_=e}},onStop:()=>{A(),d&&d()},onDone:()=>{o=!0,A(),this.webgl.store.debounceInteractionDone.emit(),g&&g()},timeOffset:this.seed?this.seed/100:3*Math.random()}),t&&this.setupMainQuestExclamation(e.item)}function ci(){this.cancelAnim&&this.cancelAnim(!0),this.interactionZone&&(this.interactionZone.destroy(),this.interactionZone=null)}new r;const hi={},ui={},di=()=>{},pi={update(){},value:1,stopped:!0};hi.Toggle=function(){this.propsTransitionOpts.ogOnStart&&this.propsTransitionOpts.ogOnStart()},ui.Toggle={Update:function(){this.endPropsTransition&&this.endPropsTransition()}},hi.Bounce=function(){const e=this.transitionMesh;if(!e)return;const t=this.propsTransitionOpts.presetOpts,s=(null==t?void 0:t.cameraShake)??!0;this.propsTransitionOpts.ogOnStart&&this.propsTransitionOpts.ogOnStart(),s&&this.scene.playerCam.shake(740,.1,!1,!0,.75),this.tDelayAfter=t&&t.delayAfter||0,_.use({biome:this.scene.biome}).pauseEffects(this.uid),e.origScale=e.scale.clone(),e.origRotation=e.rotation.clone();const i=this.springY=m();if(i.setValue(.2),i.setTarget(1),t&&t.bounceHorizontal){const e=this.springX=m({friction:.14,tension:.12});e.setValue(t.bounceHorizontal),e.setTarget(1)}else this.springX=pi},ui.Bounce={Update:function(){const e=this.transitionMesh;if(!e)return;const t=this.propsTransitionOpts.presetOpts,s=this.webgl.time.dt;this.springY.update(s),this.springX.update(s),e.scale.set(e.origScale.x*this.springX.value,e.origScale.y*this.springY.value,e.origScale.z*this.springX.value),t&&(t.rotateX&&(e.rotation.x=e.origRotation.x+this.springY.velocity*t.rotateX),t.rotateZ&&(e.rotation.z=e.origRotation.z+this.springY.velocity*t.rotateZ),t.rotateY&&(e.rotation.y=e.origRotation.y+this.springY.velocity*t.rotateY)),this.springY.stopped&&this.springX.stopped&&(this.tDelayAfter-=s,this.tDelayAfter<=0&&this.endPropsTransition())}};const fi=new Set(["scale","scaleY","positionY"]);hi.Tween=function(){const e=this.transitionMesh;if(!e)return;const t=this.propsTransitionOpts.presetOpts;this.propsTransitionOpts.ogOnStart&&this.propsTransitionOpts.ogOnStart(),this.scene.playerCam.shake(1400,.11,!0,!0,1),_.use({biome:this.scene.biome}).pauseEffects(this.uid),e.origScale=e.scale.clone(),e.origPosition=e.position.clone(),e.origRotation=e.rotation.clone(),this.tTweens=[],this.tTweensValues={},this.tDelayAfter=t.delayAfter||0;for(let s in t){if(!fi.has(s))continue;const i=t[s];let o=di;"scale"===s?o=(t,s)=>{e.scale.copy(e.origScale).multiplyScalar(s)}:"scaleY"===s?o=(t,s)=>{e.scale.copy(e.origScale),e.scale.y*=s}:"positionY"===s&&(o=(t,s)=>{e.position.copy(e.origPosition),e.position.y+=s}),this.tTweensValues[s]=null!=i.from?i.from:0,this.tTweens.push(x({target:this.tTweensValues,property:s,duration:i.duration||1e3,easing:i.easing||"outSwift",from:this.tTweensValues[s],to:null!=i.to?i.to:1,onProgress:o}))}},ui.Tween={Update:function(){const e=this.transitionMesh;if(!e)return;const t=this.webgl.time.dt;let s=!0;for(let i=0,o=this.tTweens.length;i<o;i++){const e=this.tTweens[i];e.ended||e.destroyed||(s=!1,e.update(t))}s&&(e.visible=!1,this.tDelayAfter-=t,this.tDelayAfter<=0&&this.endPropsTransition())}};const mi={starts:hi,updateStates:ui},gi=()=>{};class yi extends t{created(){const e=this.base,t=this;this.setup=this.base.setupPropsTransition=(t={})=>{e.propsTransitionOpts=t;const s=t.preset;t.ogOnStart=t.onStart;let i=t.onStart||gi;mi.starts[s]&&(i=mi.starts[s].bind(e)),t.onStart=i;let o=t.updateStates||null;if(!t.updateStates&&mi.updateStates[s]){o={};const t=mi.updateStates[s];for(let s in t)o[s]=t[s].bind(e)}if(!t.stateBefore&&t.stateAfter){const s=t.stateBefore={};for(let t in e.dynamicProps)s[t]=!1}this.transitionState=e.propsTransitionState=new S({states:o}),bi.call(e)},this.start=this.base.startPropsTransition=()=>{const s=e.propsTransitionOpts,i=e.propsTransitionState;t.update=i.update.bind(i),e.webgl.store.debounceInteractionDone.emit(2e3),e.transitionMesh&&e.scene.addObject3D(e.transitionMesh),s.stateBefore&&e.updateDynamicProps(s.stateBefore),s.onStart&&s.onStart()},this.end=this.base.endPropsTransition=()=>{const s=e.propsTransitionOpts;if(this.transitionMesh&&this.transitionMesh.material.resumeEffects(e.uid),!s.disableCamTargetRemoval){e.scene.playerCam.removeTarget({id:this.uid})}s.stateAfter&&e.updateDynamicProps(s.stateAfter),vi.call(e),t.destroy(),e.webgl.store.debounceInteractionDone.emit(),s.onDone&&s.onDone.call(e)}}update(){}destroyed(){const e=this.base;this.transitionState&&(this.update=null,this.transitionState.destroy()),e.propsTransitionState===this.transitionState&&(e.propsTransitionState=null),e.startPropsTransition===this.start&&(e.startPropsTransition=null),e.endPropsTransition===this.end&&(e.endPropsTransition=null),e.setupPropsTransition===this.setup&&(e.setupPropsTransition=null),this.transitionState=null,this.start=this.end=this.setup=null,this.transitionMesh&&this.transitionMesh.material.resumeEffects(e.uid),vi.call(e)}}function bi(){const e=this.propsTransitionOpts,t=this.webgl.resources.assets[e.transitionAsset];if(!t)return;const s=M.use(t.geometry),i=_.use({biome:this.scene.biome});this.transitionMesh=new T(s,i),this.transitionMesh.applyMatrix4(this.props.transformMatrix),this.transitionMesh.frustumCulled=!1,this.transitionMesh.castShadow=this.webgl.store.chunksCastShadow.value,this.transitionMesh.receiveShadow=!0;const o=this.scene;o.transitionMeshes.push(this.transitionMesh),this.autoUnwatch(o.hooks.beforePrerender.watchOnce((()=>{o.addObject3D(this.transitionMesh)}))),this.autoUnwatch(o.hooks.afterPrerender.watchOnce((()=>{o.removeObject3D(this.transitionMesh)})))}function vi(){this.transitionMesh&&this.scene&&(this.scene.removeObject3D(this.transitionMesh),this.transitionMesh=null)}class wi extends u{init(){this.list=[],this.npcCount=0}addNPC(e){e.npcIndex=this.npcCount++,this.list.push(e)}removeNPC(e){let t=-1;for(let s=0,i=this.list.length;s<i;s++){const i=this.list[s];t>-1?i.npcIndex-=1:e===i&&(t=s)}t>-1&&this.list.splice(t,1)}beforeDestroy(){this.list.length=0,this.npcCount=0}update(){for(let e=0,t=this.list.length;e<t;e++){this.list[e].updateVisibility()}}}const _i={computeTangents:function(e){const t=e.index,s=e.attributes;if(null===t||void 0===s.position||void 0===s.normal||void 0===s.uv)return;const i=t.array,o=s.position.array,a=s.normal.array,l=s.uv.array,c=o.length/3;void 0===s.tangent&&e.setAttribute("tangent",new O(new Float32Array(4*c),4));const h=s.tangent.array,u=[],d=[];for(var p=0;p<c;p++)u[p]=new n,d[p]=new n;const f=new n,m=new n,g=new n,y=new r,b=new r,v=new r,w=new n,_=new n;function x(e,t,s){f.fromArray(o,3*e),m.fromArray(o,3*t),g.fromArray(o,3*s),y.fromArray(l,2*e),b.fromArray(l,2*t),v.fromArray(l,2*s),m.sub(f),g.sub(f),b.sub(y),v.sub(y);const i=1/(b.x*v.y-v.x*b.y);isFinite(i)&&(w.copy(m).multiplyScalar(v.y).addScaledVector(g,-b.y).multiplyScalar(i),_.copy(g).multiplyScalar(b.x).addScaledVector(m,-v.x).multiplyScalar(i),u[e].add(w),u[t].add(w),u[s].add(w),d[e].add(_),d[t].add(_),d[s].add(_))}let S=e.groups;0===S.length&&(S=[{start:0,count:i.length}]);p=0;for(var M=S.length;p<M;++p)for(var T=U=(F=S[p]).start,P=U+F.count;T<P;T+=3)x(i[T+0],i[T+1],i[T+2]);const A=new n,I=new n,C=new n,R=new n;let k,D,L;function E(e){C.fromArray(a,3*e),R.copy(C),D=u[e],A.copy(D),A.sub(C.multiplyScalar(C.dot(D))).normalize(),I.crossVectors(R,D),L=I.dot(d[e]),k=L<0?-1:1,h[4*e]=A.x,h[4*e+1]=A.y,h[4*e+2]=A.z,h[4*e+3]=k}for(p=0,M=S.length;p<M;++p){var F,U;for(T=U=(F=S[p]).start,P=U+F.count;T<P;T+=3)E(i[T+0]),E(i[T+1]),E(i[T+2])}},mergeBufferGeometries:function(e,t){const s=null!==e[0].index,i=new Set(Object.keys(e[0].attributes)),o=new Set(Object.keys(e[0].morphAttributes)),a={},n={},r=e[0].morphTargetsRelative,l=new P;let c=0;for(var h=0;h<e.length;++h){const p=e[h];let f=0;if(s!==(null!==p.index))return null;for(var u in p.attributes){if(!i.has(u))return null;void 0===a[u]&&(a[u]=[]),a[u].push(p.attributes[u]),f++}if(f!==i.size)return null;if(r!==p.morphTargetsRelative)return null;for(var u in p.morphAttributes){if(!o.has(u))return null;void 0===n[u]&&(n[u]=[]),n[u].push(p.morphAttributes[u])}if(l.userData.mergedUserData=l.userData.mergedUserData||[],l.userData.mergedUserData.push(p.userData),t){var d;if(s)d=p.index.count;else{if(void 0===p.attributes.position)return null;d=p.attributes.position.count}l.addGroup(c,d,h),c+=d}}if(s){let t=0;const s=[];for(h=0;h<e.length;++h){const i=e[h].index;for(var p=0;p<i.count;++p)s.push(i.getX(p)+t);t+=e[h].attributes.position.count}l.setIndex(s)}for(var u in a){const e=this.mergeBufferAttributes(a[u]);if(!e)return null;l.setAttribute(u,e)}for(var u in n){const e=n[u][0].length;if(0===e)break;l.morphAttributes=l.morphAttributes||{},l.morphAttributes[u]=[];for(h=0;h<e;++h){const e=[];for(p=0;p<n[u].length;++p)e.push(n[u][p][h]);const t=this.mergeBufferAttributes(e);if(!t)return null;l.morphAttributes[u].push(t)}}return l},mergeBufferAttributes:function(e){let t,s,i,o=0;for(var a=0;a<e.length;++a){const n=e[a];if(n.isInterleavedBufferAttribute)return null;if(void 0===t&&(t=n.array.constructor),t!==n.array.constructor)return null;if(void 0===s&&(s=n.itemSize),s!==n.itemSize)return null;if(void 0===i&&(i=n.normalized),i!==n.normalized)return null;o+=n.array.length}const n=new t(o);let r=0;for(a=0;a<e.length;++a)n.set(e[a].array,r),r+=e[a].array.length;return new O(n,s,i)},interleaveAttributes:function(e){let t,s=0,i=0;for(var o=0,a=e.length;o<a;++o){var n=e[o];if(void 0===t&&(t=n.array.constructor),t!==n.array.constructor)return null;s+=n.array.length,i+=n.itemSize}const r=new A(new t(s),i);let l=0;const c=[],h=["getX","getY","getZ","getW"],u=["setX","setY","setZ","setW"];var d=0;for(a=e.length;d<a;d++){const t=(n=e[d]).itemSize,s=n.count,i=new I(r,t,l,n.normalized);c.push(i),l+=t;for(let e=0;e<s;e++)for(let s=0;s<t;s++)i[u[s]](e,n[h[s]](e))}return c},estimateBytesUsed:function(e){let t=0;for(const i in e.attributes){const s=e.getAttribute(i);t+=s.count*s.itemSize*s.array.BYTES_PER_ELEMENT}const s=e.getIndex();return t+=s?s.count*s.itemSize*s.array.BYTES_PER_ELEMENT:0,t},mergeVertices:function(e,t=1e-4){t=Math.max(t,Number.EPSILON);const s={},i=e.getIndex(),o=e.getAttribute("position"),a=i?i.count:o.count;let n=0;const r=Object.keys(e.attributes),l={},c={},h=[],u=["getX","getY","getZ","getW"];for(var d=0,p=r.length;d<p;d++){l[y=r[d]]=[],(_=e.morphAttributes[y])&&(c[y]=new Array(_.length).fill().map((()=>[])))}const f=Math.log10(1/t),m=Math.pow(10,f);for(d=0;d<a;d++){const t=i?i.getX(d):d;let o="";var g=0;for(p=r.length;g<p;g++)for(var y=r[g],b=(w=e.getAttribute(y)).itemSize,v=0;v<b;v++)o+=~~(w[u[v]](t)*m)+",";if(o in s)h.push(s[o]);else{for(g=0,p=r.length;g<p;g++){y=r[g];var w=e.getAttribute(y),_=e.morphAttributes[y];b=w.itemSize;const s=l[y],i=c[y];for(v=0;v<b;v++){const e=u[v];if(s.push(w[e](t)),_)for(let s=0,o=_.length;s<o;s++)i[s].push(_[s][e](t))}}s[o]=n,h.push(n),n++}}const x=e.clone();for(d=0,p=r.length;d<p;d++){y=r[d];const t=e.getAttribute(y);var S=new t.array.constructor(l[y]);w=new O(S,t.itemSize,t.normalized);if(x.setAttribute(y,w),y in c)for(g=0;g<c[y].length;g++){const t=e.morphAttributes[y][g];S=new t.array.constructor(c[y][g]);const s=new O(S,t.itemSize,t.normalized);x.morphAttributes[y][g]=s}}return x.setIndex(h),x},toTrianglesDrawMode:function(e,t){if(t===C)return e;if(t===R||t===k){let i=e.getIndex();if(null===i){const t=[],o=e.getAttribute("position");if(void 0===o)return e;for(var s=0;s<o.count;s++)t.push(s);e.setIndex(t),i=e.getIndex()}const o=i.count-2,a=[];if(t===R)for(s=1;s<=o;s++)a.push(i.getX(0)),a.push(i.getX(s)),a.push(i.getX(s+1));else for(s=0;s<o;s++)s%2==0?(a.push(i.getX(s)),a.push(i.getX(s+1)),a.push(i.getX(s+2))):(a.push(i.getX(s+2)),a.push(i.getX(s+1)),a.push(i.getX(s)));a.length;const n=e.clone();return n.setIndex(a),n.clearGroups(),n}return e}},xi={"T-Pose":[0,1],Walk:[3,27],Run:[33,57],Idle:[63,104],Sick:[259,434],Healed:[440,473],Idle2:[111,152],Idle3:[156,255],Jetpack:[482,511],Victory:[514,546],Gain:[552,584],Action:[591,642],Happy:[648,688],Sad:[694,735],Thinking:[742,782],Eloquant:[788,829],Fear:[836,876],Hello:[882,939],Dancing:[947,979],Seating:[984,1025],Towel:[1031,1072],Swimming:[1079,1107],JetpackAction:[1113,1142],Sport:[1149,1219],ZiplineJump:[1223,1262],ZiplineIdle:[1263,1322],ZiplineFall:[1323,1355]},Si=new l,Mi=new l,Ti=new n;new L;const Oi=new H;class Pi extends t{created(){const e=this.base,t=e.isNPC?e.uid:"Player";if(e.seed=D(t),e.isNPC){const t=e.scene;t.npcs||(t.npcs=t.add(wi)),e.npcController=t.npcs,e.npcController.addNPC(e)}this.timeToNextBlink=1200*Math.random()+800,this.timeToBlinkOeilD=0,this.timeToBlinkOeilR=0,this.isBlinking=!1,e.shoesOffset=0,this.options.extendProto?(this.extendProto("setOutfit",Di),this.extendProto("setAttributes",Li),this.extendProto("setGeometries",Ri)):(e.setOutfit=i(Di,e,2),e.setAttributes=i(Li,e,1),e.setGeometries=i(Ri,e,1),e.playEmote=i(Ii,e,2)),e.isPlayer&&(p.store.updatePlayerOutfit.watch(this.base.setOutfit,this),p.store.updatePlayerAttributes.watch(this.base.setAttributes,this)),Ri.call(e),Di.call(e),e.baseBoundingSphere=new h(new n(0,65,0),180),e.boundingSphere=e.baseBoundingSphere.clone(),e.base.updateMatrixWorld(),e.boundingSphere.applyMatrix4(e.base.matrixWorld),e.updateVisibility=Ci.bind(e)}async blink(){this.isBlinking=!0,await this.base.wait(100),this.isBlinking=!1,this.timeToNextBlink=1300*Math.random()+1e3,this.timeToBlinkOeilD=0}update(){if((this.base.isPlayerReady||!this.base.isPlayer)&&(!this.base.isNPC||this.base.shouldUpdateSkeleton())&&this.base.oeild&&this.base.charMesh){let e=this.base.oeild.position.x/100,t=this.base.oeilr.position.x/100,s=this.base.bouche.position.x/100;e=Math.round(e),t=Math.round(t),s=Math.round(s),0!==e||0!==t||this.isBlinking||(this.timeToBlinkOeilD+=this.base.webgl.time.stableDt),0===e&&0===t||(this.timeToBlinkOeilD=0),this.timeToBlinkOeilD>this.timeToNextBlink&&!this.isBlinking&&this.blink(),e=this.isBlinking?1:e,t=this.isBlinking?1:t,null!=this.base.overrideMouth&&(s=this.base.overrideMouth),this.base.charMesh.faceData.set(e,t,s,this.base.charMesh.faceType)}}destroyed(){const e=this.base;if(e.isNPC){const t=e.npcController;t&&t.removeNPC(e),e.npcController=null}e.charMesh.geometry.dispose(),e.charMesh.skeleton.dispose(),p.store.updatePlayerOutfit.unwatch(this.base.setOutfit,this),p.store.updatePlayerAttributes.unwatch(this.base.setAttributes,this)}}const Ai={Hello:!0,Victory:!0,Gain:!0,ZiplineJump:!0,ZiplineFall:!0};function Ii(e,t){"Neutral"===e?this.setIdleAnimation():xi[e]?this.setAnimation(e,{duration:t,loop:Ai[e]?E:F}):this.setIdleAnimation()}function Ci(){const e=this,t=e.charMesh,s=e.scene.getCurrentCamera().cam,i=e.base.position.distanceToSquared(s.position),o=e.scene.frustum;this.isMoving&&this.speed>.004&&this.base.updateWorldMatrix(!1,!1),e.boundingSphere.copy(e.baseBoundingSphere),e.boundingSphere.applyMatrix4(e.base.matrixWorld);const a=this.webgl.store.npcMinDistance.value,n=this.webgl.store.npcMaxDistance.value;t.opacity=U(1-z(i,a,n),0,1),t.opacity<.001?t.visible=!1:t.visible=!0,t.visible&&(t.visible=o.intersectsSphere(e.boundingSphere)),e.interactionZone&&e.interactionZone.updateOpacity(t.opacity),this.webgl.state.prerendering&&(t.visible=!0)}function Ri(){if(this.outfit={top:0,middle:0,bottom:0},this.armature=B(this.webgl.character.armature),this.base=this.armature,this.material=N.use({biome:this.scene.biome}),this.charMesh=this.mesh=this.armature.children[1],this.charMesh.renderOrder=this.webgl.store.renderOrder.character,this.mesh.opacity=1,this.charMesh.rotation.x=this.base.rotation.x,this.base.rotation.x=0,this.charMesh.faceData=new j,this.mesh.material=this.material,this.mesh.castShadow=this.webgl.store.dynamicShadowSize.value>64,this.mesh.receiveShadow=!0,this.mesh.frustumCulled=!1,this.mesh.colorId=Math.floor(32*Math.random()),this.mesh.faceType=0,this.mesh.faceColor=new V(16761133),this.skeleton=this.mesh.skeleton,this.skeleton.update=ki.bind(this.skeleton),this.skeleton.base=this,this.mesh.add(this.skeleton.bones[0]),this.oeild=this.addObject3D(this.webgl.character.oeild.clone()),this.oeilr=this.addObject3D(this.webgl.character.oeilr.clone()),this.bouche=this.addObject3D(this.webgl.character.bouche.clone()),Promise.resolve().then((()=>{this.destroyed||(this.oeild.removeFromParent(),this.oeilr.removeFromParent(),this.bouche.removeFromParent())})),!this.isNPC)for(let e=0;e<this.mesh.skeleton.bones.length;e++){const t=this.mesh.skeleton.bones[e];if("Chara_Low_RigGameSkeletonToes_R"==t.name||"Chara_Low_RigGameSkeletonToes_L"==t.name){this.mesh[t.name]=t;const e=new L;e.position.y-=30,this.mesh[t.name].add(e)}}this.mesh.scale.multiplyScalar(this.webgl.store.characterScale),this.props.transformMatrix&&(this.base.applyMatrix4(this.props.transformMatrix),this.keepUpright&&(this.base.updateMatrixWorld(),this.base.localToWorld(Ti.set(0,0,1)),Ti.y=this.base.position.y,this.base.quaternion.copy(Oi),this.base.lookAt(Ti),this.base.updateMatrixWorld()))}function ki(){if(this.base.isNPC){if(!this.base.charMesh)return;if(!this.base.shouldUpdateSkeleton())return}this.base.isNPC&&this.base.base.updateMatrixWorld(!0);const e=this.bones,t=this.boneInverses,s=this.boneMatrices,i=this.boneTexture;for(let o=0,a=e.length;o<a;o++){const i=e[o]?e[o].matrixWorld:Mi;Si.multiplyMatrices(i,t[o]),Si.toArray(s,16*o)}null!==i&&(i.needsUpdate=!0)}function Di(e,t){const{main:s,heads:i,bodies:o,bottoms:a}=p.character,n=p.app.$characters.faceColors[this.scene.biome.id];if(this.mesh.geometry&&this.mesh.geometry.dispose(),!t)if(this.isNPC){const e=this.props.npcConfig,t=e.gradientID,s=e.face,i=n[t],o=e.head,a=e.body,r=e.bottom;this.outfit.head=o,this.outfit.body=a,this.outfit.bottom=r,this.mesh.colorId=t,this.mesh.faceColor.set(i),this.mesh.visible=!0,this.mesh.faceType=s}else if(this.isPlayer){const e=this.webgl.savestate.game.player,t=this.webgl.app.$characters.colors,s=(t[e.color]||t.character0).gradientID,i=n[s],o=e.face,a=e.head,r=e.body,l=e.bottom;this.outfit.head=a,this.outfit.body=r,this.outfit.bottom=l,this.mesh.colorId=s,this.mesh.faceColor.set(i),this.mesh.visible=!0,this.mesh.faceType=o,this.onOutfitChanged&&this.onOutfitChanged()}const{head:r,body:l,bottom:c}=this.outfit,h=i[r],u=o[l],d=a[c];this.material.needsUpdate=!0;const f=[s];h&&f.push(h),u&&f.push(u),d&&f.push(d);const m=p.app.$items.bottom[c];this.shoesOffset=m&&m.shoesOffset||0,this.mesh.geometry=_i.mergeBufferGeometries(f)}function Li(){const e=p.savestate.game.player,t=p.app.$characters.colors,s=p.app.$characters.faceColors[this.scene.biome.id],i=(t[e.color]||t.character0).gradientID,o=s[i],a=e.face;this.mesh.colorId=i,this.mesh.faceColor.set(o),this.mesh.visible=!0,this.mesh.faceType=a,this.onOutfitChanged&&this.onOutfitChanged()}async function Ei(e){if(!(e=(e=>{try{return new URL(e)}catch(t){return null}})(e)))return;if(!(e.host.includes("youtu.be")||e.host.includes("youtube.com")))return;const t=e.searchParams.get("v")||e.pathname.split("/").pop();t&&(await function(e){const t=p.app.$store;return t.currentFullscreenVideo=q({id:e}),new Promise((e=>{const s=v((()=>t.currentFullscreenVideo),(t=>{t||(s(),e())}))}))}(t),await W(500),await G())}const Fi=new n,Ui=new n,zi=new n,Bi=new Set(["onStart","onCancel","onExit","onDone"]);class Ni extends t{created(){const e=this.base;e.dialogMethods={},e.registerDialogMethod=(t,s,i)=>{e.dialogMethods[t]=s.bind(i||e)},e.registerDialogMethod("WAIT",Hi),e.registerDialogMethod("EMOTE",Vi),e.registerDialogMethod("TELEPORT",Wi),e.registerDialogMethod("OPENPHONE",ji),e.registerDialogMethod("VIDEO",Ei),e.startDialog=(t,s={})=>{const i={};i.onStart=t=>{Gi.call(e,t),s.onStart&&s.onStart(t)},i.onCancel=(t,i)=>{qi.call(e,t,i),s.onCancel&&s.onCancel(t,i)},i.onDone=(t,i)=>{Yi.call(e,t,i),s.onDone&&s.onDone(t,i)},i.onExit=(t,i)=>{Ki.call(e,t,i),s.onExit&&s.onExit(t,i)};for(let e in s)Bi.has(e)||(i[e]=s[e]);p.app.$dialogs.startDialog(e,t,i)}}}async function ji(){p.app.$dialogs.exitDialog(!0),p.app.$webgl.store.frozenPlayerDelay=450,await Hi(400),p.app.$router.push({name:"Phone"}),p.app.$store.phone.tab.id="FintechDetails",p.app.$store.phone.tab.props={fintech:this.args.fintech,isFromDialog:!0}}function Vi(e){if(this.playEmote)return this.playEmote(e)}function Hi(e){return W(e)}function Wi(e,t="Spawn"){"_GoBack_"===e?p.scenes.backToIsland({delay:400}):p.scenes.teleportTo(e,{point:t,delay:400})}function Gi(e){this.onDialogStart&&this.onDialogStart(e);const t=this.scene.player.base.position,s=this.scene.playerCam,i=this.webgl.viewport.ratio.value,o=U(z(i,.45,1.5),0,1),a=Y(3.1,3.9,o),n=Fi.copy(t).sub(this.base.position).normalize();n.x*=a,n.y=2.15,n.z*=a;const r=Ui.copy(this.base.position).add(n),l=zi.copy(this.base.position);l.y+=Y(1.62,1.6,o),p.store.inDialog.set(this.uid),this.isTalking=!0,this.webgl.audio.playSound("sfx_UI_Dialog_CameraMove_In"),s.setTarget({id:this.uid,lockPlayer:!0,position:r,lookAt:l,posEase:.2,lookAtEase:.2})}function qi(e,t){this.onDialogCancel&&this.onDialogCancel(e,t)}function Yi(e,t){this.onDialogDone&&this.onDialogDone(e,t)}function Ki(e,t){this.onDialogExit&&this.onDialogExit(e,t),this.scene.player.base.visible=!0,this.isTalking=!1,p.store.inDialog.value===this.uid&&p.store.inDialog.set(!1);const s=this.scene.playerCam;this.webgl.audio.playSound("sfx_UI_Dialog_CameraMove_Out"),s.removeTarget({id:this.uid,posEase:.08,lookAtEase:.1})}let Xi=null,$i=["Idle","Idle2","Idle3"],Zi=["Idle","Idle3"];const Ji=.095,Qi=.9888;class eo extends t{created(){Xi||(Xi=s());const e=this.base;e.timers=[],this.options.extendProto?(this.extendProto("fadeIn",lo),this.extendProto("fadeOut",co),this.extendProto("crossFadeTo",no),this.extendProto("setIdleAnimation",ro),this.extendProto("forceIdle",to),this.extendProto("onAnimationFinished",so),this.extendProto("setAnimation",oo),this.extendProto("setAnimationFromSpeed",ao)):(e.fadeIn=i(lo,e,3),e.fadeOut=i(co,e,3),e.crossFadeTo=i(no,e,5),e.setIdleAnimation=i(ro,e,5),e.forceIdle=i(to,e,5),e.setAnimation=i(oo,e,5),e.onAnimationFinished=i(so,e,5),e.setAnimationFromSpeed=i(ao,e,5)),io.call(e),ro.call(e),e.animationMixer.addEventListener("finished",e.onAnimationFinished),e.speed=0,e.easedSpeed=0,e.lastDirection=new n,e.easedDirectionDelta=new n,e.currentAnimation=null,e.timeout=0,e.lastAnimation=null,e.frames=0,e.lastPos=(new n).copy(e.base.position),e.lastPosNeedsUpdate=!0}update(){const e=this.base,t=Xi.time.dt;if(!e.isPlayerReady&&e.isPlayer)return;e.isPlayer&&e.lastPosNeedsUpdate&&(e.lastPos.copy(e.base.position),e.lastPosNeedsUpdate=!1);let s=0;if(e.isPlayer||e.isMoving){const t=e.base.position,i=e.lastPos,o=e.firstUpdates>0;s=e.speed=t.equals(i)?0:t.distanceTo(i),!o&&e.canRun||(s=Math.min(s,Ji)),e.easedSpeed=Y(e.easedSpeed,s,o?1:.1),i.copy(t)}if(e.isNPC&&!e.shouldUpdateSkeleton())return;e.isPlayer&&(e.moveAnims.Walk.timeScale=e.moveAnims.Run.timeScale=w(e.speed,Ji,.14,Qi,1.13712)),e.animationMixer.update(t/1e3);let i=null;const o=!!e.isPlayer&&(e.mainEffect.isFloating||!e.isOnFloorDebounced),a=e.canMove||e.isMoving;(e.isPlayer||e.isMoving)&&(e.timeout-=Xi.time.dt,e.timeout=U(e.timeout,0,300),i=a&&!o?e.setAnimationFromSpeed(s,e.easedSpeed):null);for(const d in e.animations){const s=e.animations[d];s&&s.weightTween&&s.weightTween.update(t);const o=i?0:1;s.scalarWeight=K(s.scalarWeight,o,o<.5?.08:.15,t,0);const a="JetpackAction"===d?1:1-e.jetpackAnim.weight;s.weight=s.currentWeight*s.scalarWeight*a}if(e.isPlayer||e.isMoving)for(const d in e.moveAnims){const s=e.moveAnims[d],a=d===i?1:0;s.scalarWeight=K(s.scalarWeight,a,.2,t,0);const n=o?0:1;s.weight=1*s.scalarWeight*n;s[e.moveAnims.Walk.weight<.01&&e.moveAnims.Run.weight<.01?"stop":"play"]()}const n=this.base.allAnims,r=this.base.allAnimsKeys;let l=n[r[0]];for(let d=0;d<r.length;d++){const e=n[r[d]];e.isMoveAnim||e.weight>l.weight&&(l=e)}const c=l["Chara_Low_RigOeilD_ref.position"],h=l["Chara_Low_RigOeilR_ref.position"],u=l["Chara_Low_RigBouche_Ref.position"];if(c)for(let d=0;d<c.times.length;d++){if(!(c.times[d]<l.time)){this.base.oeild.position.x=c.values[3*d],this.base.oeilr.position.x=h.values[3*d],this.base.bouche.position.x=u.values[3*d];break}}}destroyed(){for(const e in this.base.animations){const t=this.base.animations[e];t&&t.weightTween&&t.weightTween.destroy()}this.base.animationMixer.removeEventListener("finished",this.base.onAnimationFinished)}}function to(e){this.forcedIdle=e,this.setIdleAnimation()}function so(e){const t=e.action;t.onComplete&&t.onComplete(),t.onComplete=null,setTimeout((()=>{if(this.destroyed)return;const e=t===this.animation,s=t.loop===E;e&&s&&this.setIdleAnimation()}),100)}function io(){this.animationMixer=new X(this.base),this.animations={},this.moveAnims={},this.allAnims={};for(const e in xi){const t=30,[s,i]=xi[e],o=$.subclip(this.webgl.character.animations[0],e,s,i,t),a=this.animationMixer.clipAction(o);a.setLoop(F),a._fps=t,a._startFrame=s,a._endFrame=i,a.clampWhenFinished=!0,a.animationID=e,a.weight=0,a.currentWeight=0,a.scalarWeight=0,"Run"==e&&(a.timeScale=Qi),"Walk"==e&&(a.timeScale=.9792),"Victory"==e&&(a.timeScale=.8),"ZiplineFall"==e&&(a.timeScale=2.2);for(let e=0;e<a._clip.tracks.length;e++){const t=a._clip.tracks[e];"Chara_Low_RigOeilD_ref.position"!==t.name&&"Chara_Low_RigOeilR_ref.position"!==t.name&&"Chara_Low_RigBouche_Ref.position"!==t.name||(a[t.name]=t)}this.allAnims[e]=a,"Walk"!==e&&"Run"!==e?"Jetpack"!==e?this.animations[e]=a:this.jetpackAnim=a:(this.moveAnims[e]=a,a.isMoveAnim=!0)}this.allAnimsKeys=Object.keys(this.allAnims)}function oo(e,t={}){"Idle1"===e&&(e="Idle");const s=!!t.instant,i=void 0!==t.loop?t.loop:F,o=this.animations[e];let a=t.time||0;if(o){if(s){if(!o)return;return this.animation=o,this.crossFadeTo(o,0),o.setLoop(i),void setTimeout((()=>{this.destroyed||(o.time=a)}),0)}return t.timeScale&&(o.timeScale=t.timeScale),new Promise((e=>{this.animation=o,o.setLoop(i),o.onComplete=e,this.crossFadeTo(o,t.duration??300),setTimeout((()=>{this.destroyed||(o.time=a)}),0)}))}}function ao(e,t){let s="Run";return e<.005?s=null:t<=Ji&&(s="Walk"),"Run"===this.lastAnimation&&"Walk"===s&&(this.timeout=100),this.lastAnimation=s,this.currentAnimation=null===s?s:this.timeout?"Run":s,this.currentAnimation}function no(e,t){for(const s in this.animations){const i=this.animations[s]===e;0===t&&e.weightTween&&e.weightTween.destroy(),i?(e.reset(),this.animation=e,this.fadeIn(e,t)):this.fadeOut(this.animations[s],t)}}function ro(){if(this.isUserPose)return;const e=this.isMoving?Zi:$i,t=this.forcedIdle||e[this.isPlayer?2:Math.floor(Math.random()*e.length)];this.setAnimation(t)}function lo(e,t,s=(()=>{})){if(e.reset(),e.play(),0===t)return e.currentWeight=1;e.weightTween&&e.weightTween.destroy(),e.weightTween=x({target:e,property:"currentWeight",duration:t,from:e.currentWeight,to:1,easing:"inOutQuart",onComplete:s})}function co(e,t=0,s=(()=>{})){if(0===t)return e.currentWeight=0;e.weightTween&&e.weightTween.destroy(),e.weightTween=x({target:e,property:"currentWeight",duration:t,from:e.currentWeight,to:0,easing:"inOutQuart",onComplete:s})}class ho extends Z{constructor(e){super(e)}afterInit(){super.afterInit(),this.position=new n(-12,13,-10),this.base.position.copy(this.position),this.base.lookAt(new n(0,1,0)),this.scalar=1.4,this.scalarEased=this.scalar}update(){const e=n.get().copy(this.position);this.scalarEased=Y(this.scalarEased,this.scalar,.03),e.multiplyScalar(this.scalarEased),this.base.position.copy(e),e.release()}beforeDestroy(){this.destroying=!0,super.beforeDestroy()}}const uo=new Int8Array([-1,-1,4,-1,-1,4]),po=new P;po.setAttribute("position",new O(uo,2));const fo=["precision highp float;","attribute lowp vec2 position;","varying highp vec2 vUv;","void main() {","vUv = position * 0.5 + 0.5;","gl_Position =  vec4(position, 0., 1);","}"].join(""),mo=fo;class go extends u{init(){const e=new J(Object.assign({},{vertexShader:mo,fragmentShader:"\n\tprecision highp float;\n\n\tuniform float pixelRatio;\n\tuniform vec2 res;\n\t#include <transition_mask_pars>\n\n\tconst vec3 overlay = vec3(1.);\n\n\tvoid main() {\n\t\tvec3 color = BASE_TRANSITION_COLOR * (1. - (road + sea + games))\n\t\t\t+ ROAD_GROUND_COLOR * road\n\t\t\t+ (WATER_TOP_COLOR + 0.2) * sea * 0.95\n\t\t\t+ GAMES_TRANSITION_COLOR * games;\n\n\t\t#include <transition_mask>\n\n\t\tcolor = mix(overlay, color, circle);\n\t\t// float alpha = mix(1. - smoothstep(0., 0.75, maskRadius), 1., circle);\n\t\tfloat alpha = mix(1. - maskRadius, 1., circle);\n\n\t\tgl_FragColor = vec4(color, alpha);\n\n\t}\n",depthWrite:!1,uniforms:{...Q.transitions,...Q.global,pixelRatio:Q.pixelRatio},defines:{...ee(),...p.store.biomes.default.defines}}));e.transparent=!0,this.base=new T(po,e),this.base.frustumCulled=!1,this.base.renderOrder=this.webgl.store.renderOrder.transitionPlane,this.base.matrixAutoUpdate=!1}}const yo=te("#define PHONG\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <world_pos_pars>\n#include <conditionals>\n#include <linear_step>\n#include <luma>\n#include <blend_modes>\n#include <bg_fog_pars>\n#include <big_shadow_pars>\n#include <transition_mask_pars>\nuniform float pixelRatio;uniform vec3 specular;uniform float shininess;uniform float opacity;uniform float time;uniform vec2 res;varying vec2 vData;uniform float waterProgress;const vec3 waterColor=WATER_COLOR;const vec3 waterTopColor=WATER_TOP_COLOR;varying vec2 vGradient;uniform sampler2D noise;uniform float effectMult;void main(){\n#include <transition_mask>\nif(circle<1.)discard;vec4 diffuseColor=vec4(1.);vec3 diffuseTexel=texture2D(map,vUv).rgb;diffuseColor.rgb*=diffuseTexel;\n#include <normal_fragment_begin>\nvec3 rimColor=(BASE_TRANSITION_COLOR*(1.-(road+sea+games))+ROAD_GROUND_COLOR*road+(WATER_TOP_COLOR+0.2)*sea+GAMES_TRANSITION_COLOR*games)*0.5;float rimLightPower=1.6;float rimLightStrength=.49;float rightLight=rimLightPower*abs(dot(vNormal,normalize(vViewPosition)));rightLight=1.-smoothstep(.0,1.,rightLight);vec3 rim=vec3(rightLight*rimLightStrength)*rimColor;diffuseColor.rgb+=vec3(rightLight*rimLightStrength)*rimColor;rimLightPower=1.;rimLightStrength=0.2;rightLight=rimLightPower*abs(dot(vNormal,normalize(vViewPosition)));rightLight=1.-smoothstep(.0,1.,rightLight);diffuseColor.rgb+=diffuseColor.rgb*vec3(rightLight*rimLightStrength)*rimColor;ReflectedLight reflectedLight=ReflectedLight(vec3(.0),vec3(.0),vec3(.0),vec3(.0));vec3 color=diffuseColor.rgb;if(vData.r>0.1875){vec3 viewDir=normalize(vViewPosition);vec3 x=normalize(vec3(viewDir.z,0.0,-viewDir.x));vec3 y=cross(viewDir,x);vec2 matcapUV=vec2(dot(x,normal),dot(y,normal))*0.499+0.5;matcapUV.y=1.-matcapUV.y;matcapUV.x=matcapUV.x*0.25+0.75;vec3 matcap=texture2D(map,matcapUV).rgb;vec3 lMatcapColor=matcap*smoothstep(0.,0.1,(luma(reflectedLight.directDiffuse)));vec3 shadeMatcapColor=mix(lMatcapColor,matcap,0.4+0.4*smoothstep(0.,0.4,luma(matcap)))+reflectedLight.directSpecular;color=mix(color,shadeMatcapColor,0.30);color+=(smoothstep(0.99,0.995,cos(vGradient.x))+smoothstep(0.8,0.81,cos(vGradient.x-1.1))+smoothstep(0.93,0.94,cos(vGradient.x+3.)))*vGradient.y*2.1*smoothstep(1.,0.7,matcap.r)*step(0.32,vData.r)*effectMult;}color=color+color*vNormal.y*0.2;vec4 outColor=vec4(color,1.);gl_FragColor=outColor;\n#include <water_depth_frag_pre>\n#include <water_depth_frag>\ngl_FragColor=mix(outColor,gl_FragColor,sea);}","fragmentShader"),bo=te("#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <world_pos_pars>\nuniform float time;uniform sampler2D data;varying vec2 vData;varying vec4 vBigShadowDirectionalCoords;uniform mat4 bigShadowMatrix;varying vec2 vGradient;uniform float effectMult;uniform float road;void main(){\n#include <uv_vertex>\n#include <beginnormal_vertex>\n#include <defaultnormal_vertex>\n#include <normal_vertex>\n#include <begin_vertex>\nvec3 dataTexel=texture2D(data,vUv).rgb;vData=dataTexel.rg;transformed.y+=smoothstep(.1,1.,position.y)*.17*(sin(time*18.)+1.)*0.5*road*step(0.2,position.y);\n#include <project_vertex>\nvViewPosition=-mvPosition.xyz;\n#include <world_pos>\nvec4 worldPosition=vWorldPos;vec3 UP=vec3(0.,1.,0.);vec3 N=normal;vec3 T=normalize(cross(UP,normal));vec3 B=cross(normal,UP);mat3 tsb=mat3(normalize(T),normalize(B),normalize(N));vec4 t=vec4(10.,10.,10.,1.)*viewMatrix;vec3 absCam=abs(cameraPosition);float m=0.25;vGradient.x=(position*tsb).r+worldPosition.y+length(worldPosition.xyz-cameraPosition)*-0.2*m+(t.x+t.y+t.z)*0.2*m+(max(absCam.x,max(absCam.y,absCam.z)))*0.3*m;vGradient.y=smoothstep(40.,5.,length(worldPosition.xyz-cameraPosition))*0.06*vNormal.z;\n#include <envmap_vertex>\n#include <shadowmap_vertex>\nvec3 bigShadowWorldNormal=inverseTransformDirection(transformedNormal,viewMatrix);vec4 bigShadowWorldPosition=worldPosition+vec4(bigShadowWorldNormal*0.05,0);vBigShadowDirectionalCoords=bigShadowMatrix*bigShadowWorldPosition;\n#include <fog_vertex>\n}","vertexShader");let vo=null;class wo extends se{constructor(){super();const e=p.resources.textures,t=this.uniforms={...ie.merge([oe.common,oe.specularmap,oe.fog,oe.lights]),...Q.water,...Q.bigShadow,...Q.global,...Q.transitions,time:{value:0},pixelRatio:Q.pixelRatio,effectMult:{value:1},map:{value:e.Assets_Gradients},data:{value:e.assetsData},noise:{value:e.noise},noLight:{value:0},diffuse:{value:new V(16777215)},emissive:{value:new V(0)},specular:{value:new V(1118481)},shininess:{value:10}};this.defines={...ee(),...p.store.biomes.default.defines},this.map=t.map.value,yo.use(this),bo.use(this),this.lights=!0,this.fog=!0,this.type="ShaderMaterial",this.isShaderMaterial=!0,this.isTransitionAssetMaterial=!0,this.transparent=!0,p.hooks.beforeUpdate.watch(this.udpate,this)}pauseEffects(e){this.pausedEffectID=e,this.uniforms.effectMult.value=0}resumeEffects(e){e&&e!==this.pausedEffectID||(this.pausedEffectID=null)}udpate(){if(!this.pausedEffectID){const e=this.uniforms.effectMult;e.value=ae(e.value,1,.07,.001)}}}wo.use=function(){return vo=vo||new wo,vo},wo.unuse=function(){};let _o=null;class xo extends J{constructor(){super(),this.uniforms={...Q.transitions,...Q.global,pixelRatio:Q.pixelRatio,opacity:{value:1}},this.vertexShader="\nprecision highp float;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nattribute vec3 position;\nvoid main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n",this.fragmentShader="\n\tprecision highp float;\n\t#include <transition_mask_pars>\n\tuniform float opacity;\n\tuniform float pixelRatio;\n\tuniform vec2 res;\n\tvoid main() {\n\t\t#include <transition_mask>\n\t\tif(circle < 1.) discard;\n\t\tgl_FragColor = vec4(0., 0., 0., opacity);\n\t}\n",this.transparent=!0,this.type="ShaderMaterial",this.isRawShaderMaterial=!0}}xo.use=function(){return _o=_o||new xo,_o},xo.unuse=function(){};class So extends u{init(){const e=this.webgl.resources.assets.Taxi.geometry;this.base=new T(e,wo.use()),this.base.position.y=1,this.base.renderOrder=this.webgl.store.renderOrder.transitionPlane+3,this.shadow=new T(this.webgl.resources.geometries.plane,xo.use()),this.shadow.renderOrder=this.webgl.store.renderOrder.transitionPlane+2,this.shadow.rotateX(Math.PI/-2),this.shadow.scale.set(2.44,3.5,1),this.shadow.position.z-=.3,this.shadow.position.y+=.01,this.base.add(this.shadow)}update(){if(!this.base.visible)return;const e=this.scene.time;this.base.material.uniforms.time.value=e,this.shadow.material.uniforms.opacity.value=.16,this.base.position.x=1*Math.sin(1.57+e),this.base.rotation.y=.3*Math.sin(e)}}class Mo extends u{init(){this.base=new L,this.base.rotation.y=Math.PI/2;const e=this.webgl.resources.assets.BoatYellow.geometry;this.boat=new T(e,wo.use()),this.boat.position.y=-.1,this.boat.renderOrder=this.webgl.store.renderOrder.transitionPlane+2,this.qt=new H,this.base.add(this.boat)}update(){if(!this.base.visible)return;const e=this.scene.time;this.boat.material.uniforms.time.value=e,this.base.position.x=1*Math.sin(1.57+e),this.base.position.y=.1*Math.cos(1*e+20)+.1,this.boat.quaternion.copy(this.qt),this.boat.rotation.x=.06*Math.sin(e+3.14),this.boat.rotateY(.2*Math.sin(e)),this.boat.rotateX(.03*Math.sin(1*e)),this.boat.rotateZ(.06*Math.cos(2*e+2)+.01)}}const To=(e,t)=>Math.floor(Math.random()*(t-e))+e;function Oo(e){return e[To(0,e.length)]}const Po=new r,Ao=[new r(1,0),new r(0,1),new r(-1,0),new r(0,-1)],Io=new H;class Co extends u{init(){this.baseJoystick=this.webgl.resources.assets.JoystickRaw.mesh.clone(),this.baseJoystick.traverse((e=>{e.isMesh&&(e.material=wo.use(),e.renderOrder=this.webgl.store.renderOrder.transitionPlane+3)})),this.joystick="Base002"==this.baseJoystick.children[1].name?this.baseJoystick.children[0]:this.baseJoystick.children[1],this.baseJoystick.scale.set(1.5,1.5,1.5),this.baseJoystick.position.y=-.3,this.target=Ao[0],this.time=1e3;const e={initial:0,tension:.08,friction:.14};this.springX=m(e),this.springY=m(e),this.neutral=!0,this.shadow=new T(new ne(1.5,32).rotateX(-Math.PI/2),xo.use()),this.shadow.position.y-=.7,this.shadow.renderOrder=this.webgl.store.renderOrder.transitionPlane+2,this.base=new L,this.base.add(this.baseJoystick),this.base.add(this.shadow)}update(){if(!this.base.visible)return;this.time+=this.scene.fixedDt,this.time>(this.neutral?.2:.5)&&(this.time=0,this.neutral=!this.neutral,this.neutral?(this.springX.setTarget(Po.x),this.springY.setTarget(Po.y),this.springX.setFriction(.25),this.springY.setFriction(.25),this.webgl.audio.playSound("sfx_phone_scroll_tic",{volume:.8,playbackRate:re.randomFloat(.9,1.1)})):(this.target=function(e,t){const s=e.length;if(s<2)return e[0];const i=e.indexOf(t),o=s-1;return-1===i?Oo(e):0===i?e[To(1,s)]:i===o?e[To(0,o)]:Math.random()<i/o?e[To(0,i)]:e[To(i+1,s)]}(Ao,this.target),this.springX.setTarget(this.target.x),this.springY.setTarget(this.target.y),this.springX.setFriction(.15),this.springY.setFriction(.15),this.webgl.audio.playSound("sfx_phone_scroll_tic",{volume:.8,playbackRate:re.randomFloat(.9,1.1)})));const e=1e3*this.scene.fixedDt;this.springX.update(e),this.springY.update(e);const t=this.springX.value,s=this.springY.value;this.joystick.rotation.x=.3*t,this.joystick.rotation.z=.3*s,this.baseJoystick.quaternion.copy(Io),this.baseJoystick.rotation.x=.05*t,this.baseJoystick.rotation.z=.05*s,this.baseJoystick.position.y=.3*Math.cos(3*this.scene.time),this.baseJoystick.rotateY(.2*this.scene.time),this.shadow.scale.setScalar(.9+-.075*Math.cos(3*this.scene.time)),this.shadow.material.uniforms.opacity.value=.09+-.04*Math.cos(3*this.scene.time)}}const Ro=te("varying vec2 vUv;uniform sampler2D noise;uniform vec2 res;uniform float time;uniform sampler2D clouds;const float lineWidth=.01;const float middleLineHalfWidth=.004;const float lineBottomBegin=.3;const float lineTopBegin=.68;const float lineMiddleBegin=.5;\n#include <transition_mask_pars>\nuniform float pixelRatio;const vec3 roadBackground=ROAD_GROUND_COLOR;const vec3 waterBackground=(WATER_TOP_COLOR+0.2)*0.95;void main(){\n#include <transition_mask>\nif(circle<1.)discard;vec2 centerLen=vUv-vec2(0.5);float dist=1.-dot(centerLen,centerLen)*4.;float lBottomBegin=lineBottomBegin+sin(vUv.y*3.14+time)*.1;float lTopBegin=lineTopBegin+sin(vUv.y*3.14+time)*.1;float lMiddleBegine=lineMiddleBegin+sin(vUv.y*3.14+time)*.1;float bottom=step(vUv.x,lTopBegin+lineWidth)*(1.-step(vUv.x,lTopBegin));float top=step(vUv.x,lBottomBegin+lineWidth)*(1.-step(vUv.x,lBottomBegin));float middle=step(vUv.x,lMiddleBegine+middleLineHalfWidth)*(1.-step(vUv.x,lMiddleBegine-middleLineHalfWidth));middle=mix(middle,0.,step(fract(vUv.y*3.+time*2.),.5));vec3 lineColor=roadBackground*.8;vec3 roadColor=mix(roadBackground,lineColor,bottom);roadColor=mix(roadColor,lineColor,top);roadColor=mix(roadColor,lineColor,middle);vec3 waterColor=vec3(0.);if(sea>0.){float tex=texture2D(noise,vUv*0.7+time*vec2(0.01,0.2)).r;float tex2=texture2D(noise,vUv*0.7+(time-100.)*vec2(0.012,0.18)).r;float tex3=texture2D(noise,vUv*0.8+(time+20.)*vec2(0.012,0.25)).r;float seaMiddle=lineMiddleBegin+sin(vUv.y*3.14+time)*.1;float amp=smoothstep(0.5,0.,vUv.y)*0.1;float wave=cos(vUv.y*70.+time*22.)*(-0.004+amp*0.4);float waves=step(vUv.x-0.0+wave-amp,seaMiddle)*(1.-step(vUv.x+0.1+wave+amp,seaMiddle))*step(vUv.y,0.5);float nowave=1.-waves;float ws=smoothstep(0.45,.5,tex*tex2);float ws2=smoothstep(0.45,.5,tex*tex3);waterColor=mix(waterBackground,vec3(1.),ws2*1.*nowave);waterColor=mix(waterColor,vec3(1.),ws*-0.8*nowave);waterColor+=waves*smoothstep(0.07,0.6,vUv.y)*0.8;}float fade=clamp(0.,1.,sin(vUv.y*3.14)*2.);fade=mix(fade,smoothstep(.5,.6,pow(1.-distance(vUv,vec2(.5)),1.)),sea);vec3 background=mix(roadBackground,waterBackground,sea);vec3 color=mix(roadColor,waterColor,sea);color=mix(background,color,fade);gl_FragColor=vec4(color,1.);}","fragmentShader"),ko=te("varying vec2 vUv;void main(){vUv=uv;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}","vertexShader");let Do=null;class Lo extends se{constructor(){super({depthTest:!0,depthWrite:!1,defines:{...ee(),...p.store.biomes.default.defines}}),this.uniforms={noise:{value:p.resources.textures.noise},time:{value:0},pixelRatio:Q.pixelRatio,...Q.transitions,...Q.global},this.transparent=!0,Ro.use(this),ko.use(this),this.type="ShaderMaterial",this.isShaderMaterial=!0}}Lo.use=function(){return Do=Do||new Lo,Do},Lo.unuse=function(){};class Eo extends u{init(){this.base=new T(this.webgl.resources.geometries.plane,Lo.use()),this.base.scale.set(12,12,12),this.base.position.y+=1,this.base.frustumCulled=!1,this.base.rotation.x=-Math.PI/2,this.base.renderOrder=this.webgl.store.renderOrder.transitionPlane+1}update(){this.base.visible&&(this.base.material.uniforms.time.value=this.scene.time)}}class Fo extends le{init(){this.camera=this.add(ho),this.bg=this.add(go),this.ground=this.add(Eo),this.taxi=this.add(So),this.boat=this.add(Mo),this.joystick=this.add(Co),this.tween=null,this.fixedDt=.02,this.bind("reset"),this.reset(),this.soundLoop=null}get mixins(){return["timers"]}prerender(){this.bg.base.visible=!0,this.taxi.base.visible=!0,this.boat.base.visible=!0,this.joystick.base.visible=!0,this.triggerRender(!0),this.reset()}triggerRender(e){(e||this.webgl.store.isTransitionActive.value)&&(this.webgl.threeRenderer.clearDepth(),super.triggerRender())}triggerUpdate(){this.webgl.store.isTransitionActive.value&&super.triggerUpdate()}async loaderIn(e="road"){return this.tween&&this.tween.isOut&&(this.tween=this.tween.destroy()),this.tween&&!this.tween.destroyed||(this.clearSoundLoop(),this.clearTimers(),this.reset(),this.bg.base.visible=!0,Q.transitions[e]&&(Q.transitions[e].value=1,"road"===e?(this.taxi.base.visible=!0,this.ground.base.visible=!0,this.webgl.audio.playSound("sfx_travel_taxi_klaxon",{delay:500}),W(500).then((()=>{this.tween.isOut||(this.soundLoop=this.webgl.audio.playSound("sfx_travel_taxi_loop",{volume:.7,fadein:500,fadeout:500}))}))):"sea"===e?(this.boat.base.visible=!0,this.ground.base.visible=!0,W(500).then((()=>{this.tween.isOut||(this.soundLoop=this.webgl.audio.playSound("sfx_minigame_boat_loop",{volume:.6,fadein:500,fadeout:500}))}))):"games"===e&&(this.joystick.base.visible=!0)),e&&(this.webgl.app.$store.isSpinnerVisible=!0),this.webgl.audio.playSound("sfx_UI_transition_open",{delay:400}),this.tween=x({target:Q.transitions.maskRadius,property:"value",duration:1100,from:1,to:0,selfDestruct:!0,easing:"inOutQuart"}),this.tween.isIn=!0,this.minTimeLoader=e?this.wait(2e3):this.wait(1e3),this.camera.scalarEased=.35,this.camera.scalar=1),this.tween.finished}async loaderOut(e=!0){return this.tween&&this.tween.isIn&&(this.tween=this.tween.destroy()),this.tween&&!this.tween.destroyed||(Q.transitions.maskRadius.value=0,await this.minTimeLoader,e&&(this.webgl.app.$store.isSpinnerVisible=!1),this.clearSoundLoop(),this.webgl.audio.playSound("sfx_UI_transition_close",{delay:200}),this.camera.scalar=1.5,this.tween=x({target:Q.transitions.maskRadius,property:"value",duration:1100,from:0,to:1,easing:"inOutQuart",selfDestruct:!0,onComplete:this.reset}),this.tween.isOut=!0),this.tween.finished}clearSoundLoop(){this.soundLoop&&this.soundLoop.stop(),this.soundLoop=null}reset(){this.clearSoundLoop(),this.boat.base.visible=!1,this.taxi.base.visible=!1,this.bg.base.visible=!1,this.ground.base.visible=!1,this.joystick.base.visible=!1,this.time=0,Q.transitions.sea.value=0,Q.transitions.road.value=0,Q.transitions.games.value=0}update(){this.time+=this.fixedDt,this.tween&&this.tween.update(1e3*this.fixedDt)}}class Uo extends t{created(){const e={},t=(e=>{let t=new Set,s=e;do{Object.getOwnPropertyNames(s).map((e=>t.add(e)))}while(s=Object.getPrototypeOf(s));return[...t.keys()].filter((t=>"function"==typeof e[t]))})(this.base);for(let s=0,o=t.length;s<o;s++){const o=t[s];if("function"!=typeof this.base[o])continue;if(!o.startsWith("update"))continue;const a=o.slice(6),n=i(this.base[o],this.base);e[a]=n}this.base.stateMachine=new S({states:e})}update(){this.base.stateMachine.update()}destroyed(){this.base.stateMachine.destroy()}}const zo=()=>{},Bo=["INPUT","SELECT","TEXTAREA","A","BUTTON"].reduce(((e,t)=>(e[t]=1,e)),{}),No="ARROWUP",jo="ARROWDOWN",Vo="ARROWLEFT",Ho="ARROWRIGHT",Wo="A",Go="B",qo=[null,No,Ho,jo,Vo],Yo=[No,No,jo,jo,Vo,Ho,Vo,Ho,Go,Wo],Ko={};let Xo=0,$o=!1,Zo=zo,Jo=!1;let Qo,ea,ta,sa=null;function ia(){ta||(!function(){if(Qo)return;const e={color:"black",background:"white",boxShadow:"0px 0px 0px 0px #fff, 0px 0px 0px 0px #fff",transform:"translateY(0px)"},t={color:"white",background:"transparent",boxShadow:"0px 3px 0px 0px #fff, 0px 6px 0px 0px #fff",transform:"translateY(-6px)"},s={width:"85px",height:"85px",appearance:"none",color:"white",border:"4px solid white",borderRadius:"50%",fontSize:"30px",fontWeight:"bold",margin:"0px 15px",fontFamily:"sans-serif",transition:"transform 230ms ease-out, box-shadow 230ms ease-out, background 100ms"};Qo=document.createElement("div"),Object.assign(Qo.style,{position:"fixed",zIndex:99999,top:0,left:0,right:0,bottom:0,display:"flex",flexFlow:"row nowrap",alignItems:"center",justifyContent:"center",background:"rgba(0, 0, 0, 0.7)"});const i=[];function o(o,a){const n=document.createElement("button");Object.assign(n.style,s,t),Qo.appendChild(n),n.textContent=a||o,n.dataset.bypassTouch=!0,n.onclick=t=>{t.preventDefault(),Object.assign(n.style,e),na(o)},i.push(n)}o(Wo,"A"),o(Go,"B"),ea=()=>{i.forEach((e=>Object.assign(e.style,t)))}}(),ta=!0,ea(),document.body.appendChild(Qo))}function oa(){ta&&(ta=!1,document.body.removeChild(Qo),ea())}function aa(){for(const e in Ko)Ko[e]=!1;Xo=0}function na(e){if(e!==Yo[Xo])return Xo=0,void oa();Xo++,Xo>=Yo.length?(Xo=0,ta&&setTimeout(oa,600),Zo()):!Jo||Yo[Xo]!==Wo&&Yo[Xo]!==Go?oa():ia()}function ra(e){if(Bo[e.tagName])return;Jo=!1;const t=e.key.toUpperCase();Ko[t]||na(t),Ko[t]=!0}function la(e){const t=e.key.toUpperCase();Ko[t]=!1}function ca(e){Jo=!0,na(qo[e])}const ha={start:function(e={}){!function(e,t="log",s="console"){window[s][t]("%c                 %cB  %cA ","font-size: 16px; background: black; color: #aaa;","font-size: 16px; background: black; color: #fd605b;","font-size: 16px; background: black; color: #32c850;")}(),$o||(aa(),e.swipeSignal&&(sa=e.swipeSignal),sa&&sa.watch(ca),window.addEventListener("keydown",ra),window.addEventListener("keyup",la),document.addEventListener("visibilitychange",aa),$o=!0)},stop:function(){$o&&(aa(),oa(),sa&&sa.unwatch(ca),window.removeEventListener("keydown",ra),window.removeEventListener("keyup",la),document.removeEventListener("visibilitychange",aa),$o=!1)},reset:aa,get callback(){return Zo},set callback(e){Zo=e||zo}};var ua;function da(t){const s=t.app.$preloader.createTask({weight:10});let i;function o(){t.threeRenderer;t.scenes.render(),i.triggerRender()}function n(e){const s=t.renderer,i=t.store;let o=t.app.$device.type.mobile,a=t.app.$device.type.phone;const n=o?.7:1;switch(e){case 5:s.setMaxPixelCount(a?"1080p":o?"1440p":"3k"),s.setMaxPixelRatio(2),s.setMinPixelRatio(1.2),i.windVisible.set(!0),i.waterVisible.set(!0),i.dynamicShadowSize.set(o?1024:2048),i.chunksCastShadow.set(!o),i.npcMinDistance.set(o?4500:5400),i.npcMaxDistance.set(o?6300:6900),i.grass.radius=1,t.app.$store.confettisCount=100*n;break;case 4:s.setMaxPixelCount(a?"1080p":"1440p"),s.setMaxPixelRatio(o?1.6:1.75),s.setMinPixelRatio(o?1:1.1),i.windVisible.set(!0),i.waterVisible.set(!0),i.dynamicShadowSize.set(1024),i.chunksCastShadow.set(!o),i.npcMinDistance.set(o?4500:5400),i.npcMaxDistance.set(o?6300:6900),i.grass.radius=.8,t.app.$store.confettisCount=80*n;break;case 3:s.setMaxPixelCount(a?"1080p":"1440p"),s.setMaxPixelRatio(o?1.25:1.5),s.setMinPixelRatio(1),i.windVisible.set(!0),i.waterVisible.set(!0),i.dynamicShadowSize.set(512),i.chunksCastShadow.set(!1),i.npcMinDistance.set(o?3500:4500),i.npcMaxDistance.set(o?5500:6300),i.grass.radius=.6,t.app.$store.confettisCount=70*n;break;case 2:s.setMaxPixelCount("1080p"),s.setMaxPixelRatio(o?1:1.15),s.setMinPixelRatio(1),i.windVisible.set(!1),i.waterVisible.set(!0),i.dynamicShadowSize.set(256),i.chunksCastShadow.set(!1),i.npcMinDistance.set(o?2700:3500),i.npcMaxDistance.set(o?4300:5500),i.grass.radius=.3,t.app.$store.confettisCount=50*n;break;case 1:s.setMaxPixelCount("1080p"),s.setMaxPixelRatio(1),s.setMinPixelRatio(1),i.windVisible.set(!1),i.waterVisible.set(!0),i.dynamicShadowSize.set(256),i.chunksCastShadow.set(!1),i.npcMinDistance.set(2700),i.npcMaxDistance.set(4300),i.grass.radius=.2,t.app.$store.confettisCount=25*n;break;default:s.setMaxPixelCount("1080p"),s.setMaxPixelRatio(.8),s.setMinPixelRatio(.8),i.windVisible.set(!1),i.waterVisible.set(!1),i.dynamicShadowSize.set(128),i.chunksCastShadow.set(!1),i.npcMinDistance.set(900),i.npcMaxDistance.set(1500),i.grass.radius=0,t.app.$store.confettisCount=0*n}}!function(){for(const t in Cs){const s=t.split("/").pop().slice(0,-5);e[s]=Cs[t].default}}(),Object.assign(t,{init:async function(){const e=t.app.$device.gpu.string;e&&e.includes("apple a10")?t.quality.limitQuality(3):e&&e.includes("apple a9")&&t.quality.limitQuality(2);t.savestate=t.app.$savestate;const s=t.renderer;s.options.alpha=!1;const i="safari"===t.app.$device.browser;s.forceWebGL1=!!i,s.init(),s.instance.setClearColor(0,1),s.instance.shadowMap.enabled=!0,s.instance.shadowMap.type=ce,s.instance.autoClear=!1,t.time.clampTo60Fps=!0,Q.global.res=t.renderer.drawingBufferSize,t.store.chunksCastShadow.watchImmediate((e=>{Q.bigShadow.bigShadowDynamicChunks.value=e?1:0})),t.renderer.pixelRatio.watchImmediate((e=>{Q.pixelRatio.value=1/e})),t.noopRenderTarget=new he(1,1)},preload:async function(){await t.resources.prepare(),await t.resources.preload(),t.particles.init(),t.input.init(),await t.scenes.init(),s.finish()},start:async function(){let e;function s(){t.viewport.frame(),o()}t.renderer.resize(),t.time.init(),t.audio.init(),t.quality.current.watchImmediate(n),i=t.transitionScene=new Fo,i.triggerInit(),t.store.renderStopped.watchImmediate((e=>e?t.time.stop():t.time.start())),v(t.app.$viewport,(()=>{t.store.renderStopped.value&&(clearTimeout(e),e=setTimeout(s,200))})),t.store.isStarted.set(!0);let a=!1;const r=v((()=>t.savestate.game.vars.isIntroCompleted),(e=>{e&&(G((()=>r())),a||(a=!0,ha.start({swipeSignal:t.input.touch.swipe}),ha.callback=()=>{"EasterEgg"===t.scenes.currentSceneID.value?t.scenes.backToIsland():t.scenes.teleportTo("EasterEgg")}))}),{immediate:!0})},update:function(){t.scenes.update(),t.hooks.beforeParticlesUpdate.emit(),t.particles.update(),i.triggerUpdate()},render:o,prerender:function(){i.prerender()}}),t.hooks.beforeParticlesUpdate=a(),t.registerMixin("timers",Ds,"reactivity",Us,"actorDynamicProps",js,"actorInteractive",ri,"actorPropsTransition",yi,"character",Pi,"dialog",Ni,"characterAnimations",eo,"rafStateMachine",Uo)}(ua=L).prototype.updateMatrixWorld=function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let s=0,i=t.length;s<i;s++)t[s].manualMatrixUpdate&&!e||t[s].updateMatrixWorld(e)},ua.prototype.updateWorldMatrix=function(e,t){const s=this.parent;if(!0===e&&null!==s&&s.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===t){const e=this.children;for(let t=0,s=e.length;t<s;t++)e[t].manualMatrixUpdate||e[t].updateWorldMatrix(!1,!0)}};const pa=Number.MAX_SAFE_INTEGER,fa=[30,60,120,144,240].map((e=>[(e=1e3/e)+.75,e,e-.75]));const ma={"720p":921600,"1080p":2073600,"1440p":3686400,"2k":3686400,"3k":4665600,"4k":8294400,"5k":14745600,"8k":33177600};let ga,ya=1;function ba({format:e=Se,name:t,depth:i=!0,stencil:o=null,width:a,height:n,scale:r=1,srgb:l=!1,colorSpace:c=Me,generateMipmaps:h=!1}={}){ga||(ga=s());const u=ga.renderer.drawingBufferSize;null==t&&(t="RenderTarget."+ya++);let d,p=!1,f=!1;a&&n&&y(a,n),a&&n||b(r),l&&(c=Te),d=new he(a,n,{minFilter:xe,magFilter:xe,format:e,colorSpace:c,depthBuffer:!!i,stencilBuffer:!!(o??i)}),d.texture.generateMipmaps=!!h;const m=d.setSize.bind(d);d.setSize=y,d.setScale=b;const g=d.dispose.bind(d);function y(e=0,t=0){t||(t=e),e<=0||(a=e,n=t,v(),d&&w())}function b(e=0){e<=0||(r=e,function(){if(f)return;f=!0,u.watch(_)}(),_())}function v(){f&&(f=!1,u.unwatch(_))}function w(){d.texture.width===a&&d.texture.height===n||(p=!0,m(a,n),p=!1)}function _(){a=Math.floor(u.value.x*r),n=Math.floor(u.value.y*r),d&&w()}return d.dispose=function(){if(g(),p)return;v()},d.texture.name=t,d.clone=function(){},d}const va=new Oe,wa="precision highp float;varying vec2 vUv;void main(){gl_FragColor=vec4(vUv,0.,1.);}";let _a,xa;const Sa=()=>{};function Ma(e,t){return new Promise((s=>{const i=new Image;i.loading="eager";const o=setTimeout((()=>{}),1),a=()=>{clearTimeout(o);const a={node:i,url:e};t.onLoad&&t.onLoad(a),Pe.add(e,a),s(a)},n=e=>{};-1===e.indexOf(location.host)&&(i.crossOrigin="anonymous"),i.decode?(i.src=e,i.decode().then(a).catch(n)):(i.onload=a,i.onerror=n,i.decoding="async",i.src=e)}))}Ma.loader={name:"image",extensions:[".jpg",".png",".webp",".avif",".gif",".jpeg"],function:Ma};function Ta(){let e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const Oa={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class Pa{constructor(e){this.parser=e,this.name=Oa.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,i=t.length;s<i;s++){const i=t[s];i.extensions&&i.extensions[this.name]&&void 0!==i.extensions[this.name].light&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let i=t.cache.get(s);if(i)return i;const o=t.json,a=((o.extensions&&o.extensions[this.name]||{}).lights||[])[e];let n;const r=new V(16777215);void 0!==a.color&&r.fromArray(a.color);const l=void 0!==a.range?a.range:0;switch(a.type){case"directional":n=new De(r),n.target.position.set(0,0,-1),n.add(n.target);break;case"point":n=new ke(r),n.distance=l;break;case"spot":n=new Re(r),n.distance=l,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,n.angle=a.spot.outerConeAngle,n.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,n.target.position.set(0,0,-1),n.add(n.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return n.position.set(0,0,0),n.decay=2,void 0!==a.intensity&&(n.intensity=a.intensity),n.name=t.createUniqueName(a.name||"light_"+e),i=Promise.resolve(n),t.cache.add(s,i),i}createNodeAttachment(e){const t=this,s=this.parser,i=s.json.nodes[e],o=(i.extensions&&i.extensions[this.name]||{}).light;return void 0===o?null:this._loadLight(o).then((function(e){return s._getNodeRef(t.cache,o,e)}))}}class Aa{constructor(){this.name=Oa.KHR_MATERIALS_UNLIT}getMaterialType(){return y}extendParams(e,t,s){const i=[];e.color=new V(1,1,1),e.opacity=1;const o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){const t=o.baseColorFactor;e.color.fromArray(t),e.opacity=t[3]}void 0!==o.baseColorTexture&&i.push(s.assignTexture(e,"map",o.baseColorTexture))}return Promise.all(i)}}class Ia{constructor(e){this.parser=e,this.name=Oa.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Le:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],a=i.extensions[this.name];if(void 0!==a.clearcoatFactor&&(t.clearcoat=a.clearcoatFactor),void 0!==a.clearcoatTexture&&o.push(s.assignTexture(t,"clearcoatMap",a.clearcoatTexture)),void 0!==a.clearcoatRoughnessFactor&&(t.clearcoatRoughness=a.clearcoatRoughnessFactor),void 0!==a.clearcoatRoughnessTexture&&o.push(s.assignTexture(t,"clearcoatRoughnessMap",a.clearcoatRoughnessTexture)),void 0!==a.clearcoatNormalTexture&&(o.push(s.assignTexture(t,"clearcoatNormalMap",a.clearcoatNormalTexture)),void 0!==a.clearcoatNormalTexture.scale)){const e=a.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new r(e,e)}return Promise.all(o)}}class Ca{constructor(e){this.parser=e,this.name=Oa.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Le:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[];t.sheenColor=new V(0,0,0),t.sheenRoughness=0,t.sheen=1;const a=i.extensions[this.name];return void 0!==a.sheenColorFactor&&t.sheenColor.fromArray(a.sheenColorFactor),void 0!==a.sheenRoughnessFactor&&(t.sheenRoughness=a.sheenRoughnessFactor),void 0!==a.sheenColorTexture&&o.push(s.assignTexture(t,"sheenColorMap",a.sheenColorTexture)),void 0!==a.sheenRoughnessTexture&&o.push(s.assignTexture(t,"sheenRoughnessMap",a.sheenRoughnessTexture)),Promise.all(o)}}class Ra{constructor(e){this.parser=e,this.name=Oa.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Le:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],a=i.extensions[this.name];return void 0!==a.transmissionFactor&&(t.transmission=a.transmissionFactor),void 0!==a.transmissionTexture&&o.push(s.assignTexture(t,"transmissionMap",a.transmissionTexture)),Promise.all(o)}}class ka{constructor(e){this.parser=e,this.name=Oa.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Le:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],a=i.extensions[this.name];t.thickness=void 0!==a.thicknessFactor?a.thicknessFactor:0,void 0!==a.thicknessTexture&&o.push(s.assignTexture(t,"thicknessMap",a.thicknessTexture)),t.attenuationDistance=a.attenuationDistance||0;const n=a.attenuationColor||[1,1,1];return t.attenuationColor=new V(n[0],n[1],n[2]),Promise.all(o)}}class Da{constructor(e){this.parser=e,this.name=Oa.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Le:null}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const i=s.extensions[this.name];return t.ior=void 0!==i.ior?i.ior:1.5,Promise.resolve()}}class La{constructor(e){this.parser=e,this.name=Oa.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?Le:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const o=[],a=i.extensions[this.name];t.specularIntensity=void 0!==a.specularFactor?a.specularFactor:1,void 0!==a.specularTexture&&o.push(s.assignTexture(t,"specularIntensityMap",a.specularTexture));const n=a.specularColorFactor||[1,1,1];return t.specularColor=new V(n[0],n[1],n[2]),void 0!==a.specularColorTexture&&o.push(s.assignTexture(t,"specularColorMap",a.specularColorTexture).then((function(e){e.encoding=Ee}))),Promise.all(o)}}class Ea{constructor(e){this.parser=e,this.name=Oa.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,i=s.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const o=i.extensions[this.name],a=t.options.ktx2Loader;if(!a){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,o.source,a)}}class Fa{constructor(e){this.parser=e,this.name=Oa.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,i=s.json,o=i.textures[e];if(!o.extensions||!o.extensions[t])return null;const a=o.extensions[t],n=i.images[a.source];let r=s.textureLoader;if(n.uri){const e=s.options.manager.getHandler(n.uri);null!==e&&(r=e)}return this.detectSupport().then((function(o){if(o)return s.loadTextureImage(e,n,r);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class Ua{constructor(e){this.name=Oa.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const e=s.extensions[this.name],i=this.parser.getDependency("buffer",e.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([i,o.ready]).then((function(t){const s=e.byteOffset||0,i=e.byteLength||0,a=e.count,n=e.byteStride,r=new ArrayBuffer(a*n),l=new Uint8Array(t[0],s,i);return o.decodeGltfBuffer(new Uint8Array(r),a,n,l,e.mode,e.filter),r}))}return null}}const za="glTF",Ba=1313821514,Na=5130562;class ja{constructor(e){this.name=Oa.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12);if(this.header={magic:Ie.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==za)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const s=this.header.length-12,i=new DataView(e,12);let o=0;for(;o<s;){const t=i.getUint32(o,!0);o+=4;const s=i.getUint32(o,!0);if(o+=4,s===Ba){const s=new Uint8Array(e,12+o,t);this.content=Ie.decodeText(s)}else if(s===Na){const s=12+o;this.body=e.slice(s,s+t)}o+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Va{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Oa.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,i=this.dracoLoader,o=e.extensions[this.name].bufferView,a=e.extensions[this.name].attributes,n={},r={},l={};for(const c in a){const e=ln[c]||c.toLowerCase();n[e]=a[c]}for(const c in e.attributes){const t=ln[c]||c.toLowerCase();if(void 0!==a[c]){const i=s.accessors[e.attributes[c]],o=on[i.componentType];l[t]=o,r[t]=!0===i.normalized}}return t.getDependency("bufferView",o).then((function(e){return new Promise((function(t){i.decodeDracoFile(e,(function(e){for(const t in e.attributes){const s=e.attributes[t],i=r[t];void 0!==i&&(s.normalized=i)}t(e)}),n,l)}))}))}}class Ha{constructor(){this.name=Oa.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return t.texCoord,void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class Wa extends We{constructor(e){super(),this.isGLTFSpecularGlossinessMaterial=!0;const t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),s=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),i=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),o=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),a=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.roughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.roughness += geometryRoughness;","material.roughness = min( material.roughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),n={specular:{value:(new V).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=n,this.onBeforeCompile=function(e){for(const t in n)e.uniforms[t]=n[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",t).replace("#include <metalnessmap_pars_fragment>",s).replace("#include <roughnessmap_fragment>",i).replace("#include <metalnessmap_fragment>",o).replace("#include <lights_physical_fragment>",a)},Object.defineProperties(this,{specular:{get:function(){return n.specular.value},set:function(e){n.specular.value=e}},specularMap:{get:function(){return n.specularMap.value},set:function(e){n.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return n.glossiness.value},set:function(e){n.glossiness.value=e}},glossinessMap:{get:function(){return n.glossinessMap.value},set:function(e){n.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}copy(e){return super.copy(e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class Ga{constructor(){this.name=Oa.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"]}getMaterialType(){return Wa}extendParams(e,t,s){const i=t.extensions[this.name];e.color=new V(1,1,1),e.opacity=1;const o=[];if(Array.isArray(i.diffuseFactor)){const t=i.diffuseFactor;e.color.fromArray(t),e.opacity=t[3]}if(void 0!==i.diffuseTexture&&o.push(s.assignTexture(e,"map",i.diffuseTexture)),e.emissive=new V(0,0,0),e.glossiness=void 0!==i.glossinessFactor?i.glossinessFactor:1,e.specular=new V(1,1,1),Array.isArray(i.specularFactor)&&e.specular.fromArray(i.specularFactor),void 0!==i.specularGlossinessTexture){const t=i.specularGlossinessTexture;o.push(s.assignTexture(e,"glossinessMap",t)),o.push(s.assignTexture(e,"specularMap",t))}return Promise.all(o)}createMaterial(e){const t=new Wa(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=Fe,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}class qa{constructor(){this.name=Oa.KHR_MESH_QUANTIZATION}}class Ya extends bt{constructor(e,t,s,i){super(e,t,s,i)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,i=this.valueSize,o=e*i*3+i;for(let a=0;a!==i;a++)t[a]=s[o+a];return t}}Ya.prototype.beforeStart_=Ya.prototype.copySampleValue_,Ya.prototype.afterEnd_=Ya.prototype.copySampleValue_,Ya.prototype.interpolate_=function(e,t,s,i){const o=this.resultBuffer,a=this.sampleValues,n=this.valueSize,r=2*n,l=3*n,c=i-t,h=(s-t)/c,u=h*h,d=u*h,p=e*l,f=p-l,m=-2*d+3*u,g=d-u,y=1-m,b=g-u+h;for(let v=0;v!==n;v++){const e=a[f+v+n],t=a[f+v+r]*c,s=a[p+v+n],i=a[p+v]*c;o[v]=y*e+b*t+m*s+g*i}return o};const Ka=new H;class Xa extends Ya{interpolate_(e,t,s,i){const o=super.interpolate_(e,t,s,i);return Ka.fromArray(o).normalize().toArray(o),o}}const $a=0,Za=1,Ja=2,Qa=3,en=4,tn=5,sn=6,on={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},an={9728:at,9729:xe,9984:nt,9985:rt,9986:lt,9987:Be},nn={33071:ct,33648:ht,10497:Ne},rn={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ln={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},cn={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},hn={CUBICSPLINE:void 0,LINEAR:tt,STEP:ut},un="OPAQUE",dn="MASK",pn="BLEND";function fn(e,t,s){for(const i in s.extensions)void 0===e[i]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[i]=s.extensions[i])}function mn(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}function gn(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,i=t.weights.length;s<i;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,i=s.length;t<i;t++)e.morphTargetDictionary[s[t]]=t}}}function yn(e){const t=e.extensions&&e.extensions[Oa.KHR_DRACO_MESH_COMPRESSION];let s;return s=t?"draco:"+t.bufferView+":"+t.indices+":"+bn(t.attributes):e.indices+":"+bn(e.attributes)+":"+e.mode,s}function bn(e){let t="";const s=Object.keys(e).sort();for(let i=0,o=s.length;i<o;i++)t+=s[i]+":"+e[s[i]]+";";return t}function vn(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}class wn{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new Ta,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox|^((?!chrome|android).)*safari/i.test(navigator.userAgent)?this.textureLoader=new Ue(this.options.manager):this.textureLoader=new ze(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Ce(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,i=this.json,o=this.extensions;this.cache.removeAll(),this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])})).then((function(t){const a={scene:t[0][i.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:i.asset,parser:s,userData:{}};fn(o,a,i),mn(a,i),Promise.all(s._invokeAll((function(e){return e.afterRoot&&e.afterRoot(a)}))).then((function(){e(a)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let i=0,o=t.length;i<o;i++){const s=t[i].joints;for(let t=0,i=s.length;t<i;t++)e[s[t]].isBone=!0}for(let i=0,o=e.length;i<o;i++){const t=e[i];void 0!==t.mesh&&(this._addNodeRef(this.meshCache,t.mesh),void 0!==t.skin&&(s[t.mesh].isSkinnedMesh=!0)),void 0!==t.camera&&this._addNodeRef(this.cameraCache,t.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const i=s.clone(),o=(e,t)=>{const s=this.associations.get(e);null!=s&&this.associations.set(t,s);for(const[i,a]of e.children.entries())o(a,t.children[i])};return o(s,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const i=e(t[s]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let i=0;i<t.length;i++){const o=e(t[i]);o&&s.push(o)}return s}getDependency(e,t){const s=e+":"+t;let i=this.cache.get(s);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this.loadNode(t);break;case"mesh":i=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":i=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":i=this.loadSkin(t);break;case"animation":i=this.loadAnimation(t);break;case"camera":i=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(s,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,i=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(i.map((function(t,i){return s.getDependency(e,i)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[Oa.KHR_BINARY_GLTF].body);const i=this.options;return new Promise((function(e,o){s.load(Ie.resolveURL(t.uri,i.path),e,void 0,(function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const s=t.byteLength||0,i=t.byteOffset||0;return e.slice(i,i+s)}))}loadAccessor(e){const t=this,s=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse)return Promise.resolve(null);const o=[];return void 0!==i.bufferView?o.push(this.getDependency("bufferView",i.bufferView)):o.push(null),void 0!==i.sparse&&(o.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(o).then((function(e){const o=e[0],a=rn[i.type],n=on[i.componentType],r=n.BYTES_PER_ELEMENT,l=r*a,c=i.byteOffset||0,h=void 0!==i.bufferView?s.bufferViews[i.bufferView].byteStride:void 0,u=!0===i.normalized;let d,p;if(h&&h!==l){const e=Math.floor(c/h),s="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count;let l=t.cache.get(s);l||(d=new n(o,e*h,i.count*h/r),l=new A(d,h/r),t.cache.add(s,l)),p=new I(l,a,c%h/r,u)}else d=null===o?new n(i.count*a):new n(o,c,i.count*a),p=new O(d,a,u);if(void 0!==i.sparse){const t=rn.SCALAR,s=on[i.sparse.indices.componentType],r=i.sparse.indices.byteOffset||0,l=i.sparse.values.byteOffset||0,c=new s(e[1],r,i.sparse.count*t),h=new n(e[2],l,i.sparse.count*a);null!==o&&(p=new O(p.array.slice(),p.itemSize,p.normalized));for(let e=0,i=c.length;e<i;e++){const t=c[e];if(p.setX(t,h[e*a]),a>=2&&p.setY(t,h[e*a+1]),a>=3&&p.setZ(t,h[e*a+2]),a>=4&&p.setW(t,h[e*a+3]),a>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return p}))}loadTexture(e){const t=this.json,s=this.options,i=t.textures[e].source,o=t.images[i];let a=this.textureLoader;if(o.uri){const e=s.manager.getHandler(o.uri);null!==e&&(a=e)}return this.loadTextureImage(e,i,a)}loadTextureImage(e,t,s){const i=this,o=this.json,a=o.textures[e],n=o.images[t],r=(n.uri||n.bufferView)+":"+a.sampler;if(this.textureCache[r])return this.textureCache[r];const l=this.loadImageSource(t,s).then((function(t){t.flipY=!1,a.name&&(t.name=a.name);const s=(o.samplers||{})[a.sampler]||{};return t.magFilter=an[s.magFilter]||xe,t.minFilter=an[s.minFilter]||Be,t.wrapS=nn[s.wrapS]||Ne,t.wrapT=nn[s.wrapT]||Ne,i.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[r]=l,l}loadImageSource(e,t){const s=this,i=this.json,o=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((function(e){return e.clone()})).catch((function(e){throw e}));const a=i.images[e],n=self.URL||self.webkitURL;let r=a.uri||"",l=!1;if(void 0!==a.bufferView)r=s.getDependency("bufferView",a.bufferView).then((function(e){l=!0;const t=new Blob([e],{type:a.mimeType});return r=n.createObjectURL(t),r}));else if(void 0===a.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const c=Promise.resolve(r).then((function(e){return new Promise((function(s,i){let a=s;!0===t.isImageBitmapLoader&&(a=function(e){const t=new pt(e);t.needsUpdate=!0,s(t)}),t.load(Ie.resolveURL(e,o.path),a,void 0,i)}))})).then((function(e){var t;return!0===l&&n.revokeObjectURL(r),e.userData.mimeType=a.mimeType||((t=a.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":"image/png"),e})).catch((function(e){throw e}));return this.sourceCache[e]=c,c}assignTexture(e,t,s){const i=this;return this.getDependency("texture",s.index).then((function(o){if(void 0!==s.texCoord&&0!=s.texCoord&&("aoMap"!==t||s.texCoord),i.extensions[Oa.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[Oa.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=i.associations.get(o);o=i.extensions[Oa.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),i.associations.set(o,t)}}return e[t]=o,o}))}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const i=void 0===t.attributes.tangent,o=void 0!==t.attributes.color,a=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new je,Ve.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,t.sizeAttenuation=!1,this.cache.add(e,t)),s=t}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new He,Ve.prototype.copy.call(t,s),t.color.copy(s.color),this.cache.add(e,t)),s=t}if(i||o||a){let e="ClonedMaterial:"+s.uuid+":";s.isGLTFSpecularGlossinessMaterial&&(e+="specular-glossiness:"),i&&(e+="derivative-tangents:"),o&&(e+="vertex-colors:"),a&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=s.clone(),o&&(t.vertexColors=!0),a&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}s.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=s}getMaterialType(){return We}loadMaterial(e){const t=this,s=this.json,i=this.extensions,o=s.materials[e];let a;const n={},l=o.extensions||{},c=[];if(l[Oa.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const e=i[Oa.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];a=e.getMaterialType(),c.push(e.extendParams(n,o,t))}else if(l[Oa.KHR_MATERIALS_UNLIT]){const e=i[Oa.KHR_MATERIALS_UNLIT];a=e.getMaterialType(),c.push(e.extendParams(n,o,t))}else{const s=o.pbrMetallicRoughness||{};if(n.color=new V(1,1,1),n.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;n.color.fromArray(e),n.opacity=e[3]}void 0!==s.baseColorTexture&&c.push(t.assignTexture(n,"map",s.baseColorTexture)),n.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,n.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(c.push(t.assignTexture(n,"metalnessMap",s.metallicRoughnessTexture)),c.push(t.assignTexture(n,"roughnessMap",s.metallicRoughnessTexture))),a=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),c.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,n)}))))}!0===o.doubleSided&&(n.side=b);const h=o.alphaMode||un;if(h===pn?(n.transparent=!0,n.depthWrite=!1):(n.transparent=!1,h===dn&&(n.alphaTest=void 0!==o.alphaCutoff?o.alphaCutoff:.5)),void 0!==o.normalTexture&&a!==y&&(c.push(t.assignTexture(n,"normalMap",o.normalTexture)),n.normalScale=new r(1,1),void 0!==o.normalTexture.scale)){const e=o.normalTexture.scale;n.normalScale.set(e,e)}return void 0!==o.occlusionTexture&&a!==y&&(c.push(t.assignTexture(n,"aoMap",o.occlusionTexture)),void 0!==o.occlusionTexture.strength&&(n.aoMapIntensity=o.occlusionTexture.strength)),void 0!==o.emissiveFactor&&a!==y&&(n.emissive=(new V).fromArray(o.emissiveFactor)),void 0!==o.emissiveTexture&&a!==y&&c.push(t.assignTexture(n,"emissiveMap",o.emissiveTexture)),Promise.all(c).then((function(){let s;return s=a===Wa?i[Oa.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(n):new a(n),o.name&&(s.name=o.name),s.map&&(s.map.encoding=Ee),s.emissiveMap&&(s.emissiveMap.encoding=Ee),s.sheenColorMap&&(s.sheenColorMap.encoding=Ee),s.specularColorMap&&(s.specularColorMap.encoding=Ee),s.specularMap&&(s.specularMap.encoding=Ee),mn(s,o),t.associations.set(s,{materials:e}),o.extensions&&fn(i,s,o),s}))}createUniqueName(e){const t=Ge.sanitizeNodeName(e||"");let s=t;for(let i=1;this.nodeNamesUsed[s];++i)s=t+"_"+i;return this.nodeNamesUsed[s]=!0,s}loadGeometries(e){const t=this,s=this.extensions,i=this.primitiveCache;function o(e){return s[Oa.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(s){return xn(s,e,t)}))}const a=[];for(let n=0,r=e.length;n<r;n++){const s=e[n],r=yn(s),l=i[r];if(l)a.push(l.promise);else{let e;e=s.extensions&&s.extensions[Oa.KHR_DRACO_MESH_COMPRESSION]?o(s):xn(new P,s,t),i[r]={primitive:s,promise:e},a.push(e)}}return Promise.all(a)}loadMesh(e){const t=this,s=this.json,i=this.extensions,o=s.meshes[e],a=o.primitives,n=[];for(let l=0,c=a.length;l<c;l++){const e=void 0===a[l].material?(void 0===(r=this.cache).DefaultMaterial&&(r.DefaultMaterial=new We({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:dt})),r.DefaultMaterial):this.getDependency("material",a[l].material);n.push(e)}var r;return n.push(t.loadGeometries(a)),Promise.all(n).then((function(s){const n=s.slice(0,s.length-1),r=s[s.length-1],l=[];for(let h=0,u=r.length;h<u;h++){const s=r[h],c=a[h];let u;const d=n[h];if(c.mode===en||c.mode===tn||c.mode===sn||void 0===c.mode)u=!0===o.isSkinnedMesh?new qe(s,d):new T(s,d),!0!==u.isSkinnedMesh||u.geometry.attributes.skinWeight.normalized||u.normalizeSkinWeights(),c.mode===tn?u.geometry=Sn(u.geometry,k):c.mode===sn&&(u.geometry=Sn(u.geometry,R));else if(c.mode===Za)u=new Ye(s,d);else if(c.mode===Qa)u=new Ke(s,d);else if(c.mode===Ja)u=new Xe(s,d);else{if(c.mode!==$a)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+c.mode);u=new $e(s,d)}Object.keys(u.geometry.morphAttributes).length>0&&gn(u,o),u.name=t.createUniqueName(o.name||"mesh_"+e),mn(u,o),c.extensions&&fn(i,u,c),t.assignFinalMaterial(u),l.push(u)}for(let i=0,o=l.length;i<o;i++)t.associations.set(l[i],{meshes:e,primitives:i});if(1===l.length)return l[0];const c=new Ze;t.associations.set(c,{meshes:e});for(let e=0,t=l.length;e<t;e++)c.add(l[e]);return c}))}loadCamera(e){let t;const s=this.json.cameras[e],i=s[s.type];if(i)return"perspective"===s.type?t=new Je(Qe.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===s.type&&(t=new et(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),mn(t,s),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],s={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(s):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return s.inverseBindMatrices=e,s}))}loadAnimation(e){const t=this.json.animations[e],s=[],i=[],o=[],a=[],n=[];for(let r=0,l=t.channels.length;r<l;r++){const e=t.channels[r],l=t.samplers[e.sampler],c=e.target,h=void 0!==c.node?c.node:c.id,u=void 0!==t.parameters?t.parameters[l.input]:l.input,d=void 0!==t.parameters?t.parameters[l.output]:l.output;s.push(this.getDependency("node",h)),i.push(this.getDependency("accessor",u)),o.push(this.getDependency("accessor",d)),a.push(l),n.push(c)}return Promise.all([Promise.all(s),Promise.all(i),Promise.all(o),Promise.all(a),Promise.all(n)]).then((function(s){const i=s[0],o=s[1],a=s[2],n=s[3],r=s[4],l=[];for(let e=0,t=i.length;e<t;e++){const t=i[e],s=o[e],c=a[e],h=n[e],u=r[e];if(void 0===t)continue;let d;switch(t.updateMatrix(),t.matrixAutoUpdate=!0,cn[u.path]){case cn.weights:d=gt;break;case cn.rotation:d=mt;break;default:d=ft}const p=t.name?t.name:t.uuid,f=void 0!==h.interpolation?hn[h.interpolation]:tt,m=[];cn[u.path]===cn.weights?t.traverse((function(e){e.morphTargetInfluences&&m.push(e.name?e.name:e.uuid)})):m.push(p);let g=c.array;if(c.normalized){const e=vn(g.constructor),t=new Float32Array(g.length);for(let s=0,i=g.length;s<i;s++)t[s]=g[s]*e;g=t}for(let e=0,i=m.length;e<i;e++){const t=new d(m[e]+"."+cn[u.path],s.array,g,f);"CUBICSPLINE"===h.interpolation&&(t.createInterpolant=function(e){return new(this instanceof mt?Xa:Ya)(this.times,this.values,this.getValueSize()/3,e)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),l.push(t)}}const c=t.name?t.name:"animation_"+e;return new st(c,void 0,l)}))}createNodeMesh(e){const t=this.json,s=this,i=t.nodes[e];return void 0===i.mesh?null:s.getDependency("mesh",i.mesh).then((function(e){const t=s._getNodeRef(s.meshCache,i.mesh,e);return void 0!==i.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,s=i.weights.length;t<s;t++)e.morphTargetInfluences[t]=i.weights[t]})),t}))}loadNode(e){const t=this.json,s=this.extensions,i=this,o=t.nodes[e],a=o.name?i.createUniqueName(o.name):"";return function(){const t=[],s=i._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return s&&t.push(s),void 0!==o.camera&&t.push(i.getDependency("camera",o.camera).then((function(e){return i._getNodeRef(i.cameraCache,o.camera,e)}))),i._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)}().then((function(t){let n;if(n=!0===o.isBone?new it:t.length>1?new Ze:1===t.length?t[0]:new L,n!==t[0])for(let e=0,s=t.length;e<s;e++)n.add(t[e]);if(o.name&&(n.userData.name=o.name,n.name=a),mn(n,o),o.extensions&&fn(s,n,o),void 0!==o.matrix){const e=new l;e.fromArray(o.matrix),n.applyMatrix4(e)}else void 0!==o.translation&&n.position.fromArray(o.translation),void 0!==o.rotation&&n.quaternion.fromArray(o.rotation),void 0!==o.scale&&n.scale.fromArray(o.scale);return i.associations.has(n)||i.associations.set(n,{}),i.associations.get(n).nodes=e,n}))}loadScene(e){const t=this.json,s=this.extensions,i=this.json.scenes[e],o=this,a=new Ze;i.name&&(a.name=o.createUniqueName(i.name)),mn(a,i),i.extensions&&fn(s,a,i);const n=i.nodes||[],r=[];for(let l=0,c=n.length;l<c;l++)r.push(_n(n[l],a,t,o));return Promise.all(r).then((function(){return o.associations=(e=>{const t=new Map;for(const[s,i]of o.associations)(s instanceof Ve||s instanceof pt)&&t.set(s,i);return e.traverse((e=>{const s=o.associations.get(e);null!=s&&t.set(e,s)})),t})(a),a}))}}function _n(e,t,s,i){const o=s.nodes[e];return i.getDependency("node",e).then((function(e){if(void 0===o.skin)return e;let t;return i.getDependency("skin",o.skin).then((function(e){t=e;const s=[];for(let o=0,a=t.joints.length;o<a;o++)s.push(i.getDependency("node",t.joints[o]));return Promise.all(s)})).then((function(s){return e.traverse((function(e){if(!e.isMesh)return;const i=[],o=[];for(let a=0,n=s.length;a<n;a++){const e=s[a];if(e){i.push(e);const s=new l;void 0!==t.inverseBindMatrices&&s.fromArray(t.inverseBindMatrices.array,16*a),o.push(s)}}e.bind(new ot(i,o),e.matrixWorld)})),e}))})).then((function(e){t.add(e);const a=[];if(o.children){const t=o.children;for(let o=0,n=t.length;o<n;o++){const n=t[o];a.push(_n(n,e,s,i))}}return Promise.all(a)}))}function xn(e,t,s){const i=t.attributes,o=[];function a(t,i){return s.getDependency("accessor",t).then((function(t){e.setAttribute(i,t)}))}for(const n in i){const t=ln[n]||n.toLowerCase();t in e.attributes||o.push(a(i[n],t))}if(void 0!==t.indices&&!e.index){const i=s.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));o.push(i)}return mn(e,t),function(e,t,s){const i=t.attributes,o=new yt;if(void 0===i.POSITION)return;{const e=s.json.accessors[i.POSITION],t=e.min,a=e.max;if(void 0===t||void 0===a)return;if(o.set(new n(t[0],t[1],t[2]),new n(a[0],a[1],a[2])),e.normalized){const t=vn(on[e.componentType]);o.min.multiplyScalar(t),o.max.multiplyScalar(t)}}const a=t.targets;if(void 0!==a){const e=new n,t=new n;for(let i=0,o=a.length;i<o;i++){const o=a[i];if(void 0!==o.POSITION){const i=s.json.accessors[o.POSITION],a=i.min,n=i.max;if(void 0!==a&&void 0!==n){if(t.setX(Math.max(Math.abs(a[0]),Math.abs(n[0]))),t.setY(Math.max(Math.abs(a[1]),Math.abs(n[1]))),t.setZ(Math.max(Math.abs(a[2]),Math.abs(n[2]))),i.normalized){const e=vn(on[i.componentType]);t.multiplyScalar(e)}e.max(t)}}}o.expandByVector(e)}e.boundingBox=o;const r=new h;o.getCenter(r.center),r.radius=o.min.distanceTo(o.max)/2,e.boundingSphere=r}(e,t,s),Promise.all(o).then((function(){return void 0!==t.targets?function(e,t,s){let i=!1,o=!1,a=!1;for(let c=0,h=t.length;c<h;c++){const e=t[c];if(void 0!==e.POSITION&&(i=!0),void 0!==e.NORMAL&&(o=!0),void 0!==e.COLOR_0&&(a=!0),i&&o&&a)break}if(!i&&!o&&!a)return Promise.resolve(e);const n=[],r=[],l=[];for(let c=0,h=t.length;c<h;c++){const h=t[c];if(i){const t=void 0!==h.POSITION?s.getDependency("accessor",h.POSITION):e.attributes.position;n.push(t)}if(o){const t=void 0!==h.NORMAL?s.getDependency("accessor",h.NORMAL):e.attributes.normal;r.push(t)}if(a){const t=void 0!==h.COLOR_0?s.getDependency("accessor",h.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(n),Promise.all(r),Promise.all(l)]).then((function(t){const s=t[0],n=t[1],r=t[2];return i&&(e.morphAttributes.position=s),o&&(e.morphAttributes.normal=n),a&&(e.morphAttributes.color=r),e.morphTargetsRelative=!0,e}))}(e,t.targets,s):e}))}function Sn(e,t){let s=e.getIndex();if(null===s){const t=[],i=e.getAttribute("position");if(void 0===i)return e;for(let e=0;e<i.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const i=s.count-2,o=[];if(t===R)for(let n=1;n<=i;n++)o.push(s.getX(0)),o.push(s.getX(n)),o.push(s.getX(n+1));else for(let n=0;n<i;n++)n%2==0?(o.push(s.getX(n)),o.push(s.getX(n+1)),o.push(s.getX(n+2))):(o.push(s.getX(n+2)),o.push(s.getX(n+1)),o.push(s.getX(n)));o.length;const a=e.clone();return a.setIndex(o),a}const Mn=new WeakMap;function Tn(){let e,t;function s(e,t,s,i,o,a){const n=a.num_components(),r=s.num_points()*n,l=r*o.BYTES_PER_ELEMENT,c=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,o),h=e._malloc(l);t.GetAttributeDataArrayForAllPoints(s,a,c,l,h);const u=new o(e.HEAPF32.buffer,h,r).slice();return e._free(h),{name:i,array:u,itemSize:n}}onmessage=function(i){const o=i.data;switch(o.type){case"init":e=o.decoderConfig,t=new Promise((function(t){e.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(e)}));break;case"decode":const i=o.buffer,a=o.taskConfig;t.then((e=>{const t=e.draco,n=new t.Decoder,r=new t.DecoderBuffer;r.Init(new Int8Array(i),i.byteLength);try{const e=function(e,t,i,o){const a=o.attributeIDs,n=o.attributeTypes;let r,l;const c=t.GetEncodedGeometryType(i);if(c===e.TRIANGULAR_MESH)r=new e.Mesh,l=t.DecodeBufferToMesh(i,r);else{if(c!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");r=new e.PointCloud,l=t.DecodeBufferToPointCloud(i,r)}if(!l.ok()||0===r.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+l.error_msg());const h={index:null,attributes:[]};for(const u in a){const i=self[n[u]];let l,c;if(o.useUniqueIDs)c=a[u],l=t.GetAttributeByUniqueId(r,c);else{if(c=t.GetAttributeId(r,e[a[u]]),-1===c)continue;l=t.GetAttribute(r,c)}h.attributes.push(s(e,t,r,u,i,l))}c===e.TRIANGULAR_MESH&&(h.index=function(e,t,s){const i=s.num_faces(),o=3*i,a=4*o,n=e._malloc(a);t.GetTrianglesUInt32Array(s,a,n);const r=new Uint32Array(e.HEAPF32.buffer,n,o).slice();return e._free(n),{array:r,itemSize:1}}(e,t,r));return e.destroy(r),h}(t,n,r,a),i=e.attributes.map((e=>e.array.buffer));e.index&&i.push(e.index.array.buffer),self.postMessage({type:"decode",id:o.id,geometry:e},i)}catch(l){self.postMessage({type:"error",id:o.id,error:l.message})}finally{t.destroy(r),t.destroy(n)}}))}}}const On=new vt,Pn=new class extends Ae{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,s,i){const o=new Ce(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(e=>{const s={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(e,s).then(t).catch(i)}),s,i)}decodeDracoFile(e,t,s,i){const o={attributeIDs:s||this.defaultAttributeIDs,attributeTypes:i||this.defaultAttributeTypes,useUniqueIDs:!!s};this.decodeGeometry(e,o).then(t)}decodeGeometry(e,t){for(const r in t.attributeTypes){const e=t.attributeTypes[r];void 0!==e.BYTES_PER_ELEMENT&&(t.attributeTypes[r]=e.name)}const s=JSON.stringify(t);if(Mn.has(e)){const t=Mn.get(e);if(t.key===s)return t.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let i;const o=this.workerNextTaskID++,a=e.byteLength,n=this._getWorker(o,a).then((s=>(i=s,new Promise(((s,a)=>{i._callbacks[o]={resolve:s,reject:a},i.postMessage({type:"decode",id:o,taskConfig:t,buffer:e},[e])}))))).then((e=>this._createGeometry(e.geometry)));return n.catch((()=>!0)).then((()=>{i&&o&&this._releaseTask(i,o)})),Mn.set(e,{key:s,promise:n}),n}_createGeometry(e){const t=new P;e.index&&t.setIndex(new O(e.index.array,1));for(let s=0;s<e.attributes.length;s++){const i=e.attributes[s],o=i.name,a=i.array,n=i.itemSize;t.setAttribute(o,new O(a,n))}return t}_loadLibrary(e,t){const s=new Ce(this.manager);return s.setPath(this.decoderPath),s.setResponseType(t),s.setWithCredentials(this.withCredentials),new Promise(((t,i)=>{s.load(e,t,void 0,i)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then((t=>{const s=t[0];e||(this.decoderConfig.wasmBinary=t[1]);const i=Tn.toString(),o=["/* draco decoder */",s,"","/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([o]))})),this.decoderPending}_getWorker(e,t){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",decoderConfig:this.decoderConfig}),e.onmessage=function(t){const s=t.data;switch(s.type){case"decode":e._callbacks[s.id].resolve(s);break;case"error":e._callbacks[s.id].reject(s)}},this.workerPool.push(e)}else this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const s=this.workerPool[this.workerPool.length-1];return s._taskCosts[e]=t,s._taskLoad+=t,s}))}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}};Pn.setDecoderPath("/vendors/draco/"),Pn.preload(),Pn.setWorkerLimit(4);const An=new class extends Ae{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new Ia(e)})),this.register((function(e){return new Ea(e)})),this.register((function(e){return new Fa(e)})),this.register((function(e){return new Ca(e)})),this.register((function(e){return new Ra(e)})),this.register((function(e){return new ka(e)})),this.register((function(e){return new Da(e)})),this.register((function(e){return new La(e)})),this.register((function(e){return new Pa(e)})),this.register((function(e){return new Ua(e)}))}load(e,t,s,i){const o=this;let a;a=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:Ie.extractUrlBase(e),this.manager.itemStart(e);const n=function(t){i&&i(t),o.manager.itemError(e),o.manager.itemEnd(e)},r=new Ce(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,(function(s){try{o.parse(s,a,(function(s){t(s),o.manager.itemEnd(e)}),n)}catch(i){n(i)}}),s,n)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,i){let o;const a={},n={};if("string"==typeof e)o=e;else{if(Ie.decodeText(new Uint8Array(e,0,4))===za){try{a[Oa.KHR_BINARY_GLTF]=new ja(e)}catch(c){return void(i&&i(c))}o=a[Oa.KHR_BINARY_GLTF].content}else o=Ie.decodeText(new Uint8Array(e))}const r=JSON.parse(o);if(void 0===r.asset||r.asset.version[0]<2)return void(i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new wn(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let h=0;h<this.pluginCallbacks.length;h++){const e=this.pluginCallbacks[h](l);n[e.name]=e,a[e.name]=!0}if(r.extensionsUsed)for(let h=0;h<r.extensionsUsed.length;++h){const e=r.extensionsUsed[h],t=r.extensionsRequired||[];switch(e){case Oa.KHR_MATERIALS_UNLIT:a[e]=new Aa;break;case Oa.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:a[e]=new Ga;break;case Oa.KHR_DRACO_MESH_COMPRESSION:a[e]=new Va(r,this.dracoLoader);break;case Oa.KHR_TEXTURE_TRANSFORM:a[e]=new Ha;break;case Oa.KHR_MESH_QUANTIZATION:a[e]=new qa;break;default:t.indexOf(e)>=0&&n[e]}}l.setExtensions(a),l.setPlugins(n),l.parse(s,i)}parseAsync(e,t){const s=this;return new Promise((function(i,o){s.parse(e,t,i,o)}))}};async function In(e,t={}){const i=s().resources.supercache,o=await i.get(e+".scene.json");if(o&&!t.character&&!t.noCache){const e={scene:On.parse(o)};return t.onLoad&&t.onLoad(e),e}return new Promise(((s,o)=>{An.load(e,(o=>{o.scene.updateMatrixWorld(),o.scene.traverse((e=>{const t=e.userData.name;if(t&&(t.startsWith("Collider")||t.startsWith("SceneCollider"))){let t=e.geometry;delete t.attributes.normal,delete t.attributes.uv}})),t.character||i.add(e+".scene.json",o.scene.toJSON()),t.onLoad&&t.onLoad(o),s(o)}),(()=>{}),o)}))}async function Cn(e,t={}){const s=await fetch(e),i=await s.json();return Pe.add(e,i),t.onLoad&&t.onLoad(i),i}An.setDRACOLoader(Pn),In.loader={name:"gltf",extensions:[".gltf",".glb"],function:In},Cn.loader={name:"json",extensions:[".json"],function:Cn};const Rn="/assets/sprites.d8373bb465453426.json",kn=wt.list(Object.assign({"/assets/canvas/sprites/sprites.json":Rn,"/assets/canvas/sprites/sprites.png":"/assets/sprites.ca9a51e965453426.png"})),Dn=(e,t,s,i)=>Ln[e]={default:t,webp:s,avif:i},Ln={};Dn("noise","/assets/noise_perlin.956753cf65453426.png"),Dn("clouds","/assets/clouds.657c06ba65453426.png"),Ln.sprites=kn,Ln.spritesData=Rn;const En=Ln;function Fn(e){const t=p.threeRenderer.capabilities.isWebGL2,s=new pt(e.img);return void 0!==e.flipY&&(s.flipY=e.flipY),void 0!==e.mipmaps&&(s.generateMipmaps=!!e.mipmaps),e.red&&(e.format=t?_t:xt),e.alpha&&(e.format=St),e.nearest&&(s.magFilter=s.minFilter=at),e.magFilter&&(s.magFilter=e.magFilter),e.minFilter&&(s.minFilter=e.minFilter),e.encoding&&(s.encoding=e.encoding),e.mapping&&(s.mapping=e.mapping),e.premultiplyAlpha&&(s.premultiplyAlpha=!0),e.repeat?(s.wrapS=Ne,s.wrapT=Ne):(e.wrapS&&(s.wrapS=e.wrapS),e.wrapT&&(s.wrapT=e.wrapT)),e.format&&(s.format=e.format),e.type&&(s.type=e.type),s.needsUpdate=!0,s}function Un(e,t,s,i=0){const o=t.size,a=t.scale/1024,n={},r=e.anchor||e.pivot||{x:.5,y:.5};"hint"===s.split("_")[0]&&(r.x=0,r.y=0);const l=e.frame,c=e.sourceSize,h=e.spriteSourceSize;n.id=s;const u=s.split("/");n.sequence=u.pop(),n.group=u.join("/"),n.frameIndex=i,n.texCoords=new Float32Array([l.x/o.w,(o.h-l.y-l.h)/o.h,l.w/o.w,l.h/o.h]),n.meshCoords=new Float32Array([.5*h.w+h.x-c.w*r.x,-(.5*h.h+h.y-c.h*r.y),h.w,h.h]);for(let d=0,p=n.meshCoords.length;d<p;d++)n.meshCoords[d]*=a;return n.anchor=r,n.sourceSize=e.sourceSize,n.spriteSourceSize=e.spriteSourceSize,n.vertices=e.vertices,n.verticesUV=e.verticesUV,n.triangles=e.triangles,n}const zn="/assets/character.df6ab95f65453426.glb",Bn=wt.select,Nn=Mt.load;Mt.load=(e,t)=>Pe.get(e)?Promise.resolve(Pe.get(e)):Nn(e,t);const jn=new y({color:255});function Vn(e,t,s){s.log,Mt.registerLoader(Ma),Mt.registerLoader(In),Mt.registerLoader(Cn),t.basicMat=jn;const i=t.textures=e.textures={},o=t.character=e.character={heads:{},bodies:{},bottoms:{}};e.assets={},t.preload=async function(){const t=e.app.$preloader.task,s=[];e.audio.preloadSound("sfx_UI_dialog_next"),e.preloadAssets=["Taxi","BoatYellow","JoystickRaw"],s.push(t(Mt.load(En.spritesData,{onLoad:t=>{e.atlas=function(e){const t={sprites:{},meta:e.meta},s=e.frames;e.animations||(e.animations={});for(const i in e.animations){const o=e.animations[i],a=t.sprites[i]=[];for(let t=0,n=o.length;t<n;t++){const n=s[o[t]];delete s[o[t]],a.push(Un(n,e.meta,i,t))}}for(const i in s){const o=s[i],a=(o.filename?o.filename.toString():i).replace(/[^a-zA-Z0-9-_-]/g,"").replace("png",""),n=t.sprites[a]=[];delete s[i],n.push(Un(o,e.meta,a))}return t}(t)}}))),s.push(...[[Bn(En.sprites),"sprites",{}]].map((e=>t(Mt.load(e[0],{onLoad:({node:t})=>{i[e[1]]=Fn({img:t,flipY:!1,premultiplyAlpha:!0,...e[2]})}}))))),s.push(t(Mt.load(zn,{character:!0,onLoad:e=>{e.scene.traverse((t=>{if(o.scene=e.scene,t.isMesh&&(t.material=jn),"Armature"===t.name&&(o.armature=t),"SkinnedMesh"===t.type){let e=t.name.split("Rig")[1];e=e.split("-"),e="BODY_01"!==e[0]?e[0]+"-"+e[1]:"Character",t.skeleton&&t.skeleton.dispose(),t.updateMatrixWorld();const s=t.geometry.clone(),i=s.attributes.uv2,a=s.attributes.color,n=s.attributes.color_1,r=s.attributes.texcoord_2;i&&s.deleteAttribute&&s.deleteAttribute("uv2"),n&&s.deleteAttribute&&s.deleteAttribute("color_1"),a&&s.deleteAttribute&&s.deleteAttribute("color"),r&&s.deleteAttribute&&s.deleteAttribute("texcoord_2");const l=e.split("-"),c=l[0];switch(l[1],c){case"Character":o.main=s;break;case"Head":o.heads[e]=s;break;case"Body":o.bodies[e]=s;break;case"Bottom":o.bottoms[e]=s}}}));for(let t=o.armature.children.length-1,s=0;t>=s;t--){const e=o.armature.children[t];e.name.match(/(BODY_01)/g)||e.type.match(/(Bone)/g)||(o.armature.remove(e),e.name.match(/(OeilD)/g)&&(o.oeild=new L,o.oeild.name=e.name),e.name.match(/(OeilR)/g)&&(o.oeilr=new L,o.oeilr.name=e.name),e.name.match(/(Bouche)/g)&&(o.bouche=new L,o.bouche.name=e.name))}o.animations=e.animations}}))),await Promise.all(s),e.atlas.meta.image=e.textures.sprites,e.atlas.texture=e.textures.sprites},t.load=Mt.load}function Hn(e,t,s,i){const o=new Set,a=new Set;return{actorAssets:o,actorStaticAssets:a,prepareActor:function(s,n){if(!n.transformMatrix){const e=n.transforms;n.transformMatrix=e?(new l).compose({x:e[0],y:e[1],z:e[2]},{_x:e[6],_y:e[7],_z:e[8],_w:e[9]},{x:e[3],y:e[4],z:e[5]}):new l}if(!s.prepare)return;const r=s.prepare({actor:n,sceneID:t,savedata:e.savestate.getActorData(t,n.uid)})||{};s.isNPC?function(e,t){if(t.preloadAssets)for(let s=0,i=t.preloadAssets.length;s<i;s++)o.add(t.preloadAssets[s])}(0,r):function(e,t){if(t.staticProps)for(let s=0,o=t.staticProps.length;s<o;s++){const o=t.staticProps[s],n=o.asset,r=!!o.traversable,l=e.transforms;a.add(n);const c={asset:n,transforms:l,traversable:r};i.props||(i.props=[]),i.props.push(c)}if(t.staticColliders)for(let s=0,o=t.staticColliders.length;s<o;s++){const o=t.staticColliders[s].asset,n=e.transforms;a.add(o);const r={asset:o,transforms:n,colliderOnly:!0};i.props||(i.props=[]),i.props.push(r)}if(t.dynamicProps){e.dynamicProps={};for(let s in t.dynamicProps){const i=t.dynamicProps[s];i.asset?o.add(i.asset):i.asset=!1,i.collider?o.add(i.collider):i.collider=!1,e.dynamicProps[s]={...i,id:s}}}if(t.preloadAssets)for(let s=0,i=t.preloadAssets.length;s<i;s++)o.add(t.preloadAssets[s])}(n,r)}}}const Wn=wt.select,Gn=e=>e;let qn=!0;const Yn=document.createElement("canvas"),Kn=Yn.getContext("2d",{willReadFrequently:!0});function Xn(e,t,s){e.add(new Rt((new n).fromArray(t,0),(new n).fromArray(t,6),(new n).fromArray(s,3),(new n).fromArray(s,0)))}function $n(e,t,s){e.add(new kt((new n).fromArray(t),(new n).fromArray(s)))}function Zn(e,{closed:t=!1,curveType:s,tension:i}={}){const o=e.map((e=>(new n).fromArray(e)));return new It(o,t,s,i)}function Jn(e,{closed:t=!1}={}){const s=new Ct;for(let i=0,o=e.length-1;i<o;i++){Xn(s,e[i],e[i+1])}if(t){Xn(s,e[e.length-1],e[0]),s.isClosed=!0}return s}function Qn(e,{closed:t=!1}={}){const s=new Ct;for(let i=0,o=e.length-1;i<o;i++){$n(s,e[i],e[i+1])}if(t){$n(s,e[e.length-1],e[0]),s.isClosed=!0}return s}Yn.width=1,Yn.height=1;let er=performance.now();const tr=e=>{const t=performance.now();if(e||!(t-er<200))return er=t,new Promise((e=>requestAnimationFrame(e)))};let sr=!0;new j,new j;const ir=new yt,or=new Lt,ar=new Je,nr=new De(16777215,.5),rr=nr.shadow,lr=rr.camera;function cr(e,t,s,i,o){o.visible=!1}nr.castShadow=!0,nr.shadow.matrixWorldAutoUpdate=!1,or.add(nr.target),or.add(nr),or.matrixWorldAutoUpdate=!1;const hr=te("uniform vec2 bounds;uniform sampler2D splatting;varying float vYPos;varying vec2 vUv;varying float vCheapAO;\n#include <linear_step>\nvoid main(){float depth=linearstep(bounds.x-0.3,bounds.y,vYPos);vec4 text=texture2D(splatting,vUv);gl_FragColor=vec4(depth*text.r,vCheapAO,depth,1.);}","fragmentShader"),ur=te("attribute float cheapAO;varying vec2 vUv;varying float vYPos;varying float vCheapAO;void main(){vUv=uv;vec4 mvPos=modelMatrix*vec4(position,1.);vYPos=mvPos.y;vCheapAO=cheapAO;gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.);}","vertexShader");let dr=null;class pr extends se{constructor(){super({}),this.uniforms={bounds:{value:new r},splatting:{value:null}},hr.use(this),ur.use(this),this.type="ShaderMaterial",this.isShaderMaterial=!0}}pr.use=function(){return dr=dr||new pr,dr},pr.unuse=function(){};const fr=new yt,mr=new Lt;mr.matrixWorldAutoUpdate=!1;const gr=pr.use(),yr=new et(-100,100,100,-100,.1,1e3);yr.rotation.x=-Math.PI/2;let br,vr,wr,_r=!0;const xr="\nprecision highp float;\nattribute lowp vec2 position;\nuniform vec4 texelSize; // XY = texel size, ZW = half texel size\nuniform float kernel;\nuniform float scale;\nvarying vec2 vUv0;\nvoid main() {\n\tvec2 uv = position.xy * 0.5 + 0.5;\n\tvUv0 = uv;\n\tgl_Position = vec4(position.xy, 0.0, 1.0);\n}\n",Sr="\nprecision highp float;\nuniform lowp sampler2D inputBuffer;\nuniform mediump float blurStrength;\nconst float PI2 = 6.28318530718;\nconst float BLUR_SAMPLES = 10.0;\nvarying vec2 vUv0;\nvec4 blur( sampler2D image, vec2 uv){\n\tvec4 color = texture2D(image, uv);\n\tfor (float d = 0.0; d < PI2; d += PI2 / BLUR_SAMPLES) {\n\t\tcolor.b += texture2D(image, uv + vec2(cos(d), sin(d)) * blurStrength).b;\n\t}\n\tcolor.b /= BLUR_SAMPLES * 1.098;\n\treturn color;\n}\nvoid main() {\n\tvec4 sum = blur(inputBuffer, vUv0); // Top left\n\tgl_FragColor = vec4(sum.rgb, 1.0);\n}\n";function Mr({webgl:e,sceneResources:t,sceneManifest:i}){const o=e.threeRenderer,a=t.base,n=t.textures.grassSplatting,r=!!n;if(fr.min.fromArray(i.bounds[0]),fr.max.fromArray(i.bounds[1]),fr.min.y=parseFloat(ee().WATER_BASE_LEVEL),_r){e.threeRenderer.capabilities.isWebGL2;e.app.$device.type.phone;const t=e=>ba({name:e,depth:!1,width:1024,height:1024,format:Se});br=t("Island Depth A"),vr=t("Island Depth B"),wr=function({useRawShader:e=!0,vertexShader:t,fragmentShader:i,renderer:o,...a}={}){xa||(xa=s()),o=xa.renderer.instance;const n=new(e?J:se)(Object.assign({},{vertexShader:fo,fragmentShader:wa,depthTest:!1,depthWrite:!1,transparent:!0},a));return t&&(t.use?t.use(n):n.vertexShader=t),i&&(i.use?i.use(n):n.fragmentShader=i),_a||(_a=new T(po,n),_a.frustumCulled=!1,_a.matrixAutoUpdate=!1,_a.matrixWorldAutoUpdate=!1),{cam:va,screen:_a,material:n,uniforms:n.uniforms,u:n.uniforms,render(){const e=o.sortObjects,t=o.shadowMap.enabled,s=o.autoclear;o.sortObjects=!1,o.shadowMap.enabled=!1,o.autoclear=!1,_a.material=n,o.render(_a,va),o.sortObjects=e,o.shadowMap.enabled=t,o.autoclear=s}}}({name:"Island Depth Blur",vertexShader:xr,fragmentShader:Sr,uniforms:{inputBuffer:{value:br.texture},blurStrength:{value:2}}}),_r=!1}let l;if(t.depthBounds=fr,t.textures.sceneDepth=br.texture,r&&a&&(l=new T(a,gr),l.frustumCulled=!1,mr.add(l)),r){const e=gr.uniforms;e.bounds.value.set(fr.min.y,fr.max.y),e.splatting.value=n,e.splatting.value.needsUpdate=!0}yr.position.y=fr.max.y+1;const c=(fr.min.x+fr.max.x)/2,h=(fr.min.z+fr.max.z)/2,u=Math.abs(fr.min.x-fr.max.x),d=Math.abs(fr.min.z-fr.max.z);yr.left=-u/2,yr.right=u/2,yr.bottom=-d/2,yr.top=d/2,yr.position.x=c,yr.position.z=h,yr.updateProjectionMatrix();let p=o.getRenderTarget(),f=o.autoClear,m=o.sortObjects;return o.sortObjects=!1,o.autoClear=!1,o.setRenderTarget(br),o.clear(),r?o.render(mr,yr):o.clearColor(),o.setRenderTarget(vr),wr.uniforms.inputBuffer.value=br.texture,wr.uniforms.blurStrength.value=7e-4,wr.render(),o.setRenderTarget(br),wr.uniforms.inputBuffer.value=vr.texture,wr.uniforms.blurStrength.value=8e-4,wr.render(),o.setRenderTarget(p),o.sortObjects=m,o.autoClear=f,Q.bounds.min.value.set(fr.min.x,fr.min.y,fr.min.z),Q.bounds.max.value.set(fr.max.x,fr.max.y,fr.max.z),br.texture.needsUpdate=!0,Q.uIslandDepth.value=br.texture,l&&mr.remove(l),{material:gr,bounds:fr}}async function Tr(e,t,s,i){const o=t.scenes[s.props.id],a=t.manifest.scenes[s.props.id],{material:r}=Mr({webgl:e,sceneResources:o,sceneManifest:a});await new Promise((e=>requestAnimationFrame(e))),function({webgl:e,sceneResources:t,sceneManifest:s,material:i,isRerender:o}){const a=t.base,r=t.chunks;ir.min.fromArray(s.bounds[0]),ir.max.fromArray(s.bounds[1]);let l=[];if(a){const e=new T(a,i);e.onBeforeRender=cr,e.receiveShadow=!0,e.frustumCulled=!1,l.push(e)}if(o||function(e,t){const s=e.actors,i=t.dynamicPropsAllocs,o=t.dynamicPropsVertices;for(let a in s){const e=s[a];for(let s in e.dynamicProps){const a=e.dynamicProps[s];if(!a.asset)continue;const n=!!a.castFarShadow,r=i[e.uid][s],l=o[e.uid][s],c=t.chunks[r.chunk].attributes.position,h=c.array,u=r.start,d=r.start+r.count;let p=!1;if(n)h[u]===l[0]&&h[u+1]===l[1]&&h[d-1]===l[l.length-1]||(h.set(l,u,d),p=!0);else{const e=1e7;h[u]===e&&h[u+1]===e&&h[d-1]===e||(h.fill(e,u,d),p=!0)}p&&(c.needsUpdate=!0)}}}(s,t),r.length)for(let n=0,_=r.length;n<_;n++){const e=r[n],t=new T(e,i);t.onBeforeRender=cr,t.castShadow=!0,t.receiveShadow=!0,t.frustumCulled=!1,l.push(t)}for(let n=0,_=l.length;n<_;n++)or.add(l[n]);ir[0],ir[1];const c=(ir.min.x+ir.max.x)/2,h=(ir.min.z+ir.max.z)/2,u=Math.abs(ir.min.x-ir.max.x),d=Math.abs(ir.min.z-ir.max.z),p=1.2;lr.left=-u/2*p,lr.right=u/2*p+30,lr.bottom=-d/2*p,lr.top=d/2*p,lr.far=200,lr.near=1,lr.fov=50,lr.updateProjectionMatrix();const f=e.store.islands.lights.directional.target;nr.target.position.set(c,0,h);const m=n.get().copy(f).multiplyScalar(60);nr.position.set(c,0,h).add(m),m.release(),function(e=2048,t){t.mapSize.width!==e&&(t.mapSize.width=e,t.mapSize.height=e,t.map&&(t.map.dispose(),t.map=null))}(4096,nr.shadow);const g=e.threeRenderer;nr.shadow.needsUpdate=!0,nr.updateMatrixWorld(),nr.target.updateMatrixWorld();let y=g.autoClear,b=g.sortObjects,v=i.visible;g.sortObjects=!1,g.autoClear=!1,i.visible=!0;let w=g.getRenderTarget();g.setRenderTarget(e.noopRenderTarget),g.render(or,ar),g.setRenderTarget(w),g.sortObjects=b,g.autoClear=y,i.visible=v;for(let n=0,_=l.length;n<_;n++)l[n].onBeforeRender=null,l[n].removeFromParent();t.bigShadowData={texture:rr.map.texture,matrix:rr.matrix,shadowBias:rr.bias,shadowSize:rr.mapSize,shadowRadius:rr.radius,light:nr},sr&&(sr=!1)}({webgl:e,sceneResources:o,sceneManifest:a,material:r})}const Or=[["index",1],["position",3],["uv",2],["normal",3]],Pr=["Int8","Uint8","Uint8Clamped","Int16","Uint16","Int32","Uint32","Float32","Float64"].map((e=>e+"Array"));function Ar(e,t,s){"number"==typeof e&&(e=new Float32Array([e]));const i=e instanceof Uint8Array?e:new Uint8Array(e.buffer);return t.length+=i.length,s?t.list.unshift(i):t.list.push(i),t}function Ir(e,t){return Ar(function(e){return e?Pr.indexOf(e.array.constructor.name)+1:0}(e),t),Ar(e.array.byteLength,t),Ar(e.array,t),t}function Cr(e,t){const s=e.buffer.slice(e.offset,e.offset+t);return e.offset+=t,s}function Rr(e,t){if(0===new Float32Array(Cr(e,4))[0])return;const s=new P,i=new Float32Array(Cr(e,24)),o=new Float32Array(Cr(e,16));s.boundingBox=new yt((new n).fromArray(i,0),(new n).fromArray(i,3)),s.boundingSphere=new h((new n).fromArray(o,0),o[3]);for(let n=0,r=t.length;n<r;n++){const i=t[n],o=i[0],r=i[1],l=new Float32Array(Cr(e,4))[0],c=new Float32Array(Cr(e,4))[0],h=!!(a=l)&&Pr[a-1],u=new window[h](Cr(e,c));1===u.length&&-12345===u[0]||("index"===o?s.setIndex(new O(u,1,!1)):s.setAttribute(o,new O(u,r,!1)))}var a;return s}const kr=".merge.dat",Dr=["base","horizon","propsCollider","groundCollider","chunks","dynamicPropsAllocs"];const Lr={save:async function(e,t,s,{log:i}){const o=s.props.id,a=t.scenes[o];if(!("safari"===e.app.$device.browser)&&!a.useMergeCache){a.useMergeCache=!0;const e={};for(let t=0,i=Dr.length;t<i;t++)e[Dr[t]]=a[Dr[t]];const s=function(e={},{attributes:t}={}){const s={length:0,list:[]},i={data:{}},o={};for(let c in e){const t=e[c];if(Array.isArray(t)||"object"!=typeof t||t.isBufferGeometry)if(Array.isArray(t)){const e=t;for(let t=0,s=e.length;t<s;t++)o["_AR|"+c+"|"+t]=e[t]}else o[c]=t;else i.data[c]=t}e=o;const a=i.keys=Object.keys(e);i.attrs=t=t||Or;const n=(new TextEncoder).encode(JSON.stringify(i));Ar(n.byteLength,s),Ar(n,s);for(let c=0,h=a.length;c<h;c++){const i=e[a[c]];if(!i){Ar(0,s);continue}const o={length:0,list:[]};let n=i.boundingBox;n=new Float32Array(n?[...n.min.toArray(),...n.max.toArray()]:[0,0,0,0,0,0]),Ar(n,o);let r=i.boundingSphere;r=new Float32Array(n?[...r.center.toArray(),r.radius]:[0,0,0,-1]),Ar(r,o);for(let e=0,s=t.length;e<s;e++){const s=t[e][0];let a="index"===s?i.index:i.attributes[s];a||(a={array:new Float32Array([-12345])}),Ir(a,o)}Ar(o.length,s),o.list.forEach((e=>Ar(e,s)))}let r=0;const l=new Uint8Array(s.length);for(let c=0,h=s.list.length;c<h;c++){const e=s.list[c];l.set(e,r),r+=e.byteLength}return l}(e);s&&t.supercache.add(o+kr,s)}},load:async function(e,t,s,i){const o=s.props.id,a=t.scenes[o];if(performance.now(),a.base||a.collider)return;let n=await t.supercache.get(o+kr);const r=n&&function(e){(e=e||new ArrayBuffer).buffer&&(e=e.buffer);const t={buffer:e,offset:0},s=new Float32Array(Cr(t,4))[0],i=Cr(t,s),o=(new TextDecoder).decode(i);let a;try{a=JSON.parse(o)}catch(c){return!1}const n=a.attrs,r=a.keys,l={};if(a.data)for(let h in a.data)l[h]=a.data[h];for(let h=0,u=r.length;h<u;h++){let e=r[h],s=l;if("_AR|"===e.slice(0,4)){const t=e.slice(4).split("|");e=t.pop();const i=t.join("|");l[i]||(l[i]=[]),s=l[i]}try{s[e]=Rr(t,n)}catch(c){return!1}}return l}(n);if(r){for(let e in r)r[e]&&(a[e]=r[e]);a.base&&(a.boundingBox=a.base.boundingBox,a.boundingSphere=a.base.boundingSphere),a.useMergeCache=!0}}};function Er(e,t){const{log:i}=t,o=s(),a=o.resources,r=e.props.id;a.manifest.scenes[r]=a.manifest.scenes[r]||{},a.scenes[r]=a.scenes[r]||{};const l={log:i,timing:!1};return Promise.resolve().then((()=>Lr.load(o,a,e,l))).then((()=>async function(e,t,s,i){const o=qn?e.app.$preloader.task:Gn;qn=!1;const a=s.props.id,r=e.store.biomes,l=r[s.biome]??r.default,c=t.manifest,h=c.scenes[a],u=t.scenes[a];if(!h)return;performance.now();const d=u.base,p=[],f=c.textures,m=l.gradientsTexture??"Assets_Gradients",g=l.splattingPatternsTexture??"SplattingPatterns",y=l.characterTexture??"Character_Texture",b=[];b.push([Wn(En.noise),"noise",{repeat:!0}]),b.push([Wn(En.clouds),"clouds",{repeat:!0}]),b.push([Wn(f.Assets_Data),"assetsData",{nearest:!0}]),b.push([Wn(f[g]),g,{repeat:!0}]),b.push([Wn(f[m]),m,{repeat:!0}]),b.push([Wn(f[y]),y,{premultiplyAlpha:!0}]),"Assets_Gradients"!==m&&b.push([Wn(f.Assets_Gradients),"Assets_Gradients",{}]),p.push(...b.map((e=>{if(!t.textures[e[1]])return o(t.load(e[0],{onLoad:({node:s})=>{t.textures[e[1]]=Fn({img:s,flipY:!1,...e[2]})}}))}))),u.textures=u.textures||{},p.push(...[[Wn(f["Scene_"+a+"_TerrainSplatting"]),"terrainSplatting",{}],[Wn(f["Scene_"+a+"_GrassSplatting"]),"grassSplatting",{red:!0}]].map((e=>o(t.load(e[0]).then((({node:t})=>{u.textures[e[1]]||(u.textures[e[1]]=Fn({img:t,flipY:!1,...e[2]}))})))))),d||p.push(o(t.load(h.url,{onLoad:e=>{for(let t=0;t<e.scene.children.length;t++){const s=e.scene.children[t],i=s.userData.name.toLowerCase(),o=i.split(".")[0],a=s.geometry;if(o.endsWith("horizon"))u.horizon=a;else if(o.endsWith("groundcollider"))u.baseGroundCollider=a;else if(o.endsWith("collider"))u.baseCollider=a;else if(o.endsWith("base")){const e=h.bounds,t=e&&new yt((new n).fromArray(e[0]),(new n).fromArray(e[1]));u.base=a,a.boundingBox||(a.boundingBox=t),a.boundingBox||a.computeBoundingBox(),u.boundingBox=a.boundingBox,u.boundingSphere=a.boundingSphere}else if(o.endsWith("props")){const e=i.endsWith("traversableprops"),t=s.children;u.props||(u.props=[]);for(let s=0;s<t.length;s++){const i=t[s],o=i.scale,a=i.position,n=i.quaternion;u.props.push({asset:i.userData.asset,traversable:!!e,transforms:[a.x,a.y,a.z,o.x,o.y,o.z,n.x,n.y,n.z,n.w]})}}}}})));const v=c.ao[a];v&&p.push(o((async()=>{const e=await t.load(v),s=new Float64Array(e,0,1)[0],i=new Uint8Array(e,8);u.ao={timestamp:s,buffer:i.buffer,data:i}})()));const w=u.dynamicAssets=new Set(e.preloadAssets),_=s.class,x=new Set;if(_.prepare){const e={id:s.props.id,props:s.props},t=_.prepare(e);if(t.preloadAssets)for(let s=0,i=t.preloadAssets.length;s<i;s++)x.add(t.preloadAssets[s]),w.add(t.preloadAssets[s]);t.preload&&p.push(o(t.preload(e)))}const{actorAssets:S,actorStaticAssets:M,prepareActor:T}=Hn(e,a,0,u),O=e.app.$characters.npcs,P=e.app.$characters.colors.coastal;for(let n in h.actors){const e=h.actors[n];let s;if("NPC"===e.type){const t=e.params;let s=t&&t.subtype?t.subtype:"";if(s=s.replace(/\.[0-9]+$/,""),!O[s])continue;const i=O[s];null==i.gradientID&&(i.gradientID=P.gradientID),e.npcConfig=i;const o=i.script;e.className="NPC"+o}else e.className=e.type;s=t.actors[e.className],s&&T(s,e)}S.forEach((e=>{w.add(e)}));const A=[...new Set([...e.preloadAssets,...d?[]:h.assets,...d?[]:M,...x,...S])];for(let C=0,R=A.length;C<R;C++){const e=A[C],s=c.assets[e];s&&!t.assets[e]&&p.push(o(t.load(s.url,{onLoad:s=>{const i=t.assets[e]={};let o=null;for(let e=0;e<s.scene.children.length;e++){const t=s.scene.children[e],a=t.userData.name.split("_");switch(a.shift().split(".")[0].toLowerCase()){case"collider":i.collider=t.geometry;break;case"mesh":i.isMesh=!0,i.mesh=t.clone(),i.geometry=t.geometry;break;case"rawmesh":i.isRawMesh=!0,i.mesh=t.clone();break;case"bounds":const e=a.shift().split("|").map((e=>parseFloat(e)));o=[e.slice(0,3),e.slice(3,6)]}}if(i.geometry){const t=i.geometry;t.boundingBox||(o?t.boundingBox=new yt((new n).fromArray(o[0]),(new n).fromArray(o[1])):t.computeBoundingBox()),t.name=e,i.boundingBox=t.boundingBox,i.boundingSphere=t.boundingSphere}}})))}await Promise.all(p),e.app.$characters.faceColors||(e.app.$characters.faceColors={});const I=e.app.$characters.faceColors;if(!I[l.id]){const e=I[l.id]={};for(let s=0;s<32;s++){let i=897+4*s,o=130;Kn.drawImage(t.textures[y].image,i,o,1,1,0,0,1,1);const[a,n,r]=Kn.getImageData(0,0,1,1).data;e[s]="#"+[a,n,r].map((e=>e.toString(16).toString().padStart(2,0))).join("")}}!u.base&&h.useBaseAsCollider&&(h.useBaseAsCollider=!1)}(o,a,e))).then((()=>new Promise((e=>requestAnimationFrame(e))))).then((()=>async function(e,t,s,i){const o=s.props.id,a=t.manifest,r=t.scenes[o],l=a.scenes[o];if(!l)return;if(performance.now(),!r.points){const e=r.points={};for(const t in l.points||{}){const s=l.points[t];e[t]={position:(new n).fromArray(s,0),scale:(new n).fromArray(s,3),quaternion:(new H).fromArray(s,6)}}}if(!r.curves){const e=r.curves={};for(const t in l.curves||{}){const s=l.curves[t];if(!s)continue;const{type:i,closed:o,points:a}=s;i&&("NURBS"===i?e[t]=Zn(a,{closed:o}):"BEZIER"===i?e[t]=Jn(a,{closed:o}):"POLY"===i&&(e[t]=Qn(a,{closed:o})),e[t]&&(e[t].raw=s))}}if(!r.areas){const e=r.areas={};for(const t in l.areas||{}){const s=l.areas[t],i=(new n).fromArray(s.position),o=s.size;e[t]=new h(i,o)}}const c=!!l.useBaseAsCollider,u=Dt({attributes:["position"]}),d=Dt({attributes:["position"]});let p,f,m,g,y;const b=e.store.chunkDivisor;r.chunks||(p=r.boundingBox.getSize(new n),f=p.x/b,m=p.z/b,g=r.boundingBox.min.x,y=r.boundingBox.min.z);const v=[];function w(e,t){e-=g,t-=y;const s=U(Math.floor(e/f),0,b-1),i=U(Math.floor(t/m),0,b-1);return v[s][i]}for(let n=0;n<b;n++){const e=v[n]=[];for(let t=0;t<b;t++)e[t]=Dt()}if(r.physicsInstancePromise=e.initPhysics(o),await tr(!0),!r.propsCollider){const e=[...l.props,...r.props];for(let s=0,i=e.length;s<i;s++){const i=e[s],o=t.assets[i.asset];if(!o||!o.isMesh)continue;const a=w(i.transforms[0],i.transforms[2]);o.geometry&&!i.colliderOnly&&a.add(o.geometry,i),!o.collider||i.traversable||i.traverse||u.add(o.collider,i),await tr()}}if(await tr(!0),!r.dynamicPropsAllocs){const e=l.actors,s=r.dynamicPropsAllocs={};for(let i in e){const o=e[i],a=o.dynamicProps;if(!a||!Object.keys(a).length)continue;const n=o.transforms,r=s[o.uid]={};for(let e in a){const s=a[e];if(!s.asset)continue;const i=n,o=w(i[0],i[2]),l=t.assets[s.asset].geometry,c=o.getPositionLength(),h=l.attributes.position.array.length;r[e]={chunk:o,start:c,count:h},o.add(l,{transforms:i}),await tr()}}}if(await tr(!0),r.groundCollider||(r.baseGroundCollider&&(d.add(r.baseGroundCollider),await tr()),c&&(d.add(r.base),await tr())),await tr(!0),r.propsCollider||r.baseCollider&&(u.add(r.baseCollider),await tr()),await tr(!0),r.groundCollider||(r.groundCollider=d.merge(),await tr()),await tr(!0),r.propsCollider||(r.propsCollider=u.merge(),await tr()),await tr(!0),!r.chunks){const e=new Map,t=r.chunks=[];for(let s=0;s<v.length;s++){const i=v[s];for(let o=0;o<i.length;o++){const i=v[s][o];let a=i.merge();0!==a.attributes.position.count&&(e.set(i,t.length),t.push(a),await tr())}}for(let s in r.dynamicPropsAllocs){const t=r.dynamicPropsAllocs[s];for(let s in t){const i=t[s];i.chunk=e.get(i.chunk)}}}await tr(!0);const _=r.chunks,x=r.dynamicPropsAllocs;if(!r.dynamicPropsVertices){const e=r.dynamicPropsVertices={};for(let t in x){const s=x[t],i=e[t]={};for(let e in s){const t=s[e],o=_[t.chunk].attributes.position.array,a=t.start+t.count;i[e]=o.slice(t.start,a),await tr()}}}if(r.ao){const e=r.ao.buffer,t=r.base;let s=0;const i=new Float64Array(e,0,1)[0];r.ao.deprecated=i!==a.timestamp,s+=8;const o=new Uint8Array(e,s).length,n=t.attributes.position.count,l=n;if(l<=o&&l>=o-64){const i=new Uint8Array(e,8,n);s+=l,t.attributes.cheapAO=new O(i,1,!0),r.ao.active=!0}else r.ao.active=!1}const S=[];S.push([r.propsCollider,"props"]),S.push([r.groundCollider,"ground"]);for(let n in l.actors){const t=l.actors[n],s={};for(let i in t.dynamicProps){const o=t.dynamicProps[i],a=o.collider;if(!a)continue;const n=t.transformMatrix,r=a+n.elements.join("_");if(s[r]){o.physicsLayer=s[r];continue}const l=t.uid+"_"+i,c=e.resources.assets[a].collider;o.physicsLayer=s[r]=l,S.push([c,l,n])}}if(r.physicsBatchPromise=r.physicsInstancePromise.then((e=>e.addBatch(S))),await tr(!0),!window.isBaking)for(let n in e.resources.assets)r.dynamicAssets.has(n)||(e.resources.assets[n]=null)}(o,a,e))).then((()=>new Promise((e=>requestAnimationFrame(e))))).then((()=>Lr.save(o,a,e,l))).then((()=>new Promise((e=>requestAnimationFrame(e))))).then((()=>Tr(o,a,e))).then((()=>new Promise((e=>requestAnimationFrame(e))))).catch((e=>{}))}const Fr={};Fr.default={gradientsTexture:"Assets_Gradients",splattingPatternsTexture:"SplattingPatterns",characterTexture:"Character_Texture",defines:{FOG_FAR_MULT:Ut(1),SKY_TOP_COLOR:zt(new V("#3fdefa")),SKY_BOTTOM_COLOR:zt(new V("#cafced")),SKY_HORIZON_FADE:Ut(.49),SKY_HORIZON_STRENGTH:Ut(.5),SKY_CLOUDS_ALPHA:Ut(1),SKY_CLOUDS_MULT:Bt(1,1,1),CLOUDS_COLOR:Bt(2.1,1.8,1.3),WATER_TOP_COLOR:zt(new V("#3fbfff")),WATER_COLOR:zt(new V("#6db6e4")),UNDERWATER_MULT:Ut(.8),FOG_FAR:zt(new V("#91f5f3")),FOG_NEAR:zt(new V("#b868a6")),SHADOW_COLOR:zt(new V("#0013a5")),RIM_COLOR:Bt(.9,1,.4),CHAR_RIM_COLOR:Bt(1.2,1,.6),GRASS_BOTTOM_COLOR:zt(new V("#40bb58")),GRASS_TOP_COLOR:zt(new V("#79d474")),TERRAIN_BASE_COLOR:zt(new V("#84cf89")),TERRAIN_BASE_NUANCE_COLOR:zt(new V("#68f690")),TERRAIN_HIGHGRASS_COLOR:zt(new V("#56ae5f")),TERRAIN_PAVE_COLOR:zt(new V("#9da8ad")),TERRAIN_ROAD_COLOR:zt(new V("#b8c4c1")),TERRAIN_SAND_LIGHT_COLOR:zt(new V("#fbf2b1")),TERRAIN_SAND_DARK_COLOR:zt(new V("#ffcb53")),FAKE_AO_MULT:Bt(2.2,2,1.1),AO_MULT_BOTTOM_TINT:Bt(0,.1,.2),AO_MULT_UP_TINT:Bt(1.02,1.09,1),AO_ILLUM_LOW:Ut(1.15),AO_ILLUM_HIGH:Ut(1.8),ISLAND_AO_SUB:Ut(.5),IS_BIOME_DEF_ISLAND:!0}},Fr.intro={...Fr.default,defines:{...Fr.default.defines,AO_ILLUM_LOW:Ut(1.05),AO_ILLUM_HIGH:Ut(1.3),ISLAND_AO_SUB:Ut(.7),TERRAIN_BASE_COLOR:zt(new V("#85e68b")),TERRAIN_HIGHGRASS_COLOR:zt(new V("#49c555")),TERRAIN_SAND_LIGHT_COLOR:zt(new V("#fff5a7")),TERRAIN_SAND_DARK_COLOR:zt(new V("#ffc534"))}},Fr.bike={...Fr.default,defines:{...Fr.default.defines,AO_ILLUM_LOW:Ut(1.05),AO_ILLUM_HIGH:Ut(1.2),ISLAND_AO_SUB:Ut(.6),TERRAIN_BASE_COLOR:zt(new V("#80d486")),TERRAIN_HIGHGRASS_COLOR:zt(new V("#50ba5b")),TERRAIN_SAND_LIGHT_COLOR:zt(new V("#ceb47f"))}},Fr.car={...Fr.default,defines:{...Fr.default.defines,AO_ILLUM_LOW:Ut(1.16),AO_ILLUM_HIGH:Ut(1.68),FOG_FAR_MULT:Ut(1.6)}},Fr.sunfall={...Fr.default,gradientsTexture:"Assets_Gradients_Sunfall",splattingPatternsTexture:"SplattingPatterns_Sunfall",characterTexture:"Character_Texture_Sunfall",defines:{...Fr.default.defines,AO_ILLUM_LOW:Ut(1.1),AO_ILLUM_HIGH:Ut(1.5),AO_MULT_BOTTOM_TINT:Bt(.2,-.1,.1),AO_MULT_UP_TINT:Bt(1.04,1,1.07),SKY_TOP_COLOR:zt(new V("#ff94ca")),SKY_BOTTOM_COLOR:zt(new V("#fff8c0")),SKY_HORIZON_FADE:Ut(.475),SKY_HORIZON_STRENGTH:Ut(.8),SKY_CLOUDS_ALPHA:Ut(.84),SKY_CLOUDS_MULT:Bt(1.7,1,.9),CLOUDS_COLOR:Bt(...new n(1.4,2.2,1.9).multiplyScalar(.7).toArray()),WATER_TOP_COLOR:zt(new V("#4189fd")),WATER_COLOR:zt(new V("#7992ff")),UNDERWATER_MULT:Ut(1),FOG_FAR:zt(new V("#fcbdff")),FOG_NEAR:zt(new V("#8370ff")),SHADOW_COLOR:zt(new V("#7f40be")),RIM_COLOR:Bt(1.1,.7,.7),CHAR_RIM_COLOR:Bt(1.2,.5,.7),GRASS_BOTTOM_COLOR:zt(new V("#81bf51")),GRASS_TOP_COLOR:zt(new V("#c2d88b")),TERRAIN_BASE_COLOR:zt(new V("#c2d88b")),TERRAIN_BASE_NUANCE_COLOR:zt(new V("#81bf51")),TERRAIN_HIGHGRASS_COLOR:zt(new V("#72aa54")),TERRAIN_PAVE_COLOR:zt(new V("#fcd37c")),TERRAIN_ROAD_COLOR:zt(new V("#fcd37c")),TERRAIN_SAND_LIGHT_COLOR:zt(new V("#ffef9f")),TERRAIN_SAND_DARK_COLOR:zt(new V("#ffcb5a")),FAKE_AO_MULT:Bt(1.12,1.6,1.3),IS_BIOME_DEF_ISLAND:!1,ISLAND_AO_SUB:Ut(.55)}},Fr.testlab={...Fr.default,disableWind:!0,defines:{...Fr.default.defines,TESTLAB_GRID_SCALE:Ut(5),TESTLAB_GRID_ALPHA:Ut(.5),TESTLAB_GRAY:zt(new V("#8b8b8b")),FOG_FAR:zt(new V("#8b8b8b")),FOG_NEAR:zt(new V("#8b8b8b")),RIM_COLOR:Bt(.5,.5,.5),CHAR_RIM_COLOR:Bt(.5,.5,.5),CLOUDS_COLOR:Bt(0,0,0),SHADOW_COLOR:zt(new V("#7f7d91")),FAKE_AO_MULT:Bt(1.8,1.8,1.8),IS_BIOME_DEF_ISLAND:!1,AO_MULT_BOTTOM_TINT:Bt(.45,.5,.9),AO_MULT_UP_TINT:Bt(1,1,1),AO_ILLUM_LOW:Ut(1.1),AO_ILLUM_HIGH:Ut(1.5),ISLAND_AO_SUB:Ut(.4)}};for(let Nu in Fr){const e=Fr[Nu];e.id=Nu;for(let t in Fr)e.defines["IS_BIOME_"+t.toUpperCase()]=!1;e.defines["IS_BIOME_"+Nu.toUpperCase()]=!0}const Ur=new n,zr=new n,Br=new Ht,Nr=new Wt,jr=new h,Vr=new Gt,Hr=[],Wr=e=>({array:Hr,size:0,reset(){return this.size=0,this.array.length=0,this},add(e){return this.array.push(e),this.size++,this},has(e){return-1!==this.array.indexOf(e)}}),Gr=Wr(),qr=Wr(),Yr=[[null,null],[null,null],[null,null]];function Kr(){this.depth=0,this.hit=!1,this.normal=new n,this.angle=0,this.triangle=null,this.layerID=0}class Xr{constructor({maxSize:e=8,maxLevel:t=16,boundingBox:s=null,layers:i={all:new Set,enabled:new Set}}){this.maxSize=e,this.maxLevel=t,this.boundingBox=s,this.layers=i,this.bounds=new yt,this.triangles=new Array,this.subTrees=new Array}updateBoundingBox(){return this.boundingBox=this.bounds.clone(),this.boundingBox.min.x-=.01,this.boundingBox.min.y-=.01,this.boundingBox.min.z-=.01,this}split(e,t){if(t.boundingBox){const s=new Array,i=zr.copy(t.boundingBox.max).sub(t.boundingBox.min).multiplyScalar(.5);for(let a=0;a<2;a++)for(let o=0;o<2;o++)for(let n=0;n<2;n++){const r=new yt;r.min.copy(t.boundingBox.min).add(Ur.set(a,o,n).multiply(i)),r.max.copy(r.min).add(i),s.push({level:e,triangles:new Array,subTrees:new Array,boundingBox:r})}let o=null;for(;o=t.triangles.pop();)for(let e=0;e<s.length;e++){const t=s[e];t.boundingBox.intersectsTriangle(o.triangle)&&t.triangles.push(o)}for(let a=0;a<s.length;a++){const i=s[a],o=i.triangles.length;o>this.maxSize&&e<this.maxLevel&&this.split(e+1,i),0!==o&&t.subTrees.push(i)}}return this}build(){return this.updateBoundingBox(),this.split(0,this),this}getRayTriangles(e,t,s,i){for(let o=0;o<e.subTrees.length;o++){const a=e.subTrees[o];if(t.intersectsBox(a.boundingBox))if(a.triangles.length>0)for(let e=0;e<a.triangles.length;e++){const t=a.triangles[e];i&&i!==t.layerID||s.has(t)||s.add(t)}else this.getRayTriangles(a,t,s,i)}return s}triangleSphereIntersect(e,t){const s=t.triangle;e._shIntersectDt||(e._shIntersectDt={normal:new n,depth:0});const i=e._shIntersectDt;if(s.getPlane(Br),!e.intersectsPlane(Br))return!1;if(s.containsPoint(e.center))return i.normal.copy(Br.normal),i.depth=Math.abs(Br.distanceToSphere(e)),i;const o=Yr;o[0][0]=s.a,o[0][1]=s.b,o[1][0]=s.b,o[1][1]=s.c,o[2][0]=s.c,o[2][1]=s.a;const a=Math.abs(Br.distanceToSphere),r=e.radius*e.radius-a*a,l=Br.projectPoint(e.center,Ur);for(let n=0;n<o.length;n++){Nr.set(o[n][0],o[n][1]),Nr.closestPointToPoint(l,!0,zr);const t=zr.distanceToSquared(e.center);if(t<r)return i.normal.copy(e.center).sub(zr).normalize(),i.depth=e.radius-Math.sqrt(t),i}return!1}getSphereTriangles(e,t,s){for(let i=0;i<e.subTrees.length;i++){const o=e.subTrees[i];if(t.intersectsBox(o.boundingBox))if(o.triangles.length>0)for(let e=0;e<o.triangles.length;e++){const t=o.triangles[e];this.layers.enabled.has(t.layerID)&&(s.has(t)||s.add(t))}else this.getSphereTriangles(o,t,s)}}sphereIntersect(e,t,s=2*Math.PI){jr.copy(e);const i=Gr;i.reset(),e._intersectData||(e._intersectData={hits:new Array,layers:new Set,isOnFloor:!1,orientation:new n,smallestAngle:Infinity,distanceFromFloor:0});const o=e._intersectData;o.orientation.setScalar(0),o.smallestAngle=Infinity,o.isOnFloor=!1,o.layers.clear(),o.distanceFromFloor=0,this.getSphereTriangles(this,e,i);let a=0;for(let n=0;n<i.size;n++){const r=i.array[n],l=this.triangleSphereIntersect(jr,r);if(l){const i=a++;o.hits[i]||(o.hits[i]=new Kr);const n=o.hits[i],c=t.angleTo(l.normal);c<=s&&c<o.smallestAngle&&(o.smallestAngle=c,o.orientation.add(l.normal).normalize()),jr.center.add(l.normal.multiplyScalar(l.depth)),n.hit=!0,n.normal.copy(jr.center).sub(e.center),n.depth=n.normal.length(),n.triangle=r.triangle,n.layerID=r.layerID,n.angle=c,n.normal.y>0&&(o.isOnFloor=!0),o.layers.add(r.layerID)}}for(let n=a;n<o.hits.length;n++)o.hits[n]&&(o.hits[n].hit=!1);if(!o.isOnFloor){Vr.set(jr.center,Ur.set(0,-1,0));const e=this.rayIntersect(Vr.ray);o.distanceFromFloor=Math.max(.15,e.distance)}return o}rayIntersect(e,t){if(e.position||(e.position=new n),e._castObject||(e._castObject={distance:1e100,triangle:null,position:new n}),e.direction.length()>0){const s=qr;s.reset();let i=1e100;this.getRayTriangles(this,e,s,t);for(let t=0;t<s.size;t++){const o=s.array[t],a=e.intersectTriangle(o.triangle.a,o.triangle.b,o.triangle.c,!0,Ur);if(a){const t=a.sub(e.origin).length();i>t&&(e.position.copy(a).add(e.origin),e._castObject.position.copy(e.position),e._castObject.distance=t,e._castObject.triangle=o,i=t)}}return i<1e100&&e._castObject}return null}add(e,t,s){this.layers.all.has(s)||(this.layers.all.add(s),this.layers.enabled.add(s));for(let i=0;i<e.count;i+=3){const o=(new n).fromBufferAttribute(e,i),a=(new n).fromBufferAttribute(e,i+1),r=(new n).fromBufferAttribute(e,i+2);o.applyMatrix4(t),a.applyMatrix4(t),r.applyMatrix4(t);const l=new Vt(o,a,r),{min:c,max:h}=this.bounds;Object.assign(c,{x:Math.min(c.x,o.x,a.x,r.x),y:Math.min(c.y,o.y,a.y,r.y),z:Math.min(c.z,o.z,a.z,r.z)}),Object.assign(h,{x:Math.max(h.x,o.x,a.x,r.x),y:Math.max(h.y,o.y,a.y,r.y),z:Math.max(h.z,o.z,a.z,r.z)}),this.triangles.push({triangle:l,layerID:s})}}toggleLayer(e,t=null){if(this.layers.all.has(e)){const s=null!==t?t:!this.layers.enabled.has(e);this.layers.enabled[s?"add":"delete"](e)}}}const $r=new n(0,1,0),Zr=new n,Jr=new n,Qr=new l,el=new qt,tl=new H,sl=new Gt;class il extends h{constructor(e){super(new n(0,0,0),e),Object.assign(this,{previousPosition:new n,absoluteMove:!0,mass:1,speed:1,drift:!1,driftFactor:.005,bounce:!1,forceLerp:!1,force:new n,forceTarget:new n,forceInput:new n,lastForce:new n,stearingSpeed:1,reverseBackwardStearing:!1,velocity:new n,appliedVelocity:0,rotation:new qt(0,0,0,"YXZ"),rotationTarget:new qt(0,0,0,"YXZ"),alignOnNormal:!1,isOnFloor:!1,distanceFromFloor:0,wasOnFloor:!1,moveToFloor:!1,teleportIfOutOfBounds:!1,isCollidingGround:!1,isCollidingProps:!1,laps:1,currentLap:1,progress:0,previousProgress:0,validatedProgress:0,furthestProgress:0,completeProgress:!1,nextChekpoint:.1,isReverse:!1}),this.serializedData={position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},force:{x:0,y:0,z:0},distanceFromFloor:0,isOnFloor:!1,velocity:0,speed:0,isCollidingProps:!1,progress:{reverse:!1,current:0,validated:0,furthest:0,complete:!1},still:!0},this.takeOver={active:!1,prevActive:!1,position:new n,rotation:new qt(0,0,0,"YXZ")}}get data(){const e=this.serializedData,t=e.position;t.x=this.position.x,t.y=this.position.y,t.z=this.position.z;const s=e.rotation;s.x=this.rotation.x,s.y=this.rotation.y,s.z=this.rotation.z;const i=e.force;i.x=this.force.x,i.y=this.force.y,i.z=this.force.z,e.distanceFromFloor=this.distanceFromFloor,e.isOnFloor=this.isOnFloor,e.velocity=0===this.speed?0:this.appliedVelocity/this.speed,e.speed=this.speed,e.isCollidingProps=this.isCollidingProps;const o=e.progress;return o.reverse=this.isReverse,o.current=this.progress,o.validated=this.validatedProgress,o.furthest=this.furthestProgress,o.complete=this.completeProgress,e.still=this.appliedVelocity<1e-4,e}get position(){return this.center}set absoluteMove(e){this._absoluteMove=e,this.updateControls=this._absoluteMove?this.absoluteUpdateControls:this.relativeUpdateControls}get absoluteMove(){return this._absoluteMove}move(e,t,s){this.forceInput.setX(e),this.forceInput.setZ(s),this.forceInput.length()>0&&this.lastForce.copy(this.forceInput),this.isOnFloor&&t&&(this.velocity.y=15,this.forceInput.setY(0))}updateVelocity(e,t){if(this.takeOver.active!==this.takeOver.prevActive&&(this.takeOver.prevActive=this.takeOver.active,this.lastForce.set(0,0,-1),this.force.set(0,0,0),this.forceTarget.set(0,0,0),this.velocity.set(0,0,0)),this.takeOver.active)return this.position.copy(this.takeOver.position),void this.rotation.copy(this.takeOver.rotation);let s=Math.exp(-4*t)-1;this.isOnFloor||(this.velocity.y-=e*t),this.velocity.addScaledVector(this.velocity,s),Zr.copy(this.velocity).multiplyScalar(t),this.translate(Zr)}updateCollisions(e,t){const s=e.sphereIntersect(this,Zr.set(0,1,0),.25*Math.PI),{hits:i,orientation:o,isOnFloor:a,distanceFromFloor:n,layers:r}=s;if(this.distanceFromFloor=n,this.isCollidingProps=r.has("props"),this.isCollidingGround=r.has("ground"),this.wasOnFloor=this.isOnFloor,this.isOnFloor=a,!this.takeOver.active){for(let e=0;e<i.length;e++){const t=i[e];if(!t.hit)break;"ground"!==t.layerID&&(this.force.z*=.98),Zr.copy(t.normal),this.isOnFloor||this.velocity.addScaledVector(Zr,-Zr.dot(this.velocity)),t.angle>.45*Math.PI&&Zr.setY(0),Zr.multiplyScalar(t.depth),this.translate(Zr)}if(this.alignOnNormal&&a){const e=o.applyAxisAngle(Zr.set(0,1,0),Math.PI/2);Zr.setFromEuler(this.rotationTarget).lerp(e,20*t),this.rotationTarget.x=Zr.x,this.rotationTarget.z=Zr.z}}}updateRotation(){this.takeOver.active||(Zr.setFromEuler(this.rotationTarget),Jr.setFromEuler(this.rotation).lerp(Zr,this.drift?this.driftFactor:1),this.rotation.setFromVector3(Jr))}updateCurveProgress(e){if(e&&e.progress){this.progress=e.progress.getClosestProgress(this.position),this.isReverse=this.progress<this.previousProgress,this.progress>=this.nextChekpoint-.1&&this.progress<=this.nextChekpoint?(this.validatedProgress=this.progress,this.validatedProgress>this.furthestProgress&&(this.furthestProgress=this.validatedProgress)):this.progress>=this.nextChekpoint&&this.progress<this.nextChekpoint+.1&&(this.nextChekpoint=Math.min(1,this.nextChekpoint+.1));const t=~~(10*this.progress)/10,s=this.furthestProgress>=.99&&0===t;this.completeProgress=1==this.validatedProgress||s,this.previousProgress=this.progress,this.completeProgress&&this.currentLap<this.laps&&(this.currentLap++,this.progress=0,this.validatedProgress=0,this.furthestProgress=0,this.previousProgress=0,this.completeProgress=!1,this.nextChekpoint=.1)}}absoluteUpdateControls(e){this.force.z=this.forceTarget.z,this.force.x=this.forceTarget.x;const t=e.getWorldDirection(Jr),s=Zr.copy(t).normalize().multiplyScalar(-this.force.z).add(t.normalize().cross(e.up).multiplyScalar(this.force.x));this.force.copy(s),this.force.y=0;let i=Math.PI+Math.atan2(this.lastForce.x,this.lastForce.z)+Math.atan2(e.worldPosition.x-this.position.x,e.worldPosition.z-this.position.z);Math.abs(i-this.rotation.y)>Math.PI&&(i-=2*Math.PI),this.rotationTarget.y=i,this.rotation.y=i,Jr.copy(this.force).multiplyScalar(this.speed),this.velocity.setX(Jr.x).setZ(Jr.z)}relativeUpdateControls(e,t,s,i){i&&this.updateCurveProgress(t),this.force.z+=(this.forceTarget.z-this.force.z)/this.mass*(1e3*s),this.force.x=this.forceTarget.x;const o=this.reverseBackwardStearing?this.force.z<=.01?1:-1:1,a=this.rotationTarget.y+-this.force.x*o*(this.stearingSpeed*s*Math.PI*2),n=this.rotationTarget.y+(a-this.rotationTarget.y);this.rotationTarget.y=n,Zr.set(0,0,this.force.z).applyEuler(this.rotation).multiplyScalar(this.speed),this.velocity.setX(Zr.x).setZ(Zr.z)}update(e,t,s,i,o,a){if(this.takeOver.active)this.updateCollisions(e,o);else{if(!e.boundingBox.containsPoint(this.position)&&this.teleportIfOutOfBounds&&this.respawn(),this.moveToFloor){this.moveToFloor=!1,sl.set(this.position,Zr.set(0,-1,0));const t=e.rayIntersect(sl.ray);t&&this.position.copy(t.position)}this.forceTarget.lerp(this.forceInput,this.forceLerp||1),this.updateControls(t,s,o,a),this.updateCollisions(e,o),this.updateRotation()}}storePreviousPosition(){this.previousPosition.copy(this.position)}computeAppliedVelocity(e){this.appliedVelocity=e>0?Zr.subVectors(this.position,this.previousPosition).length()/e:0}respawn(e,t=!0,s=!0,i=!1){t?(this.currentLap=1,this.progress=this.previousProgress=this.validatedProgress=this.furthestProgress=0,this.nextChekpoint=.1,this.teleport(this.spawnPosition,this.spawnRotation,s,i,e)):this.teleport(this.position,this.rotation,s,i,e)}teleport(e,t,s=!0,i=!1,o){if(this.moveToFloor=i,this.position.copy(e),this.rotation.copy(t),this.rotationTarget.copy(this.rotation),this.lastForce.set(0,0,-1),s&&(this.force.set(0,0,0),this.forceTarget.set(0,0,0),this.velocity.set(0,0,0)),o&&o.progress){const e=o.progress.getClosestProgress(this.position);o.progress.getPoint(e,Zr),this.position.copy(Zr),o.progress.getDirection(e,.01,Zr),il.getEulerFromDirection(Zr,el),this.rotation.y=this.rotationTarget.y=el.y}}static getEulerFromDirection(e,t){return Qr.lookAt(Jr.setScalar(0),Zr,$r),tl.setFromRotationMatrix(Qr),t.setFromQuaternion(tl,"YXZ")}}const ol=new Gt;new qt;const al=new H,nl=new n,rl=new n,ll=new n,cl=new n;function hl(e,t,s){return e*(1-s)+t*s}class ul extends Oe{constructor(){super(),this.rotation.reorder("YXZ"),Object.assign(this,{mode:Yt.FREE,target:new n,worldPosition:new n,previousPosition:new n,worldDirection:new n,previousDirection:new n,distance:5,elevation:2.5,offset:new n,slideFactor:0,lerpFactor:1,curveFocus:.5,curveLookAhead:.05,intersectGround:!1,intersectObjects:!1}),this.serializedData={position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},still:!1},this.takeOver={active:!1,prevActive:!1,position:new n,rotation:new qt,easeIn:.05,easeOut:.01,mix:0},this.takeOver.rotation.order="YXZ"}get data(){const e=nl.copy(this.worldPosition).sub(this.previousPosition).length(),t=nl.copy(this.worldDirection).sub(this.previousDirection).length(),s=this.serializedData;return s.position.x=this.worldPosition.x,s.position.y=this.worldPosition.y,s.position.z=this.worldPosition.z,s.rotation.x=this.rotation.x,s.rotation.y=this.rotation.y,s.rotation.z=this.rotation.z,s.still=e+t<=1e-4,s}set mode(e){Object.values(Yt).includes(e)&&(this._mode=e,e===Yt.NONE?this.updateMode=()=>{}:e===Yt.FREE?this.updateMode=this.updateFreeAroundPlayer:e===Yt.STICKY?this.updateMode=this.updateStickyToPlayer:e===Yt.FOLLOW_CURVE&&(this.updateMode=this.updateFollowingCurve))}updateFreeAroundPlayer(e,t,s,i){const o=t.forceTarget.x*Math.abs(t.absoluteMove||t.forceTarget.z)*(t.reverseBackwardStearing?-t.forceTarget.z:1)*(100*i);nl.copy(t.position).add(this.offset),rl.copy(this.target).lerp(nl,.4),this.lookAt(rl),this.target.copy(rl);let a=t.position.y,n=this.distance;if(nl.copy(this.position).sub(t.position),rl.copy(nl).applyAxisAngle(ll.set(0,1,0),-Math.PI*this.slideFactor*o).add(t.position),this.position.copy(rl),this.intersectObjects){ol.set(t.position,nl);const s=e.rayIntersect(ol.ray);n=s&&s.distance<this.distance?s.distance:this.distance}if(this.intersectGround){ol.set(nl.copy(this.worldPosition).setY(e.boundingBox.max.y+1),rl.set(0,-1,0));const t=e.rayIntersect(ol.ray,"ground"),s=e.boundingBox.max.y+1-t.distance;s>a&&(a=s)}a+=this.elevation;const r=nl.copy(this.position).setY(t.position.y).distanceTo(t.position)-n;this.position.addScaledVector(this.worldDirection,r*this.lerpFactor),this.position.setY(this.position.y+.5*(a-this.position.y))}updateStickyToPlayer(e,t){nl.set(0,0,1).applyAxisAngle(rl.set(0,1,0),t.rotation.y).multiplyScalar(this.distance).add(t.position),nl.y+=this.elevation,this.position.lerp(nl,this.lerpFactor),this.lookAt(t.position)}updateFollowingCurve(e,t,s){const i=s.progress.getClosestProgress(t.position,this.curveLookAhead);s.lookAt.getPoint(i,nl),rl.copy(nl).setY(t.position.y+this.elevation),ll.subVectors(t.position,rl).setY(0),cl.copy(ll).normalize(),ll.add(rl).add(cl.multiplyScalar(this.distance)),this.position.lerp(ll,.05),nl.lerp(t.position,this.curveFocus),rl.copy(this.target).lerp(nl,.1),this.lookAt(rl),this.target.copy(rl)}update(e,t,s,i){this.previousPosition.copy(this.worldPosition),this.previousDirection.copy(this.worldDirection),this.takeOver.active?this.takeOver.mix=hl(this.takeOver.mix,1,this.takeOver.easeIn):this.takeOver.mix=hl(this.takeOver.mix,0,this.takeOver.easeOut),this.getWorldPosition(this.worldPosition),this.getWorldDirection(this.worldDirection),this.updateMode(e,t,s,i),this.takeOver.mix>1e-4&&(al.setFromEuler(this.takeOver.rotation),this.position.lerp(this.takeOver.position,this.takeOver.mix),this.quaternion.slerp(al,this.takeOver.mix))}respawn(e){this.rotation.set(e.rotation.x,e.rotation.y,e.rotation.z),this.position.copy(e.position),this.target.copy(e.position),this.updateMatrixWorld(),this.getWorldPosition(this.worldPosition),this.getWorldDirection(this.worldDirection)}}const dl=0,pl=1,fl=2,ml=3;function gl(){let e=30;const t=new Xr({maxLevel:5,maxSize:16}),s=new Zt,i=new ul,o=new il(.35);Object.assign(o,{curveLookAhead:.01,curveFocus:.5,spawnPosition:new n,spawnRotation:new qt});const a=new Object,r=new Kt;let l=!1,c={type:null,data:null,messageID:null};function h(e,t,s){c.type=e,c.data=t,c.messageID=s,p.emit("message",JSON.stringify(c))}let u={canPause:!1,player:null,camera:null,spheres:null};const d=new $t,p=new $t;function f(){const n=Math.min(.05,s.getDelta()),c=n/5;o.storePreviousPosition(),o.updateVelocity(e,n);for(let s=0;s<5;s++)o.update(t,i,a,e,c,4===s),r.update(t,o,e,c);o.computeAppliedVelocity(n),i.update(t,o,a,n);const h=o.data,d=i.data;return u.canPause=l&&h.still&&d.still,u.player=h,u.camera=d,u.spheres=r.data,u}function m(e,t){for(let s in t)void 0!==t[s].x?e[s].copy(t[s]):e[s]=t[s]}return d.on("message",(s=>{let n=s;"string"==typeof n&&(n=JSON.parse(n));let c=null;if(n===pl)return i.takeOver.active=o.takeOver.active=!1,c=f(),void h("update",c);if(n[0]===fl)return i.takeOver.active=o.takeOver.active=!1,o.move(n[1],n[2],n[3]),c=f(),void h("update",c);if(n[0]===ml)return i.takeOver.active=o.takeOver.active=!0,o.takeOver.position.fromArray(n,1),o.takeOver.rotation.set(n[4],n[5],n[6]),i.takeOver.position.fromArray(n,7),i.takeOver.rotation.set(n[10],n[11],n[12]),i.takeOver.easeIn=n[13],i.takeOver.easeOut=n[14],c=f(),void h("update",c);const{type:u,data:d,messageID:p}=n;"set-gravity"===u?e=d:"toggle-layer"===u?t.toggleLayer(d.layerID,d.force):"set-player-options"===u?m(o,d):"toggle-pause"===u?l=!!d:"set-camera-options"===u?m(i,d):"respawn-player"===u?(o.respawn(a,d.reset,d.resetForces,d.moveToFloor),i.respawn(o)):"add-sphere"===u?r.add(d,t):"stop-sphere"===u?r.stop(d.id,d.value):"cull-sphere"===u?r.cull(d.id,d.value):"add-batch"===u?function(e){for(const{array:s,itemSize:i,normalized:o,layerID:a,matrix:n}of e)if(s.length){const e=new O(s,i,o);t.add(e,n,a)}t.build()}(d):"add-curve"===u&&(a[d.name||"curve"]=new Xt(d.points,d.divisions)),h(u,c,p)})),{addEventListener:p.on.bind(p),removeEventListener:p.off.bind(p),postMessage:d.emit.bind(d,"message"),terminate:()=>{l=!1}}}const yl=function(e){const t=new Array;return function e(t,s,i=null){s(t,i,t);for(let o in t){let a=t[o];a instanceof Object?e(a,s,o):s(a,i,t)}}(e,(e=>{(function(e){try{return e instanceof ArrayBuffer||e instanceof MessagePort||e instanceof ImageBitmap||e instanceof OffscreenCanvas}catch(t){return!1}})(e)&&t.push(e)})),t};class bl{constructor(e){return Object.assign(this,{log:e,running:!1,animationFrame:null,messageID:0,events:new Array,_moveDirection:new n,_playerPosition:new n,_playerRotation:new qt(0,0,0,"XZY"),_playerForce:new n(0,0,0,"XZY"),playerVelocity:0,playerSpeed:0,playerDistanceFromFloor:0,playerIsReverse:!1,_cameraPosition:new n,_cameraRotation:new qt(0,0,0,"YXZ"),_curveProgress:{current:0,validated:0,furthest:0,reverse:!1},spheres:new Array}),this.synchronize=this.synchronize.bind(this),this.onMessage=this.onMessage.bind(this),this.playerMoveData=new Float64Array([dl,0,0,0]),this.takeOver={active:!1,data:new Float64Array(15),player:new L,camera:new L},this.takeOver.player.matrixAutoUpdate=!1,this.takeOver.player.rotation.order="YXZ",this.takeOver.camera.rotation.order="YXZ",this.takeOver.camera.easeIn=this.takeOver.camera.easeOut=.05,this.takeOver.data[0]=ml,this.generate()}async generate(){return this.thread=gl(),this.thread.addEventListener("message",this.onMessage),await this.send("setup"),this.log("ready"),this}get playerPosition(){return this._playerPosition}get playerRotation(){return this._playerRotation}get playerForce(){return this._playerForce}get cameraPosition(){return this._cameraPosition}get cameraRotation(){return this._cameraRotation}get curveProgress(){return this._curveProgress}getSpherePosition(e){return this.spheres[e].position}toggleTakeOver(e,t={}){if(e||!t.uid||t.uid===this.takeOver.uid)return this.takeOver.active=e,this.takeOver.active?(this.takeOver.uid=t.uid,this.takeOver.callback=t.onUpdate,this.takeOver.player.position.copy(this._playerPosition),this.takeOver.player.rotation.copy(this._playerRotation),this.takeOver.player.rotation.y+=Math.PI,this.takeOver.camera.position.copy(this._cameraPosition),this.takeOver.camera.rotation.copy(this._cameraRotation),this.takeOver.camera.easeIn=t.cameraEaseIn??.05,this.takeOver.camera.easeOut=t.cameraEaseOut??.01):this.takeOver.callback=null,this.takeOver}run(){this.running||(this.log("running"),this.running=!0,ue.add(this.synchronize))}stop(){this.log("stop"),this.running=!1,ue.remove(this.synchronize)}standby(){this.slowedDown||(this.log("slow down"),this.slowedDown=!0,ue.remove(this.synchronize))}recover(){this.slowedDown&&(this.log("speed up"),this.slowedDown=!1,ue.add(this.synchronize))}onMessage(e){const{type:t,data:s}=JSON.parse(e);"update"===t&&(this.physicsData=s,this.physicsData.canPause?this.standby():this.recover(),this.update())}synchronize(){if(this.takeOver.active){const e=this.takeOver.data;this.takeOver.player.position.toArray(e,1),e[4]=this.takeOver.player.rotation.x,e[5]=this.takeOver.player.rotation.y-Math.PI,e[6]=this.takeOver.player.rotation.z,this.takeOver.camera.position.toArray(e,7),e[10]=this.takeOver.camera.rotation.x,e[11]=this.takeOver.camera.rotation.y,e[12]=this.takeOver.camera.rotation.z,e[13]=this.takeOver.camera.easeIn,e[14]=this.takeOver.camera.easeOut,this.thread.postMessage(e)}else this.playerMoveData[0]===fl?(this.thread.postMessage(JSON.stringify(this.playerMoveData)),this.playerMoveData[0]=dl):this.thread.postMessage(pl)}update(){const{physicsData:e}=this;if(e){this._playerRotation.setFromVector3(e.player.rotation),this._playerPosition.copy(e.player.position),this._playerForce.copy(e.player.force),this.playerVelocity=e.player.velocity,this.playerSpeed=e.player.speed,this.playerIsCollidingGround=e.player.isCollidingGround,this.playerIsCollidingProps=e.player.isCollidingProps,this.playerDistanceFromFloor=e.player.distanceFromFloor||0,this._cameraPosition.copy(e.camera.position),this._cameraRotation.setFromVector3(e.camera.rotation),this._curveProgress.current=e.player.progress.current,this._curveProgress.validated=e.player.progress.validated,this._curveProgress.furthest=e.player.progress.furthest,this._curveProgress.complete=e.player.progress.complete,this._curveProgress.reverse=e.player.progress.reverse;for(let t=0,s=e.spheres.length;t<s;t++){const s=this.spheres[t],i=e.spheres[t];s.position.copy(i.position),i.isCollidingWithPlayer&&s.action&&s.action()}}}send(e,t=null,s=!1,i=!0){const o=i?yl(t):void 0,a=this.messageID++;let n;return s||(n=new Promise((e=>{const t=s=>{const{data:i,messageID:o}=JSON.parse(s);o===a&&(this.off("message",t),e(i))};this.on("message",t)}))),this.thread.postMessage({type:e,data:t,messageID:a},o),n}addBatch(e){let t=new Map;const s=[];for(let o=0,a=e.length;o<a;o++){const i=e[o],a=i[0],n=i[1],r=i[2]||new l;let c;!a.index||t.has(a)?c=a:(c=a.toNonIndexed(),t.set(a,c));const{array:h,itemSize:u,normalized:d}=c.getAttribute("position");s.push({array:h,itemSize:u,normalized:d,layerID:n,matrix:r})}const i=this.send("add-batch",s);return t.forEach((e=>e.dispose())),i}add(e,t,s=new l){return Array.isArray(e)?this.addBatch(e):this.addBatch([[e,t,s]])}addCurve(e,t,s){return this.send("add-curve",{name:e,points:t,divisions:s})}stopSphere(e,t){return this.send("stop-sphere",{id:e,value:t},!0)}cullSphere(e,t){return this.send("cull-sphere",{id:e,value:t},!0)}addSphere({id:e="default",sphere:t,mode:s=0,moveToFloor:i=!1,move:o=null,action:a}={}){return this.spheres.push({position:t.center,action:a}),this.send("add-sphere",{id:e,position:t.center.toArray(),radius:t.radius,mode:s,move:o,moveToFloor:i})}toggleLayer(e,t=null){return this.send("toggle-layer",{layerID:e,force:t})}movePlayer(e){if(!this.takeOver.active&&!this._moveDirection.equals(e)){const t=e.x,s=e.y,i=e.z;0===t&&0===s&&0===i||this.recover(),this._moveDirection.set(t,s,i),this.playerMoveData[0]=fl,this.playerMoveData[1]=t,this.playerMoveData[2]=s,this.playerMoveData[3]=i}}setGravity(e){return this.send("set-gravity",e,!0)}setPlayerOptions(e){const t={...e};for(let s in t){const e=t[s];e instanceof n&&(t[s]={x:e.x,y:e.y,z:e.z})}return this.send("set-player-options",t,!0)}setCameraOptions(e){const t={...e};for(let s in t){const e=t[s];e instanceof n&&(t[s]={x:e.x,y:e.y,z:e.z})}return this.send("set-camera-options",t,!0)}respawnPlayer(e=!0,t=!0,s=!1){return this.recover(),this.send("respawn-player",{reset:e,resetForces:t,moveToFloor:s})}destroy(){this.thread.terminate(),this.stop(),this.off(),this.log("destroyed")}togglePause(e){return this.send("toggle-pause",!!e)}on(e,t,s=!1){if(e&&t){const i={type:e,action:i=>{t.call(this.thread,i),s&&s.once&&this.off(e,t,s)},originalAction:t,options:s};this.thread.addEventListener(i.type,i.action,i.options),this.events.push(i)}return this}off(e,t,s){for(let i=this.events.length-1;i>=0;i--){let o=this.events[i];e!==o.type&&void 0!==e||t!==o.originalAction&&void 0!==t||s!=o.options&&void 0!==s||(this.thread.removeEventListener instanceof Function&&this.thread.removeEventListener(o.type,o.action,o.options),this.events.splice(i,1))}return this}dispatch(e,t,s){const i=new CustomEvent(e,{detail:t});i.complete=s;for(let o of this.events)o.type===e&&o.action(i);return this}}const vl=2*Math.PI;new V(1,1,1);const wl=new n;Jt(Qt.outSine),new V(16777215);const _l={beforeEmit:function(e={}){e.position||(e.position=wl),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,vl)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:u,opacity:d,gravity:p=0,speed:f}){const m=vl/c,g=e.index*m+re.randomFloat(-Math.PI,Math.PI);let y=.2+re.randomFloat(.03,.15);e.billboard=h,e.angVelocity=0,e.spriteId=Math.random()>.6?"bubble_collapsed":r,e.velocity.x+=y/2*Math.cos(g),e.velocity.z+=y/2*Math.cos(g),e.velocity.y+=y,e.angle=Math.random()*Math.PI*2,e.velocityDrag.setScalar(o||.75),e.useVelocityDragMult=!0,e.gravity.y-=0,e.position.copy(s),e.position.x+=re.randomFloat(-.3,.3),e.position.y+=re.randomFloat(.1,.5),e.position.z+=re.randomFloat(-.3,.3),e.duration=re.randomFloat(a||800,n||900),e.delay=300*Math.random(),e.scaleTo.setScalar(0),e.scaleFrom.copy(i).multiplyScalar(re.randomFloat(.8,1.2)),e.alphaFrom=1,e.alphaTo=1,e.colorFrom.copy(new V(16777215)).multiplyScalar(.15*Math.random()+.85),e.colorTo.copy(new V(16777215)).multiplyScalar(1)}},xl=Object.freeze(Object.defineProperty({__proto__:null,default:_l},Symbol.toStringTag,{value:"Module"})),Sl=2*Math.PI;new V(1,1,1);const Ml=new n;Jt(Qt.outSine),new V(16777215);const Tl={beforeEmit:function(e={}){e.position||(e.position=Ml),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,Sl)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:u,opacity:d,gravity:p=0,speed:f}){const m=Sl/c,g=e.index*m+re.randomFloat(-Math.PI,Math.PI)+t;let y=0+re.randomFloat(.003,.007);e.billboard=h,e.angVelocity=0,e.spriteId=Math.random()>.4?"smoke":"smoke2",e.velocity.x+=y*Math.sin(g),e.velocity.z+=y*Math.sin(g),e.velocity.y+=y*Math.cos(g),e.rotation.x=Math.PI/-2,e.rotation.z=y*e.velocity.x*Math.cos(g),e.angle=Math.random()*Math.PI*2,e.velocityDrag.setScalar(o||.98),e.useVelocityDragMult=!0,e.gravity.y=0,e.position.copy(s),e.position.x+=.1*Math.random()-.05,e.position.y+=.1*Math.random()-.05,e.position.z+=.1*Math.random()-.05,e.duration=re.randomFloat(a||1e3,n||1200),e.scaleInOut=!0,e.scaleTo.copy(i).multiplyScalar(2.3),e.scaleFrom.copy(i).multiplyScalar(2.3),e.alphaFrom=1,e.alphaTo=0,e.alphaInOut=!0,e.colorFrom.copy(new V(16777215)).multiplyScalar(1),e.colorTo.copy(new V(16777215)).multiplyScalar(1)}},Ol=Object.freeze(Object.defineProperty({__proto__:null,default:Tl},Symbol.toStringTag,{value:"Module"})),Pl=2*Math.PI;new V(1,1,1);const Al=new n;Jt(Qt.outSine),new V(16777215);const Il={beforeEmit:function(e={}){e.position||(e.position=Al),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,Pl)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:u,opacity:d,gravity:p=0,speed:f,parent:m}){e.index,re.randomFloat(-Math.PI,Math.PI);const g=Math.random()>.5?-1:1;e.billboard=h,e.angVelocity=0;const y=Math.random()>.8;e.spriteId=y?"leaf_a":"smoke2",e.velocity.x+=.04*Math.random()*g,e.velocity.y+=.05*Math.random()+.08,e.velocity.z=.05*Math.random()+.05,e.parent=m,e.angle=Math.random()*Math.PI*2,e.velocityDrag.setScalar(o||.9),e.useVelocityDragMult=!0,e.gravity.y-=.02,e.position.copy(s),e.position.x*=g,e.duration=re.randomFloat(a||200,n||300),e.delay=100*Math.random(),e.scaleTo.setScalar(0),e.scaleFrom.copy(i).multiplyScalar(y?re.randomFloat(1.2,1.4):re.randomFloat(1.5,1.8)),e.alphaFrom=1,e.alphaTo=1;const b=.5*Math.random()+.5,v=4562255,w=5915980;e.colorFrom.copy(new V(y?v:w)).multiplyScalar(b),e.colorTo.copy(new V(y?v:w)).multiplyScalar(b)}},Cl=Object.freeze(Object.defineProperty({__proto__:null,default:Il},Symbol.toStringTag,{value:"Module"})),Rl=2*Math.PI;new V(1,1,1);const kl=new n;Jt(Qt.outSine),new V(16777215);const Dl={beforeEmit:function(e={}){e.position||(e.position=kl),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,Rl)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:u,opacity:d,gravity:p=0,speed:f,parent:m,dir:g}){e.index,re.randomFloat(-Math.PI,Math.PI),e.billboard=h,e.angVelocity=0;const y=Math.random()>.4;e.spriteId=y?"leaf_a":"bubble_collapsed",e.velocity.x+=.1*Math.random()*g,e.velocity.y+=.2*Math.random()+.3,e.velocity.z=.2*Math.random()+.2,e.parent=m,e.angle=Math.random()*Math.PI*2,e.velocityDrag.setScalar(o||.9),e.useVelocityDragMult=!0,e.gravity.y-=.1,e.position.copy(s),e.position.x*=g,e.duration=re.randomFloat(a||200,n||300),e.delay=100*Math.random(),e.scaleTo.setScalar(0),e.scaleFrom.copy(i).multiplyScalar(y?re.randomFloat(1.4,2):re.randomFloat(.7,1.1)),e.alphaFrom=1,e.alphaTo=1;const b=.5*Math.random()+.5,v=4562255,w=5915980;e.colorFrom.copy(new V(y?v:w)).multiplyScalar(b),e.colorTo.copy(new V(y?v:w)).multiplyScalar(b)}},Ll=Object.freeze(Object.defineProperty({__proto__:null,default:Dl},Symbol.toStringTag,{value:"Module"})),El=2*Math.PI;new V(1,1,1);const Fl=new n;Jt(Qt.outSine),new V(16777215);const Ul={beforeEmit:function(e={}){e.position||(e.position=Fl),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,El)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,rotation:u,parent:d,velocity:p,opacity:f,gravity:m=0,speed:g,dir:y}){e.index,re.randomFloat(-.2,.2),e.billboard=h,e.angVelocity=0,e.spriteId=r,e.velocity.x+=3*y.x*Math.pow(g,2),e.velocity.y+=0,e.velocity.z+=3*y.z*Math.pow(g,2),e.angle=Math.random()*Math.PI*2,e.velocityDrag.setScalar(o||.98),e.useVelocityDragMult=!0,e.gravity.y=0,e.position.copy(s),e.position.x+=.1*Math.random()-.05,e.position.y+=.1*Math.random()-.05,e.position.z+=.1*Math.random()-.05,e.duration=re.randomFloat(a||200,n||300),e.scaleInOut=!0,e.scaleTo.setScalar(0),e.scaleFrom.copy(i).multiplyScalar(1),e.alphaFrom=1,e.alphaTo=1;const b=.5*Math.random()+.5;e.colorFrom.copy(new V(5915980)).multiplyScalar(b),e.colorTo.copy(new V(5915980)).multiplyScalar(b)}},zl=Object.freeze(Object.defineProperty({__proto__:null,default:Ul},Symbol.toStringTag,{value:"Module"})),Bl=2*Math.PI;new V(1,1,1);const Nl=new n,jl=Jt(Qt.outSine);new V(16777215);const Vl={beforeEmit:function(e={}){e.position||(e.position=Nl),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,Bl)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:u,opacity:d,gravity:p=0,speed:f}){const m=Bl/c,g=e.index*m+re.randomFloat(-.2,.2)+t;let y=(.007+re.randomFloat(.003,.007))*(1-10*Math.min(f,.1));e.billboard=h,e.angVelocity=0,e.spriteId=r,e.velocity.x+=y*Math.cos(g),e.velocity.z+=y*Math.cos(g),e.velocity.y+=4*-y,e.rotation.x=Math.PI/-2,e.rotation.z=y*e.velocity.x*Math.cos(g),e.angle=Math.random()*Math.PI*2,e.velocityDrag.setScalar(o||.98),e.useVelocityDragMult=!0,e.gravity.y=0,e.position.copy(s),e.position.x+=.1*Math.random()-.05,e.position.y+=.1*Math.random()-.05,e.position.z+=.1*Math.random()-.05,e.duration=re.randomFloat(a||200,n||300),e.scaleInOut=!0,e.scaleTo.setScalar(0),e.scaleFrom.copy(i).multiplyScalar(1),e.alpha=1,e.colorFrom.copy(new V(8244704)).multiplyScalar(1),e.colorTo.copy(new V(16777215)).multiplyScalar(1),e.colorEase=jl}},Hl=Object.freeze(Object.defineProperty({__proto__:null,default:Vl},Symbol.toStringTag,{value:"Module"})),Wl=2*Math.PI;new V(1,1,1);const Gl=new n;Jt(Qt.outSine),new V(16777215);const ql={beforeEmit:function(e={}){e.position||(e.position=Gl),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,Wl)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:u,opacity:d,gravity:p=0,speed:f}){const m=Wl/c,g=e.index*m+re.randomFloat(-.2,.2)+t;let y=(.007+re.randomFloat(.003,.007))*(1-10*Math.min(Math.pow(f,1),.1));e.billboard=h,e.angVelocity=0,e.spriteId=r,e.velocity.x+=y*Math.cos(g),e.velocity.z+=y*Math.cos(g),e.velocity.y+=2*y,e.rotation.x=Math.PI/-2,e.rotation.z=y*e.velocity.x*Math.cos(g),e.angle=Math.random()*Math.PI*2,e.velocityDrag.setScalar(o||.98),e.useVelocityDragMult=!0,e.gravity.y=0,e.position.copy(s),e.position.x+=.1*Math.random()-.05,e.position.y+=.1*Math.random()-.05,e.position.z+=.1*Math.random()-.05,e.duration=re.randomFloat(a||80,n||90),e.scaleInOut=!0,e.scaleTo.setScalar(0),e.scaleFrom.copy(i).multiplyScalar(1),e.alphaFrom=1,e.alphaTo=1,e.colorFrom.copy(new V(16777215)).multiplyScalar(1),e.colorTo.copy(new V(7327214)).multiplyScalar(1)}},Yl=Object.freeze(Object.defineProperty({__proto__:null,default:ql},Symbol.toStringTag,{value:"Module"})),Kl=2*Math.PI;new V(1,1,1);const Xl=new n,$l=Jt(Qt.outQuint);const Zl=new V(16777215);const Jl={beforeEmit:function(e={}){e.position||(e.position=Xl),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,Kl)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:u,opacity:d,gravity:p=0}){const f=Kl/c,m=e.index*f+re.randomFloat(-.2,.2)+t;let g=.007+re.randomFloat(.003,.007);e.billboard=h,e.angVelocity=0,e.spriteId=r,e.velocity.x+=g*Math.cos(m),e.velocity.z+=g*Math.cos(m),e.velocity.y+=3*-g,e.rotation.x=Math.PI/-2,e.rotation.z=g*e.velocity.x*Math.cos(m),e.angle=Math.random()*Math.PI*2,e.velocityDrag.setScalar(o||.93),e.useVelocityDragMult=!0,e.gravity.y=0,e.position.copy(s),e.position.x+=.1*Math.random()-.05,e.position.y+=.1*Math.random()-.05,e.position.z+=.1*Math.random()-.05,e.duration=re.randomFloat(a||1500,n||2e3),e.scaleTo.copy(i).multiplyScalar(10),e.scaleFrom.setScalar(2),e.alphaFrom=.3,e.alphaTo=0,e.alphaEase=$l,e.colorFrom.copy(Zl).multiplyScalar(1),e.colorTo.copy(Zl).multiplyScalar(1),e.colorEase=$l}},Ql=Object.freeze(Object.defineProperty({__proto__:null,default:Jl},Symbol.toStringTag,{value:"Module"})),ec=2*Math.PI;new V(1,1,1);const tc=new n;Jt(Qt.outSine),new V(16777215);const sc={beforeEmit:function(e={}){e.position||(e.position=tc),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,ec)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:u,opacity:d,gravity:p=0,speed:f,parent:m,dir:g}){e.index,re.randomFloat(-Math.PI,Math.PI),e.billboard=h,e.angVelocity=0,e.spriteId="bubble_collapsed",e.velocity.x+=.1*Math.random()*g,e.velocity.y+=.2*Math.random()+.3,e.velocity.z=.2*Math.random()+.5,e.parent=m,e.angle=Math.random()*Math.PI*2,e.velocityDrag.setScalar(o||.9),e.useVelocityDragMult=!0,e.gravity.y-=.1,e.position.copy(s),e.position.x*=g,e.duration=re.randomFloat(a||200,n||300),e.delay=100*Math.random(),e.scaleTo.setScalar(0),e.scaleFrom.copy(i).multiplyScalar(re.randomFloat(.7,1.1)),e.alphaFrom=1,e.alphaTo=1;const y=.5*Math.random()+.2;e.colorFrom.copy(new V(2766661)).multiplyScalar(y),e.colorTo.copy(new V(2766661)).multiplyScalar(y)}},ic=Object.freeze(Object.defineProperty({__proto__:null,default:sc},Symbol.toStringTag,{value:"Module"})),oc=2*Math.PI;new V(1,1,1);const ac=new n;Jt(Qt.outSine),new V(16777215);const nc={beforeEmit:function(e={}){e.position||(e.position=ac),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,oc)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:u,opacity:d,velocityY:p=0,gravity:f=0,power:m=1,baseRadius:g=0,speed:y}){const b=oc/c,v=e.index*b;let w=(.5+re.randomFloat(.003,.007))*m;e.billboard=h,e.angVelocity=0,e.spriteId=Math.random()>.4?"smoke":"smoke2",e.velocity.x+=w*Math.sin(v),e.velocity.z+=w*Math.cos(v),e.velocity.y+=p*Math.random(),e.rotation.x=Math.PI/-2,e.rotation.z=w*e.velocity.x*Math.cos(v),e.angle=Math.random()*Math.PI*2,e.velocityDrag.setScalar(o||.93),e.useVelocityDragMult=!0,e.gravity.y=0,e.position.copy(s),e.position.x+=.1*Math.random()-.05,e.position.y+=.1*Math.random()-.05,e.position.z+=.1*Math.random()-.05,e.position.x+=Math.sin(v)*g,e.position.y+=0,e.position.z+=Math.cos(v)*g,e.duration=re.randomFloat(a||1e3,n||1200),e.scaleInOut=!0,e.scaleTo.copy(i).multiplyScalar(1),e.scaleFrom.copy(i).multiplyScalar(2.3),e.alphaFrom=1,e.alphaTo=0,e.alphaInOut=!0,e.colorFrom.copy(new V(16777215)).multiplyScalar(1),e.colorTo.copy(new V(16777215)).multiplyScalar(1)}},rc=Object.freeze(Object.defineProperty({__proto__:null,default:nc},Symbol.toStringTag,{value:"Module"})),lc=2*Math.PI;new V(1,1,1);const cc=new n;Jt(Qt.outSine),new V(16777215);const hc={beforeEmit:function(e={}){e.position||(e.position=cc),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,lc)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:u,opacity:d,gravity:p=0,speed:f}){const m=lc/c,g=e.index*m+re.randomFloat(-Math.PI,Math.PI)+t;let y=0+re.randomFloat(.003,.004);e.billboard=h,e.angVelocity=0,e.spriteId=Math.random()>0?"smoke":"smoke2",e.velocity.x+=y*Math.sin(g),e.velocity.z+=y*Math.sin(g),e.velocity.y+=y*Math.cos(g),e.rotation.x=Math.PI/-2,e.rotation.z=y*e.velocity.x*Math.cos(g),e.angle=Math.random()*Math.PI*2,e.velocityDrag.setScalar(o||.98),e.useVelocityDragMult=!0,e.gravity.y=0,e.position.copy(s),e.position.x+=.1*Math.random()-.05,e.position.y+=.1*Math.random()-.05,e.position.z+=.1*Math.random()-.05,e.duration=re.randomFloat(a||1e3,n||1200),e.scaleInOut=!0,e.scaleTo.copy(i).multiplyScalar(2.3),e.scaleFrom.copy(i).multiplyScalar(2.3),e.alphaFrom=1,e.alphaTo=0,e.alphaInOut=!0,e.colorFrom.copy(new V(16777215)).multiplyScalar(1),e.colorTo.copy(new V(16777215)).multiplyScalar(1)}},uc=Object.freeze(Object.defineProperty({__proto__:null,default:hc},Symbol.toStringTag,{value:"Module"})),dc=new V(1,1,1),pc=new V(0,0,0),fc=new n,mc=Jt(0,.815,.145,1),gc=Jt(0,.585,.365,1),yc={particleEmitted:function(e,{position:t,scale:s,sprite:i,duration:o,opacity:a=1,power:n=0}){e.billboard=!0,e.spriteId=i,e.position.copy(t||fc),e.duration=o||1e3;const r=(s=s||1).x||s,l=s.y||s;e.scaleFrom.set(r,l),e.scaleTo.copy(e.scaleFrom).multiplyScalar(1.1),e.alphaEase=mc,e.alphaFrom=1-(.3+.7*n),e.alphaTo=1,e.colorEase=gc,e.colorFrom.lerpColors(pc,dc,a),e.colorTo.copy(pc)}};const bc=Object.freeze(Object.defineProperty({__proto__:null,default:yc},Symbol.toStringTag,{value:"Module"})),vc=2*Math.PI;new V(1,1,1);const wc=new n;Jt(Qt.outSine),new V(16777215);const _c={beforeEmit:function(e={}){e.position||(e.position=wc),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,vc)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:u,opacity:d,gravity:p=0,speed:f,parent:m,power:g=1,delay:y}){e.index,re.randomFloat(-Math.PI,Math.PI),e.billboard=h,e.angVelocity=0;const b=Math.random()>.3;e.spriteId="plus_b",e.velocity.y+=.01*Math.random()+.01,e.parent=m,e.velocityDrag.setScalar(o||.99),e.useVelocityDragMult=!0,e.position.copy(s),e.position.x+=re.randomFloat(-.4,.4),e.position.y+=re.randomFloat(-.1,.1),e.position.z+=re.randomFloat(-.4,.4),e.duration=re.randomFloat(a||900,n||1e3),e.delay=y||50*Math.random(),e.scaleInOut=!0,e.scaleTo.setScalar(0),e.scaleFrom.copy(i).multiplyScalar(b?re.randomFloat(1.2,1.4):re.randomFloat(1.5,1.8)),e.alphaFrom=1,e.alphaTo=1,e.colorFrom.copy(new V(16777215)),e.colorTo.copy(new V(16777215))}},xc=Object.freeze(Object.defineProperty({__proto__:null,default:_c},Symbol.toStringTag,{value:"Module"})),Sc=2*Math.PI;new V(1,1,1);const Mc=new n;const Tc={beforeEmit:function(e={}){e.position||(e.position=Mc)},particleEmitted:function(e,{position:t,color:s,scale:i,lean:o,parent:a}){const n=re.tossCoin(.3);e.parent=a,e.spriteId=n?"smoke2":"waterfallCircle",e.billboard=!0,e.duration=re.randomFloat(200,500);const r=Math.abs(o),l=es(2,1,r);e.angle=re.randomFloat(0,Sc),e.angVelocity=re.randomFloat(.2,.4)*(re.tossCoin(.5)?1:-1);const c=r>.1;t.x+=re.randomFloat(-.2,.2)*l,t.x-=.5*o,t.y+=.03,t.z-=.25*r,e.position.copy(t),e.gravity.y=re.randomFloat(-.015,-.027),i*=.018*re.randomFloat(1.2,2.25),c&&(i*=1-.01*r);const h=n?3:1;if(e.scaleFrom.setScalar(i).multiplyScalar(2*h),e.scaleTo.setScalar(i).multiplyScalar(.6*h),e.scaleInOut=!0,e.velocity.x=1*re.randomFloat(-.008,.008)*i,e.velocity.y=.0145*i,e.velocity.z=re.randomFloat(0,.01)*i,c){const t=re.randomFloat(.5,1);e.gravity.y+=-.08*r*t*.4,e.velocity.x=-.045*o*re.randomFloat(-.1,1.2),e.velocity.z-=.02*r*re.randomFloat(.4,1)*.2,e.velocity.y+=.1*r*t*.2}e.angVelocity=0,e.colorFrom.copy(s).offsetHSL(0,-.02,.5),e.colorTo.copy(s).offsetHSL(-.03,-.1,.12)},particleUpdated:function(e,{player:t}){if(!t.isOnWater){const t=p.time.stableDt;e.age+=2*t}}},Oc=Object.freeze(Object.defineProperty({__proto__:null,default:Tc},Symbol.toStringTag,{value:"Module"})),Pc=new V(1,1,1),Ac=new n;const Ic={beforeEmit:function(e={}){e.position||(e.position=Ac)},particleEmitted:function(e,{position:t,scale:s=60,lean:i,power:o=1,parent:a}){e.parent=a,e.spriteId="waterfallCircle",e.billboard=!0;const n=1.6*o;e.duration=re.randomFloat(600,850)/n;const r=Math.abs(i),l=es(2,.9,r),c=r>.1;e.position.copy(t),e.position.x+=re.randomFloat(-.2,.2)*l,e.position.x-=.7*i,e.position.z-=.25*r,s*=.018*re.randomFloat(1.4,2.5)*.16,c&&(s*=1+.14*r),e.scaleFrom.setScalar(s).multiplyScalar(3.8),e.scaleTo.setScalar(s).multiplyScalar(.8),e.gravity.y=-.1122,e.useVelocityDragMult=!0,e.velocityDrag.setScalar(.985),e.velocity.x=.02*re.randomFloat(-1,1)*n,e.velocity.y=.13+re.randomFloat(-.01,.05)*n,e.velocity.z=re.randomFloat(.01,.03)*n,c&&(e.velocityDrag.setScalar(.98),e.gravity.y+=-.02*r*re.randomFloat(.5,1)*n,e.velocity.x=-.05*i*re.randomFloat(-.2,.5)*n,e.velocity.z+=.04*r*n,e.velocity.y+=.05*r*re.randomFloat(.5,1)*n),e.angVelocity=0,e.colorFrom.copy(Pc),e.colorTo.copy(Pc)},particleUpdated:function(e,{player:t}){if(!t.isOnWater){const t=p.time.stableDt;e.age+=1*t}}},Cc=Object.freeze(Object.defineProperty({__proto__:null,default:Ic},Symbol.toStringTag,{value:"Module"})),Rc=new n,kc=new r;const Dc={beforeEmit:function(e={}){e.position||(e.position=Rc)},particleUpdated:function(e,{player:t}){e.date<t.lastHitProps&&(e.date=Infinity,e.velocity.multiplyScalar(-.15))},particleEmitted:function(e,{position:t,scale:s,velDrag:i,durationMin:o,durationMax:a,velocity:n,billboard:r,lean:l,alt:c,scaleTo:h,alphaEase:u,player:d}){e.player=d,e.billboard=r,e.angVelocity=0,e.spriteId=c?"wave_b":"wave_a",e.rotation.x=Math.PI/-2,e.rotation.z=-kc.set(n.x,n.z).angle()-.5*Math.PI+.15*re.randomFloat(-1,1)*Math.PI*(c?.1:1)+-.5*l,e.velocityDrag.setScalar(i||.9),e.useVelocityDragMult=!0,e.gravity.y-=0,n&&e.velocity.copy(n).multiplyScalar(1),e.position.copy(t),e.duration=re.randomFloat(o||600,a||800),e.scaleFrom.copy(s||1),h?e.scaleTo.copy(h):e.scaleTo.setScalar(40),e.date=performance.now(),e.alphaFrom=1,e.alphaTo=0,u&&(e.alphaEase=Jt(u));const p=.5*Math.random()+1,f=12646389;e.colorFrom.set(f).multiplyScalar(p),e.colorTo.set(f).multiplyScalar(p)}},Lc=Object.freeze(Object.defineProperty({__proto__:null,default:Dc},Symbol.toStringTag,{value:"Module"})),Ec=2*Math.PI,Fc=new n;new r;const Uc=new V(1,1,1),zc=Jt("outQuint");const Bc={beforeEmit:function(e={}){e.position||(e.position=Fc)},particleUpdated:function(e,{player:t}){e.date<t.lastHitProps&&(e.date=Infinity,e.velocity.multiplyScalar(-.15))},particleEmitted:function(e,{position:t,scale:s,velDrag:i,velocity:o,scaleTo:a,player:n}){e.player=n,e.billboard=!0,e.angVelocity=re.randomFloat(.2,.4)*(re.tossCoin(.5)?1:-1),e.spriteId="smoke2",e.angle=re.randomFloat(0,Ec),e.velocityDrag.setScalar(i||.9),e.useVelocityDragMult=!0,o&&e.velocity.copy(o).multiplyScalar(.98),e.position.copy(t),e.duration=re.randomFloat(400,600),e.scaleFrom.setScalar(re.randomFloat(5,7)),e.scaleTo.copy(e.scaleFrom).multiplyScalar(1.5),e.date=performance.now(),e.alphaFrom=0,e.alphaTo=.5,e.alphaEase=zc,e.colorFrom.copy(Uc),e.colorTo.copy(Uc)}},Nc=Object.freeze(Object.defineProperty({__proto__:null,default:Bc},Symbol.toStringTag,{value:"Module"})),jc=2*Math.PI;new V(1,1,1);const Vc=new n;Jt(Qt.outSine),new V(16777215),new qt;const Hc={beforeEmit:function(e={}){e.position||(e.position=Vc),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,jc)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:u,opacity:d,gravity:p=0,speed:f,radius:m=0,parent:g}){const y=jc/c,b=e.index*y;let v=re.randomFloat(16,20)*(u||1);e.billboard=h,e.angVelocity=0,e.spriteId="Line",e.velocity.x=v*Math.cos(-b),e.velocity.z=v*Math.sin(-b),e.velocity.y=0,e.angle=b+Math.PI/2,e.parent=g,e.velocityDrag.setScalar(.8),e.useVelocityDragMult=!0,e.gravity.y=0,e.position.copy(s),e.position.x+=Math.cos(-b)*m,e.position.y+=0,e.position.z+=Math.sin(-b)*m,e.duration=re.randomFloat(250,350)*w(u,.8,1.3,.85,1.2),e.delay=re.randomFloat(0,30);const _=re.randomFloat(1.4,2.3);e.scaleFrom.copy(i).multiplyScalar(_),e.scaleTo.copy(i).multiplyScalar(0),e.scaleFrom.x*=2.3,e.scaleTo.y=0,e.alphaFrom=1,e.alphaTo=1,e.alphaInOut=!0,e.colorFrom.copy(new V(16777215)).multiplyScalar(1),e.colorTo.copy(new V(16777215)).multiplyScalar(1)}},Wc=Object.freeze(Object.defineProperty({__proto__:null,default:Hc},Symbol.toStringTag,{value:"Module"})),Gc=2*Math.PI;new V(1,1,1);const qc=new n;Jt(Qt.outSine),new V(16777215);const Yc={beforeEmit:function(e={}){e.position||(e.position=qc),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,Gc)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,rotation:u,parent:d,velocity:p,opacity:f,gravity:m=0,speed:g,dir:y}){e.index,re.randomFloat(-.2,.2),e.billboard=h,e.angVelocity=0,e.spriteId=r,e.velocity.x+=1*y.x*Math.pow(g,2),e.velocity.y+=0,e.velocity.z+=1*y.z*Math.pow(g,2),e.angle=Math.random()*Math.PI*2,e.velocityDrag.setScalar(o||.98),e.useVelocityDragMult=!0,e.gravity.y=0,e.position.copy(s),e.position.x+=.1*Math.random()-.05,e.position.y+=.1*Math.random()-.05,e.position.z+=.1*Math.random()-.05,e.duration=re.randomFloat(a||400,n||500),e.scaleInOut=!0,e.scaleTo.setScalar(0),e.scaleFrom.copy(i).multiplyScalar(1),e.alphaFrom=1,e.alphaTo=-.5,e.alphaInOut=!0,e.colorFrom.copy(new V(16777215)).multiplyScalar(1),e.colorTo.copy(new V(16777215)).multiplyScalar(1)}},Kc=Object.freeze(Object.defineProperty({__proto__:null,default:Yc},Symbol.toStringTag,{value:"Module"})),Xc=2*Math.PI;new V(1,1,1);const $c=new n;Jt(Qt.outSine),new V(16777215);const Zc={beforeEmit:function(e={}){e.position||(e.position=$c),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,Xc)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:u,opacity:d,gravity:p=0,power:f=1,baseRadius:m=0,transformMatrix:g,vel:y,speed:b}){e.index,e.billboard=h,e.angVelocity=0,e.spriteId=Math.random()>.5?"note_a":"note_b",e.velocity.x=0,e.velocity.z=0,e.velocity.y=0,e.velocity.copy(y),e.velocity.multiplyScalar(.2),e.angle=re.randomFloat(-.2,.2),e.velocityDrag.setScalar(o||.93),e.useVelocityDragMult=!0,e.gravity.y=0,e.position.copy(s),e.duration=re.randomFloat(a||1e3,n||1200),e.scaleInOut=!0,e.scaleTo.copy(i).multiplyScalar(1),e.scaleFrom.copy(i).multiplyScalar(2.3),e.alphaFrom=1,e.alphaTo=0,e.alphaInOut=!0,e.colorFrom.copy(new V(16777215)).multiplyScalar(1),e.colorTo.copy(new V(16777215)).multiplyScalar(1)}},Jc=Object.freeze(Object.defineProperty({__proto__:null,default:Zc},Symbol.toStringTag,{value:"Module"})),Qc=2*Math.PI,eh=new n,th=Jt("outQuad");const sh={beforeEmit:function(e={}){e.position||(e.position=eh)},particleEmitted:function(e,{parent:t,speed:s}){e.parent=t,e.spriteId="speedline",e.billboard=!0,e.duration=re.randomFloat(300,600),e.parent=t;const i=U(s,0,1),o=re.randomFloat(2,4.5)*es(.8,1.2,i),a=re.randomFloat(0,Qc),n=es(.02,.065,i),r=p.viewport.ratio.value;let l=.29*Math.cos(a)*r,c=.29*Math.sin(a);e.scaleFrom.set(o,.8),e.scaleTo.set(o,.8),e.position.set(l,c,-1),e.velocity.x=Math.cos(a)*n,e.velocity.y=Math.sin(a)*n,e.angle=a,e.alphaFrom=0,e.alphaTo=es(0,1.4,s),e.alphaEase=th}},ih=Object.freeze(Object.defineProperty({__proto__:null,default:sh},Symbol.toStringTag,{value:"Module"})),oh=2*Math.PI;new V(1,1,1);const ah=new n;const nh={beforeEmit:function(e={}){e.position||(e.position=ah),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,oh)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:u,opacity:d,delay:p,gravity:f=0}){const m=oh/c,g=e.index*m+re.randomFloat(-.2,.2)+t;let y=.005*Math.random()+.005;e.billboard=h,e.delay=re.randomFloat(0,70),e.angVelocity=0,e.spriteId=r,e.velocity.x+=y*Math.cos(g),e.velocity.z+=y*Math.cos(g),e.velocity.y+=0,e.rotation.x=Math.PI/-2,e.rotation.z=y*e.velocity.x*Math.cos(g),e.velocityDrag.setScalar(1),e.useVelocityDragMult=!0,e.gravity.y=.01,e.position.copy(s),e.position.x+=.2*Math.random()-.1,e.position.y+=.2*Math.random()-.1,e.position.z+=.2*Math.random()-.1,e.duration=re.randomFloat(a||300,n||400),e.scaleFrom.copy(i),e.scaleTo.setScalar(0),e.alpha=1}},rh=Object.freeze(Object.defineProperty({__proto__:null,default:nh},Symbol.toStringTag,{value:"Module"})),lh=2*Math.PI;new V(1,1,1);const ch=new n;Jt(Qt.outSine),new V(16777215);const hh={beforeEmit:function(e={}){e.position||(e.position=ch),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,lh)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:u,opacity:d,gravity:p=0,speed:f,parent:m,power:g=1,delay:y}){e.index,re.randomFloat(-Math.PI,Math.PI);const b=Math.random()>.5?-1:1;e.billboard=h,e.angVelocity=0;const v=Math.random()>.3;e.spriteId=v?"bubble_collapsed":"smoke2",e.velocity.x+=.04*Math.random()*b,e.velocity.y+=.05*Math.random()+.08,e.velocity.z=g>1?.05*-Math.random()+.05:.05*Math.random()+.05,e.velocity.multiplyScalar(g),e.parent=m,e.angle=Math.random()*Math.PI*2,e.velocityDrag.setScalar(o||.9),e.useVelocityDragMult=!0,e.gravity.y-=.02*g,e.position.copy(s),m&&(e.position.x*=b),e.duration=re.randomFloat(a||200,n||300),e.delay=y||100*Math.random(),e.scaleTo.setScalar(0),e.scaleFrom.copy(i).multiplyScalar(v?re.randomFloat(1.2,1.4):re.randomFloat(1.5,1.8)),e.alphaFrom=1,e.alphaTo=1;const w=.5*Math.random()+1,_=12646389,x=12646389;e.colorFrom.copy(new V(v?_:x)).multiplyScalar(w),e.colorTo.copy(new V(v?_:x)).multiplyScalar(w)}},uh=Object.freeze(Object.defineProperty({__proto__:null,default:hh},Symbol.toStringTag,{value:"Module"})),dh=2*Math.PI;new V(1,1,1);const ph=new n;Jt(Qt.outSine),new V(16777215);const fh={beforeEmit:function(e={}){e.position||(e.position=ph),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,dh)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:u,opacity:d,gravity:p=0,speed:f,parent:m,power:g=1,delay:y}){e.index,re.randomFloat(-Math.PI,Math.PI);const b=Math.random()>.5?-1:1;e.billboard=h,e.angVelocity=0;const v=Math.random()>.3;e.spriteId=v?"bubble_collapsed":"smoke2",e.velocity.x+=(.03*Math.random()+.02)*b*g,e.velocity.y+=.2*Math.random()+.1,e.velocity.z=(g>1?.05*-Math.random():.05*Math.random()+.05)*g,e.parent=m,e.angle=Math.random()*Math.PI*2,e.velocityDrag.setScalar(o||.9),e.useVelocityDragMult=!0,e.gravity.y-=.02*g,e.position.copy(s),e.position.x*=b,e.duration=re.randomFloat(a||400,n||500),e.delay=y||100*Math.random(),e.scaleTo.setScalar(0),e.scaleFrom.copy(i).multiplyScalar(v?re.randomFloat(1.2,1.4):re.randomFloat(1.5,1.8)),e.alphaFrom=1,e.alphaTo=1;const w=.5*Math.random()+1,_=12646389,x=12646389;e.colorFrom.copy(new V(v?_:x)).multiplyScalar(w),e.colorTo.copy(new V(v?_:x)).multiplyScalar(w)}},mh=Object.freeze(Object.defineProperty({__proto__:null,default:fh},Symbol.toStringTag,{value:"Module"})),gh=new n;const yh={beforeEmit:function(e={}){e.position||(e.position=gh)},particleEmitted:function(e,{position:t,scale:s,velDrag:i,durationMin:o,durationMax:a,velocity:n,billboard:r,rotation:l,scaleTo:c,alphaEase:h}){e.billboard=r,e.angVelocity=0,e.spriteId="water_c",e.rotation.x=Math.PI/-2,l&&e.rotation.copy(l),e.velocityDrag.setScalar(i||.9),e.useVelocityDragMult=!0,e.gravity.y-=0,n&&e.velocity.copy(n).multiplyScalar(1),e.position.copy(t),e.duration=re.randomFloat(o||600,a||800),e.scaleFrom.copy(s||1),c?e.scaleTo.copy(c):e.scaleTo.setScalar(40),e.alphaFrom=1,e.alphaTo=0,h&&(e.alphaEase=Jt(h));const u=.5*Math.random()+1,d=12646389;e.colorFrom.set(d).multiplyScalar(u),e.colorTo.set(d).multiplyScalar(u)}},bh=Object.freeze(Object.defineProperty({__proto__:null,default:yh},Symbol.toStringTag,{value:"Module"})),vh=2*Math.PI;new V(1,1,1);const wh=new n;Jt(Qt.outSine),new V(16777215);const _h={beforeEmit:function(e={}){e.position||(e.position=wh),e.scale=e.scale||1,e.angOffset=re.randomFloat(0,vh)},particleEmitted:function(e,{angOffset:t,position:s,scale:i,velDrag:o,durationMin:a,durationMax:n,sprite:r,color:l,amount:c,billboard:h,velocity:u,opacity:d,gravity:p=0,speed:f,parent:m,dir:g}){e.index,re.randomFloat(-Math.PI,Math.PI),e.billboard=h,e.angVelocity=0;const y=Math.random()>.4;e.spriteId="bubble_collapsed",e.velocity.x+=.1*Math.random()*g,e.velocity.y+=.2*Math.random()+.3,e.velocity.z=.2*Math.random()+.2,e.parent=m,e.angle=Math.random()*Math.PI*2,e.velocityDrag.setScalar(o||.9),e.useVelocityDragMult=!0,e.gravity.y-=.1,e.position.copy(s),e.position.x*=g,e.duration=re.randomFloat(a||450,n||600),e.delay=100*Math.random(),e.scaleTo.setScalar(0),e.scaleFrom.copy(i).multiplyScalar(y?re.randomFloat(1.4,2):re.randomFloat(.7,1.1)),e.alphaFrom=1,e.alphaTo=1;const b=.5*Math.random()+1,v=12646389,w=12646389;e.colorFrom.copy(new V(y?v:w)).multiplyScalar(b),e.colorTo.copy(new V(y?v:w)).multiplyScalar(b)}},xh=Object.freeze(Object.defineProperty({__proto__:null,default:_h},Symbol.toStringTag,{value:"Module"}));new V(1,1,1);const Sh=new n;Jt(Qt.outSine),new V(16777215);const Mh={beforeEmit:function(e={}){e.position||(e.position=Sh)},particleEmitted:function(e,{rotation:t,position:s,billboard:i,color:o,dimished:a,scale:n}){e.duration=a?re.randomFloat(300,500):re.randomFloat(500,800);const r=n*re.randomFloat(.73,1.4),l=.3*n;e.billboard=!1,e.scaleFrom.set(1,r,l).multiplyScalar(1.2),e.scaleTo.set(1,r,l).multiplyScalar(.2),e.velocity.y=-.009*n,e.position.copy(s),e.rotation.copy(t),e.colorFrom.copy(o).offsetHSL(0,-.02,.3),e.colorTo.copy(o).offsetHSL(-.03,-.1,.12),e.angVelocity=0,e.spriteId="waterfallCircle"}},Th=Object.freeze(Object.defineProperty({__proto__:null,default:Mh},Symbol.toStringTag,{value:"Module"}));new V(1,1,1);const Oh=new n;Jt(Qt.outSine),new V(16777215);const Ph={beforeEmit:function(e={}){e.position||(e.position=Oh)},particleEmitted:function(e,{rotation:t,position:s,billboard:i,color:o,dimished:a,scale:n}){e.duration=a?re.randomFloat(300,500):re.randomFloat(500,800);const r=re.randomFloat(.73,1.7);n*=r,e.billboard=i,r<1.14&&!i&&(e.billboard=re.tossCoin(.7)),e.scaleFrom.setScalar(n).multiplyScalar(1.2),e.scaleTo.setScalar(n).multiplyScalar(.2),e.scaleInOut=!0,e.velocity.y=.0035*n,e.position.copy(s),e.rotation.copy(t),e.colorFrom.copy(o).offsetHSL(0,-.02,.5),e.colorTo.copy(o).offsetHSL(-.03,-.1,.12),e.angVelocity=0,e.spriteId="waterfallCircle"}},Ah=Object.freeze(Object.defineProperty({__proto__:null,default:Ph},Symbol.toStringTag,{value:"Module"})),Ih=new H,Ch=1/Number.MAX_SAFE_INTEGER,Rh={},kh=Jt("linear"),Dh=Jt(.7,.3,.2,.2);let Lh;class Eh extends f{constructor(e){e.useEuler=!0,super(e),Lh||(Lh=s()),this.batcher&&this.batcher.removeInstance(this),this.spriteId=null,this.spriteFrame=0,this.spriteFrameDuration=50,this.spriteLoop=!1,this.spriteAutoplay=!1,this.rotation=new qt,this.delay=0,this.duration=0,this.age=0,this.progress=0,this.onProgress=null,this.onComplete=null,this.onEnd=null,this.angVelocity=0,this.angVelocityDrag=0,this.velocity=new n,this.velocityDrag=new n,this.velocityDragMult=new n,this.useVelocityDragMult=!1,this.scaleWithVel=!1,this.gravity=new n,this.scaleFrom=new r,this.scaleTo=new r,this.colorFrom=new V,this.colorTo=new V,this.alphaFrom=1,this.alphaTo=1,this.alive=!1,this.killable=!1,this.progressEase=kh,this.scaleEase=kh,this.alphaEase=kh,this.colorEase=kh,this.scaleVelEase=Dh}reset(){this.alive&&this.onRelease&&this.onRelease(),this.preset&&this.preset.particleReleased&&this.preset.particleReleased(this,this.presetOptions),this.parent=null,this.preset=Rh,this.spriteId=null,this.spriteFrame=0,this.spriteFrameDuration=50,this.spriteLoop=!1,this.spriteAutoplay=!1,this.billboard=!1,this.angle=0,this.quaternion.copy(Ih),this.rotation.set(0,0,0),this.position.setScalar(0),this.scale.setScalar(1),this.delay=0,this.duration=1e3,this.age=0,this.progress=0,this.onProgress=null,this.onComplete=null,this.onRelease=null,this.angVelocity=0,this.angVelocityDrag=0,this.velocity.setScalar(0),this.velocityDrag.setScalar(0),this.useVelocityDragMult=!1,this.scaleWithVel=!1,this.scaleInOut=!1,this.gravity.setScalar(0),this.scaleFrom.setScalar(1),this.scaleTo.setScalar(1),this.colorFrom.setRGB(255,255,255),this.colorTo.setRGB(255,255,255),this.alphaFrom=1,this.alphaTo=1,this.alphaInOut=!1,this.progressEase=kh,this.scaleEase=kh,this.alphaEase=kh,this.colorEase=kh,this.scaleVelEase=Dh}emit(e,t,s,i){this.reset(),this.batcher=e,this.spriteId=this.killable=!1,this.alive=!0,this.index=i,this.billboard=s.billboard||!1,this.parent=s.parent,this.preset=t||Rh,this.presetOptions=s||Rh,this.preset.particleEmitted&&this.preset.particleEmitted(this,this.presetOptions),this.sprite.setAtlas(this.batcher.atlas),this.sprite.change({id:this.spriteId,frame:this.spriteFrame,frameDuration:this.spriteFrameDuration,loop:this.spriteLoop,autoplay:this.spriteAutoplay}),this.batcher.addInstance(this),this.sprite.update(1),this.update(0)}kill(){this.killable&&this.preset.particleKilled&&this.preset.particleKilled(this,this.presetOptions),this.killable&&this.onComplete&&this.onComplete(),this.batcher&&(this.batcher.removeInstance(this),this.batcher=null),this.reset(),this.progress=1,this.alive=!1,this.killable=!1}update(){if(!this.alive||this.killable)return;if(this.progress>=1)return this.killable=!0;let e=Lh.time.stableDt;if(this.delay>0){if(this.delay-=e,this.delay>0)return this.alpha=0,void this.scale.setScalar(Ch);e=Math.max(0,e+this.delay)}super.update(e);const t=Math.max(Math.min(e/16.666666667,1.5),.5);if(this.age+=e,this.progress=this.progressEase(U(this.age/this.duration,0,1)),this.preset.particleUpdate)this.preset.particleUpdate(this,this.presetOptions);else{if(this.useVelocityDragMult)this.velocity.multiply(this.velocityDrag),this.velocity.lengthSq<1e-4&&this.velocity.setScalar(0);else{if(this.velocity.x){const e=Math.sign(this.velocity.x);this.velocity.x-=e*this.velocityDrag.x*t,Math.sign(this.velocity.x)!==e&&(this.velocity.x=0)}if(this.velocity.y){const e=Math.sign(this.velocity.y);this.velocity.y-=e*this.velocityDrag.y*t,Math.sign(this.velocity.y)!==e&&(this.velocity.y=0)}if(this.velocity.z){const e=Math.sign(this.velocity.z);this.velocity.z-=e*this.velocityDrag.z*t,Math.sign(this.velocity.z)!==e&&(this.velocity.z=0)}}if(this.angVelocity){const e=Math.sign(this.angVelocity);this.angVelocity-=e*this.angVelocityDrag*t,Math.sign(this.angVelocity)!==e&&(this.angVelocity=0)}this.position.x+=(this.velocity.x+this.gravity.x)*t,this.position.y+=(this.velocity.y+this.gravity.y)*t,this.position.z+=(this.velocity.z+this.gravity.z)*t,this.billboard?(this.angle+=this.angVelocity*t,this.angleTo&&(this.angle=Y(this.angleFrom,this.angleTo,this.progress))):this.rotation.z+=this.angVelocity*t,this.scaleWithVel?this.scale.copy(this.scaleFrom).lerp(this.scaleTo,this.scaleVelEase(this.progress)):this.scaleInOut?this.scale.copy(this.scaleFrom).lerp(this.scaleTo,1-Math.sin(this.scaleEase(this.progress)*Math.PI)):this.scale.copy(this.scaleFrom).lerp(this.scaleTo,this.scaleEase(this.progress)),this.color.copy(this.colorFrom).lerp(this.colorTo,this.colorEase(this.progress)),this.alphaInOut?this.alpha=Y(this.alphaFrom,this.alphaTo,1-Math.sin(this.progress*Math.PI)):this.alpha=Y(this.alphaFrom,this.alphaTo,this.alphaEase(this.progress))}this.preset.particleUpdated&&this.preset.particleUpdated(this,this.presetOptions),this.onProgress&&this.onProgress(this,this.progress)}}const Fh={};class Uh extends u{constructor(e){super(e),e.batcher&&(e.batchers={default:e.batcher}),this.count=e.count||150,this.dead=new Array(this.count).fill(0).map((()=>new Eh({}))),this.alive=[],this.batchers=e.batchers||{}}emit(e,t={},s){"number"==typeof t&&(t={amount:t});const i=t.amount=t.amount||1,o=Fh[e];if(!o)return;if(o.beforeAlloc&&o.beforeAlloc(t),t.amount<=0)return;const a=this.batchers[s]||this.batchers.default,n=this.alloc(i);o.beforeEmit&&o.beforeEmit(t,n);for(let r=n.length-1;r>=0;r--)n[r].alive||0,this.alive.push(n[r]),n[r].emit(a,o,t,r)}update(e){const t=[];for(let s=this.alive.length-1;s>=0;s--){const i=this.alive[s];i.update(e),i.killable&&(t.push(i),this.alive.splice(s,1),this.dead.push(i))}for(let s=t.length-1;s>=0;s--)t[s].kill()}alloc(e){const t=this.dead,s=this.alive;let i=[],o=e;return t.length>0&&(i=t.splice(0,o)),o-=i.length,o>0&&(i=i.concat(s.splice(0,o))),i}killAll(){for(let e=this.alive.length-1;e>=0;e--)this.alive[e].kill(),this.dead.push(this.alive[e]),this.alive.splice(e,1)}registerPreset(e,t){!function(e,t){t||(t={}),Fh[e]=t}(e,t)}}let zh=0;const Bh=new Ot,Nh=new Map,jh=new L,Vh=new H,Hh={default:os,normal:os,additive:as},Wh={double:b,front:dt,back:ns};const Gh=class extends u{init(){this.needsUpdate=!0,this.atlas=this.props.atlas,this.count=this.props.count||200,this.geo=new ts,this.geo.index=Bh.index,this.geo.attributes.position=Bh.attributes.position,this.geo.attributes.uv=Bh.attributes.uv,this.initAttributes(),this.instances=new Set,this.setDynamic(this.props.dynamic);const e=this.getMaterial(this.props);this.base=new T(this.geo,e),this.props.renderOrder&&(this.base.renderOrder=this.props.renderOrder),this.base.frustumCulled=!!this.props.frustumCulled,this.currentCount=0,this.updateAttributes=this.updateAttributes.bind(this)}setDynamic(e){this.dynamic=null==e||!!e,this.interleavedBuffer.setUsage(this.dynamic?ss:StaticDrawUsage),this.interleavedBuffer.needsUpdate=!0,this.needsUpdate=!0}getMaterial(e){const t=e.material;if(!t)return;Nh.has(t)||Nh.set(t,{});const s=Nh.get(t),i=e.atlas;if(!i)return;null==i.meta.atlasIndex&&(i.meta.atlasIndex=++zh);const o=null==e.depthWrite||e.depthWrite,a=null==e.depthTest||e.depthTest,n=null!=e.blending?e.blending:"default",r=null!=e.transparent&&e.transparent,l=null!=e.alphaTest&&e.alphaTest,c=null!=e.side?e.side:"front",h=[i.meta.atlasIndex,c+"",o.toString(),a.toString(),n.toString(),r.toString(),l.toString()].join("_");if(s[h])return s[h];const u={...e};return delete u.material,s[h]=new t({...u,atlas:i,side:Wh[c],blending:"function"==typeof n?n:Hh[n],depthWrite:!!o,depthTest:!!a,transparent:!!r,alphaTest:!!l})}initAttributes(){this.stride=21,this.buffer=new Float32Array(this.count*this.stride);const e=this.geo,t=this.interleavedBuffer=new is(this.buffer,this.stride);e.setAttribute("texCoords",new I(t,4,0,!1)),e.setAttribute("meshCoords",new I(t,4,4,!1)),e.setAttribute("spritePos",new I(t,3,8,!1)),e.setAttribute("decorators",new I(t,2,11,!1)),e.setAttribute("spriteQt",new I(t,4,13,!1)),e.setAttribute("spriteColor",new I(t,4,17,!1)),t.needsUpdate=!0}updateAttributes(e){if(!e||!e.visible)return;const t=this.currentCount++,s=this.buffer,i=this.stride,o=e.sprite.frame;let a=t*i;e.useEuler&&e.quaternion.setFromEuler(e.rotation);let n=e.position,r=e.quaternion,l=e.scale;if(e.parent){const t=e.parent;jh.position.copy(n),jh.quaternion.copy(e.billboard?Vh:r),jh.scale.set(l.x,l.y,1),jh.applyMatrix4(t.matrixWorld),jh.updateMatrixWorld(),n=jh.position,r=jh.quaternion,l=jh.scale}const c=e.billboard?e.angle:r.x;s[a++]=o.texCoords[0],s[a++]=o.texCoords[1],s[a++]=o.texCoords[2],s[a++]=o.texCoords[3],s[a++]=o.meshCoords[0]*e.scale.x,s[a++]=o.meshCoords[1]*e.scale.y,s[a++]=o.meshCoords[2]*e.scale.x,s[a++]=o.meshCoords[3]*e.scale.y,s[a++]=n.x,s[a++]=n.y,s[a++]=n.z,s[a++]=e.billboard?1:0,s[a++]=e.textured?1:0,s[a++]=c,s[a++]=r.y,s[a++]=r.z,s[a++]=r.w,s[a++]=e.color.r,s[a++]=e.color.g,s[a++]=e.color.b,s[a++]=e.alpha}addInstance(e){this.instances.has(e)||this.instances.add(e)}removeInstance(e){this.instances.has(e)&&this.instances.delete(e)}update(){this.dynamic&&(this.currentCount=0,this.instances.forEach(this.updateAttributes),this.geo.instanceCount=this.currentCount,this.interleavedBuffer.needsUpdate=!0,this.base.visible=0!==this.currentCount)}clearInstances(){this.instances.clear()}destroy(){this.clearInstances(),this.geo.dispose(),super.destroy()}};class qh extends se{constructor(e={}){const t=(e={...e}).useAlphaSDF,s=e.atlas;delete e.renderOrder,delete e.useAlphaSDF,delete e.count,delete e.atlas,delete e.renderOrder;const i="function"==typeof e.blending&&e.blending;i&&delete e.blending,super(e),this.uniforms={...ie.merge([oe.fog]),...e.uniforms||{},atlas:{value:s.texture,type:"t"}};const o=this.defines={};e.blending===as&&(o.IS_ADDITIVE_BLENDING=!0),t&&(o.USE_ALPHA_SDF=!0),this.fog=!0,i&&i(this),this.vertexShader="precision highp float;attribute vec4 texCoords;attribute vec4 meshCoords;attribute vec3 spritePos;attribute vec4 spriteQt;attribute vec4 spriteColor;attribute vec2 decorators;varying vec2 vUv;varying vec4 vColor;\n#include <fog_pars_vertex>\n#include <get_instance_matrix>\nvoid main(){vColor=spriteColor;vUv=uv*texCoords.zw+texCoords.xy;vUv.y=1.-vUv.y;vec3 transformed=position;transformed.xy=transformed.xy*meshCoords.zw+(meshCoords.xy*0.5);transformed.xy+=meshCoords.xy*0.5;mat4 instanceMatrix=getInstanceMatrix(spritePos,spriteQt,vec3(1.));vec4 mvPosition=modelViewMatrix*instanceMatrix*vec4(transformed,1.);\n#include <fog_vertex>\nvec4 bbPosition=modelViewMatrix*instanceMatrix*vec4(0.0,0.0,0.0,1.0);bbPosition.x+=cos(spriteQt.x)*transformed.x-sin(spriteQt.x)*transformed.y;bbPosition.y+=sin(spriteQt.x)*transformed.x+cos(spriteQt.x)*transformed.y;mvPosition=mix(mvPosition,bbPosition,decorators.x);gl_Position=projectionMatrix*mvPosition;}",this.fragmentShader="precision highp float;uniform sampler2D atlas;varying vec2 vUv;varying vec4 vColor;\n#include <fog_pars_fragment>\nconst vec3 fogCol=vec3(0.9,1.0,1.0);void main(){vec2 uv=vUv;vec4 color=texture2D(atlas,uv);\n#ifndef IS_ADDITIVE_BLENDING\n#ifdef USE_ALPHA_SDF\ncolor.a=smoothstep(0.87,1.,color.a);color.rgb=mix(color.rgb,vec3(1.),step(color.a,0.95));if(color.a<0.001)discard;\n#else\nif(color.a<0.01)discard;color.rgb/=color.a;\n#endif\n#endif\nfloat alpha=color.a*vColor.a;gl_FragColor=vec4(vColor.rgb*color.rgb,alpha);\n#ifdef USE_FOG\n#ifndef IS_ADDITIVE_BLENDING\ngl_FragColor.rgb=clamp(gl_FragColor.rgb,0.,1.);\n#include <bg_fog>\n#endif\n#endif\n}";let a=null;v((()=>p.app.$store.currentBiome),(e=>{if(e!==a){a=e;const t=e??p.store.biomes.default;Object.assign(this.defines,t.defines),this.needsUpdate=!0}}),{immediate:!0,flush:"sync"})}}const Yh=Object.assign({"/webgl/particlePresets/actionPop.js":xl,"/webgl/particlePresets/actionSmoke.js":Ol,"/webgl/particlePresets/bikeConstantPebbles.js":Cl,"/webgl/particlePresets/bikePebbles.js":Ll,"/webgl/particlePresets/bikeSmoke.js":zl,"/webgl/particlePresets/burst.js":Hl,"/webgl/particlePresets/burstShoes.js":Yl,"/webgl/particlePresets/burstSmoke.js":Ql,"/webgl/particlePresets/carPebbles.js":ic,"/webgl/particlePresets/circleSmoke.js":rc,"/webgl/particlePresets/customSmoke.js":uc,"/webgl/particlePresets/flash.js":bc,"/webgl/particlePresets/healing.js":xc,"/webgl/particlePresets/jetskiBigSplash.js":Oc,"/webgl/particlePresets/jetskiDrops.js":Cc,"/webgl/particlePresets/jetskiRipples.js":Lc,"/webgl/particlePresets/jetskiSmoke.js":Nc,"/webgl/particlePresets/linePop.js":Wc,"/webgl/particlePresets/smokeWheels.js":Kc,"/webgl/particlePresets/speakers.js":Jc,"/webgl/particlePresets/speedLines.js":ih,"/webgl/particlePresets/walk.js":rh,"/webgl/particlePresets/waterConstantSplash.js":uh,"/webgl/particlePresets/waterConstantSplashFront.js":mh,"/webgl/particlePresets/waterRipples.js":bh,"/webgl/particlePresets/waterSplash.js":xh,"/webgl/particlePresets/waterfallLine.js":Th,"/webgl/particlePresets/waterfallSplash.js":Ah}),Kh=Object.entries(Yh).map((([e,t])=>({id:e.split("/").pop().split(".js").shift(),module:t.default})));function Xh(){}const $h={},Zh={},Jh={};let Qh=0;function eu(e){try{return e.stop(),!1}catch(t){return!0}}function tu(e){return $h[e]||($h[e]=new Promise((t=>{const s=new XMLHttpRequest;s.open("GET",e,!0),s.responseType="arraybuffer",s.onload=async()=>{t(s.response)},s.send()}))),$h[e]}function su(e,t){return e?Jh[t]?Promise.resolve(t):(Zh[t]||(Zh[t]=new Promise((s=>{tu(t).then((i=>{e.decodeAudioData(i,(e=>{Jh[t]=e,s(t),Zh[t]=null}))}))}))),Zh[t]):tu(t)}class iu{constructor(e){this.onEnded=this.onEnded.bind(this),this.onLoaded=this.onLoaded.bind(this),this.controller=e,this.context=e.getContext(),this.input=null,this.output=this.context.createGain()}reset(e={}){this.onStop=null,this.stop(),this.pausedProgress=0,this.fadein=e.fadein||0,this.fadeout=e.fadeout||0,this.fadeinTimer=0,this.fadeoutTimer=0,this.fadeinActive=!1,this.fadeoutActive=!1,this.needsPlay=!1,this.isPlaying=!1,this.isStopping=!1,this.hasEnded=!1,this.loaded=!1,this.stopped=!1,this.fixedTimeStep=0,this.id=e.id||null,this.clearBuffer(),this.source=null,this.buffer=null,this.loop=!!e.loop,this.autoplay=!!e.autoplay,this.playbackRate=e.playbackRate||1,this.volume=null!=e.volume?e.volume:1,this.realvolume=-1,this.loopStart=e.loopStart||0,this.loopEnd=e.loopEnd||0,this.onStop=e.onStop||Xh,this.baseOffset=e.start||e.baseOffset||0,this.duration=e.duration;const t=e.input||this.controller.getInput();t!==this.input&&(this.input&&this.output.disconnect(this.input),this.input=t,this.output.connect(this.input)),this.path=e.path;let s=this.requestID=++Qh;Jh[this.path]?this.onLoaded(this.path):su(this.context,e.path).then((e=>{(this.requestID=s)&&this.onLoaded(e)})),this.autoplay&&this.play()}onLoaded(e){if(this.isStopping||this.stopped)return this.realstop();if(this.stopped)return this.realstop();const t=Jh[e];this.loaded=!0,this.buffer=t,this.needsPlay&&this.play()}onEnded(){this.loop||(this.hasEnded=!0,this.stop())}getOutput(){return this.output}update(e){if(!this.source)return;this.fixedTimeStep&&(e=this.fixedTimeStep);let t=this.volume;if(this.fadeinActive){this.fadeinTimer+=e;const s=U(this.fadeinTimer/this.fadein,0,1);t*=s,1===s&&(this.fadeinActive=!1)}if(this.fadeoutActive){this.fadeoutTimer+=e;const s=U(1-this.fadeoutTimer/this.fadeout,0,1);t*=s,0===s&&this.realstop()}t!==this.realvolume&&this.setVolume(t)}play(){if(this.source&&this.stop(),!this.loaded)return void(this.needsPlay=!0);const e=this.source=this.context.createBufferSource();if(e.buffer=this.buffer,e.onended=this.onEnded,this.startTime=this.context.currentTime,this.isPlaying=!0,this.needsPlay=!1,!e||!e.buffer)return this.stop();this.progressStart=this.startTime-this.offset,this.duration||(this.duration=e.buffer.duration);const t=Math.max(this.duration-this.offset,.01);this.connect(),this.setLoop(this.loop);const s=function(e,t,s,i){try{return e.start(t,s,i),!1}catch(o){return!0}}(this.source,this.startTime,(this.baseOffset+this.offset)%e.buffer.duration,this.loop?void 0:t);s?requestAnimationFrame((()=>this.stop())):(this.fadein&&0===this.fadeinTimer?this.setVolume(0,!0):this.setVolume(this.volume,!0),this.fadein&&(this.fadeinActive=!0),this.setPlaybackRate(this.playbackRate))}getCurrentTime(){return this.getProgress()*this.duration}getProgress(){return this.isPlaying?(this.context.currentTime-this.progressStart)/this.duration:this.pausedProgress}connect(){this.source.connect(this.getOutput())}disconnect(){this.source.disconnect(this.getOutput())}clearBuffer(){this.context&&this.context.clearBufferSource?this.source&&this.context.clearBufferSource(this.source):this.source&&(this.source.disconnect(0),this.source.onended=null),this.source=null}pause(){this.pausedProgress=this.getProgress(),this.offset+=(this.context.currentTime-this.startTime)*this.playbackRate,this.needsPlay=!1,this.isPlaying=!1,this.source&&(eu(this.source),this.clearBuffer())}realstop(){this.onStop&&this.onStop(this),this.onStop=null,this.offset=0,this.needsPlay=!1,this.isPlaying=!1,this.isStopping=!1,this.fadeinActive=!1,this.fadeoutActive=!1,this.stopped=!0,this.source&&(eu(this.source),this.clearBuffer())}stop(e={}){if(!this.isStopping){if(this.isStopping=!0,!this.source||!this.loaded)return this.realstop();e.fadeout&&(this.fadeout=e.fadeout),this.fadeout?this.fadeoutActive=!0:this.realstop()}}getPlaybackRate(){return this.playbackRate}setPlaybackRate(e){this.playbackRate=e,this.isPlaying&&this.source&&this.source.playbackRate.setTargetAtTime(this.playbackRate,this.context.currentTime,.01)}getLoop(){return this.loop}setLoop(e){this.loop=e,this.isPlaying&&this.source&&(this.source.loop=this.loop,this.source.loopStart=this.loopStart,this.source.loopEnd=this.loopEnd)}getVolume(){return this.output.gain.value}setVolume(e,t,s=.01){this.realvolume=e,t&&(this.output.gain.value=this.realvolume),this.output.gain.setTargetAtTime(this.realvolume,this.context.currentTime,s)}release(){iu.release(this)}}iu.pool=[],iu.get=function(e,t){const s=iu.pool.shift()||new iu(e);return s.reset(t),s},iu.release=function(e){e.clearBuffer(),e.buffer=null,e.onStop=null,iu.pool.length<50&&iu.pool.push(e)};const ou=window.performance||window.Date,au=["click","touchstart","touchend","keydown"],nu=window.AudioContext||window.webkitAudioContext;let ru=null,lu=!1;const cu={initialized:!1,unlocked:!1,unlockerListening:!0,lastStuckCheck:ou.now(),stuckTimer:0,previousWebAudioTime:0},hu={onContextCreation:null,onUnlock:null,onStuck:null};let uu=window.navigator.vendor.includes("Apple");function du(){cu.unlocked||(!function(){if(ru)return;ru=function(){try{return(new nu).close(),new nu}catch(e){return null}}();const e=ru.scratchBuffer=ru.createBuffer(1,1,22050);ru.clearBufferSource=t=>{if(t&&(t.onended=null,t.disconnect(0),uu))try{t.buffer=e}catch(s){}},cu.initialized=!0,hu.onContextCreation&&hu.onContextCreation(ru);fu()}(),ru.suspend(),window.setTimeout((()=>ru.resume()),10),function(){cu.unlockerListening=!1;for(const e of au)document.removeEventListener(e,du,{passive:!0})}(),cu.unlocked=!0,cu.stuckTimer=-800,cu.lastStuckCheck=ou.now(),hu.onUnlock&&hu.onUnlock())}function pu(){cu.unlocked=!1,cu.unlockerListening=!0;for(const e of au)document.addEventListener(e,du,{passive:!0})}function fu(){window.requestAnimationFrame(fu);const e=ou.now(),t=e-cu.lastStuckCheck;if(!cu.initialized||!ru||t<400)return;const s=ru.currentTime,i=s===cu.previousWebAudioTime;cu.stuckTimer=i?cu.stuckTimer+t:0,cu.previousWebAudioTime=s,cu.lastStuckCheck=e,cu.stuckTimer>400&&cu.unlocked&&!cu.unlockerListening&&(pu(),hu.onStuck&&hu.onStuck())}const mu={init:function(){cu.initialized||(function(e){const t=new ArrayBuffer(10),s=new DataView(t);s.setUint32(0,e,!0),s.setUint32(4,e,!0),s.setUint16(8,1,!0),window.btoa(String.fromCharCode(...new Uint8Array(t))).slice(0,13)}(44100),pu(),async function(){await void 0&&du()}())},getVolume:function(e){return e.gain.value},setVolume:function(e,t){e.gain.setValueAtTime(t,ru.currentTime)},getContext:()=>ru,isUnlocked:()=>cu.unlocked,set debug(e){lu=e},set onContextCreation(e){hu.onContextCreation=e},set onUnlock(e){hu.onUnlock=e},set onStuck(e){hu.onStuck=e}},gu="/assets/audiosprites.5d69e49165453426.m4a",yu={};JSON.parse('[["music_minigame_jingle",0,1.9355,1.9355],["sfx_UI_Dialog_CameraMove_In",2.0355,2.4533,0.4178],["sfx_UI_Dialog_CameraMove_Out",2.5533,2.8976,0.3443],["sfx_UI_coastalPoints",2.9976,4.3615,1.3639],["sfx_UI_customPlayer_changeAccessories_body",4.4615,4.571,0.1096],["sfx_UI_customPlayer_changeAccessories_bottom",4.671,4.7788,0.1078],["sfx_UI_customPlayer_changeAccessories_head",4.8788,4.9884,0.1096],["sfx_UI_customPlayer_changeColor",5.0884,5.1517,0.0633],["sfx_UI_customPlayer_changeFace",5.2517,5.4016,0.1499],["sfx_UI_customPlayer_open",5.5016,5.914,0.4124],["sfx_UI_customPlayer_shuffle",6.014,6.3996,0.3856],["sfx_UI_customPlayer_validate",6.4996,7.0085,0.5089],["sfx_UI_dialog_answer",[[7.1085,7.2848,0.1763]]],["sfx_UI_dialog_next",[[7.3848,7.4883,0.1035]]],["sfx_UI_dialog_opendialog",[[7.5883,7.7111,0.1228]]],["sfx_UI_notif_NPCcall",[[7.8111,8.1144,0.3033],[8.2144,8.5177,0.3033],[8.6177,8.921,0.3033]]],["sfx_UI_notif_quest_object",[[9.021,9.2419,0.2209]]],["sfx_UI_transition_close",[[9.3419,9.9492,0.6073]]],["sfx_UI_transition_open",[[10.0492,10.654,0.6049]]],["sfx_dialog_syllab",[[10.754,10.9083,0.1542],[12.0128,12.159,0.1463],[12.259,12.4225,0.1635],[12.5225,12.6964,0.1739],[12.7964,12.9626,0.1663],[13.0626,13.2184,0.1557],[13.3184,13.4665,0.1481],[13.5665,13.7201,0.1536],[13.8201,13.9703,0.1502],[11.0083,11.1581,0.1499],[11.2581,11.4015,0.1434],[11.5015,11.6575,0.156],[11.7575,11.9128,0.1553]]],["sfx_minigame_bike_drift",14.0703,19.3375,5.2672],["sfx_minigame_bike_impact",[[19.4375,20.1613,0.7237],[20.2613,20.985,0.7237],[21.085,21.7661,0.6811]]],["sfx_minigame_bike_land",21.8661,22.7811,0.915],["sfx_minigame_bike_loop",22.8811,27.8968,5.0156],["sfx_minigame_boat_drift",27.9968,32.7799,4.7831],["sfx_minigame_boat_impact",[[32.8799,34.5303,1.6504],[34.6303,36.0418,1.4115],[36.1418,37.5378,1.396]]],["sfx_minigame_boat_loop",37.6378,41.6378,4],["sfx_minigame_car_impact",[[41.7378,42.3593,0.6215],[42.4593,43.0809,0.6215],[43.1809,43.8024,0.6215]]],["sfx_minigame_car_loop",[[43.9024,47.2301,3.3277]]],["sfx_minigame_car_tireSkid",[[47.3301,48.903,1.5728]]],["sfx_minigame_countdown_go",49.003,50.503,1.5],["sfx_minigame_countdown_number",50.603,51.603,1],["sfx_minigame_finish",51.703,53.785,2.082],["sfx_minigame_jetSki_land",[[53.885,55.8196,1.9347],[55.9196,57.8543,1.9347],[57.9543,59.889,1.9347]]],["sfx_minigame_jetSki_loop",59.989,63.989,4],["sfx_minigame_jetSki_rampTouch",[[64.089,65.1557,1.0667],[65.2557,66.2224,0.9667],[66.3224,67.289,0.9667]]],["sfx_minigame_result_lose",67.389,70.1988,2.8098],["sfx_minigame_result_win",70.2988,75.9183,5.6195],["sfx_phone_claim",76.0183,77.1137,1.0954],["sfx_phone_click_medium",77.2137,77.4663,0.2526],["sfx_phone_click_soft",77.5663,77.7144,0.1482],["sfx_phone_close",77.8144,78.2937,0.4792],["sfx_phone_open",78.3937,79.1201,0.7264],["sfx_phone_scroll_tic",79.2201,79.2368,0.0167],["sfx_phone_swipe",79.3368,79.7661,0.4294],["sfx_player_footsteps",[[79.8661,80.0217,0.1556],[80.1218,80.2774,0.1556],[80.3774,80.533,0.1556],[80.633,80.7886,0.1556],[80.8886,81.0443,0.1556],[81.1442,81.2999,0.1556],[81.3999,81.5555,0.1556],[81.6555,81.8111,0.1556],[81.9111,82.0667,0.1556]]],["sfx_player_footsteps_water",[[82.1667,82.6916,0.5249],[82.7916,83.3165,0.5249],[83.4165,83.9413,0.5249],[84.0413,84.5662,0.5249],[84.6662,85.191,0.5249],[85.291,85.8159,0.5249],[85.9159,86.4407,0.5249],[86.5407,87.0656,0.5249],[87.1656,87.6904,0.5249]]],["sfx_player_jetpack_loop",87.7904,91.7964,4.006],["sfx_quest_Skatepark_cleaned",[[91.8964,93.8877,1.9912]]],["sfx_quest_Skatepark_interact_loop",[[93.9877,94.6466,0.659]]],["sfx_quest_bridge_repair",[[94.7466,96.074,1.3273]]],["sfx_quest_chest_lockpick_loop",[[96.174,97.092,0.918]]],["sfx_quest_chest_open",[[97.192,98.2603,1.0683]]],["sfx_quest_compas_interact_loop",98.3603,99.4515,1.0912],["sfx_quest_completed_close",99.5515,100.0352,0.4838],["sfx_quest_completed_main",100.1352,101.3182,1.183],["sfx_quest_completed_side",101.4182,102.6012,1.183],["sfx_quest_completed_super",102.7012,108.0649,5.3636],["sfx_quest_getObject",108.1649,110.4251,2.2603],["sfx_quest_hammerImpact",[[110.5251,110.6365,0.1113],[110.942,111.0476,0.1056],[111.1476,111.2532,0.1056],[111.3532,111.4587,0.1056],[111.5587,111.6555,0.0968],[111.7555,111.861,0.1056],[111.961,112.0666,0.1056],[112.1666,112.2722,0.1056],[112.3722,112.4777,0.1056],[110.7365,110.842,0.1056]]],["sfx_quest_healing_done",112.5777,114.3936,1.8158],["sfx_quest_healing_interact_loop",114.4936,115.6936,1.2],["sfx_quest_house_build",[[115.7936,117.4248,1.6312]]],["sfx_quest_inauguration",[[117.5248,120.1122,2.5874]]],["sfx_quest_inauguration_interact_loop",[[120.2122,120.6922,0.48]]],["sfx_quest_lighthouse_build",[[120.7922,123.5056,2.7134]]],["sfx_quest_lighthouse_interact_loop",123.6056,124.9242,1.3186],["sfx_quest_locked",125.0242,125.3778,0.3536],["sfx_quest_plant_grow",[[125.4778,126.5305,1.0527]]],["sfx_quest_plant_interact_watering_loop",[[126.6305,127.3419,0.7113]]],["sfx_quest_progress",127.4419,128.4822,1.0403],["sfx_quest_scissors_interact",[[128.5822,128.6964,0.1142],[128.7964,128.8962,0.0998],[128.9962,129.1078,0.1115],[129.2078,129.322,0.1142],[129.422,129.5362,0.1142]]],["sfx_quest_screwdriver_interact_loop",129.6362,131.4168,1.7806],["sfx_quest_shop_open",131.5168,133.198,1.6812],["sfx_quest_sono_interact_loop",[[133.298,137.298,4]]],["sfx_quest_sono_loop",137.398,146.9994,9.6014],["sfx_quest_sono_turnedOn",[[147.0994,148.7302,1.6308]]],["sfx_quest_zipline_interact_done",148.8302,150.0302,1.2],["sfx_quest_zipline_interact_loop",150.1302,151.4636,1.3333],["sfx_quest_zipline_jumpGrab",151.5636,152.6302,1.0667],["sfx_quest_zipline_slide_end",152.7302,153.6636,0.9333],["sfx_quest_zipline_slide_loop",153.7636,157.7636,4],["sfx_secret_interact_tamtam_loop",157.8636,160.2636,2.4],["sfx_telescope_cameraMovement",160.3636,161.279,0.9154],["sfx_travel_taxi_klaxon",161.379,161.7508,0.3718],["sfx_travel_taxi_loop",161.8508,164.06,2.2092]]').forEach((([e,t,s,i])=>{yu[e]=Array.isArray(t)?{id:e,path:gu,variations:t.map((t=>({id:e,start:t[0],end:t[1],duration:t[2]})))}:{id:e,path:gu,start:t,end:s,duration:i}})),yu.music_intro={path:"/assets/music_intro.552fc27765453426.m4a",unique:!0},yu.music_island_east={path:"/assets/music_island_east.39dc426365453426.m4a",unique:!0},yu.music_island_four={path:"/assets/music_island_four.4cbbfea965453426.m4a",unique:!0},yu.music_island_north={path:"/assets/music_island_north.cb7f8dae65453426.m4a",unique:!0},yu.music_island_west={path:"/assets/music_island_west.ee940d9a65453426.m4a",unique:!0},yu.music_minigame_loop={path:"/assets/music_minigame_loop.44a6ebcf65453426.m4a",unique:!0},yu.music_secret={path:"/assets/music_secret.3a1d5b4165453426.m4a",unique:!0},yu.sfx_amb_beach_loop={path:"/assets/sfx_amb_beach_loop.be1083c965453426.m4a",unique:!0},yu.sfx_amb_forestBird_loop={path:"/assets/sfx_amb_forestBird_loop.d09bb86465453426.m4a",unique:!0},yu.sfx_amb_main_loop={path:"/assets/sfx_amb_main_loop.01a57afe65453426.m4a",unique:!0},yu.sfx_amb_waterfall_loop={path:"/assets/sfx_amb_waterfall_loop.e183d30165453426.m4a",unique:!0};const bu=yu,vu=.05*Math.log(10);const wu=e=>{return t=e+0,Math.exp(t*vu);var t},_u=(e,t)=>Object.assign(bu[e],t);_u("sfx_UI_notif_NPCcall",{volume:wu(-8)}),_u("sfx_player_jetpack_loop",{loop:!0,fadein:600,fadeout:500});const xu={loop:!0,fadein:200,fadeout:200};function Su(e,t){let s=0,i=null,o=null,a=null;let n=0,r=!1;return t.unlocked.watchImmediate((function(e){if(c(),!e)return;i&&h()})),ue.add((function(s){if(!t.unlocked.value)return;const i=e.store.isOverlayVisible.value,a=e.store.inDialog.value,l=e.store.isDuckingBgm.value;let c=.43;c*=i||a||l?.29:1,c*=e.store.isMutingBgm.value?0:1,c*=rs.getMuteStrength(),r&&(c*=0);n=ls(n,c,.08,s),o&&(o.volume=n)})),{preload:l,play:async function(e){c();const a=++s;if(o&&i===e)return;if(await l(e),a!==s)return;i=e,t.unlocked.value&&h()},stop:c,suspend:e=>r=e};function l(e){return t.preloadSound(e)}function c(e){e&&e!==i||(o&&o.stop(),o=null)}function h(){a&&(a.realstop(),a=null),o=t.playSound(i,{volume:n,loop:!0}),a=o}}_u("sfx_quest_plant_interact_watering_loop",{...xu}),_u("sfx_quest_chest_lockpick_loop",{...xu}),_u("sfx_quest_Skatepark_interact_loop",{...xu}),_u("sfx_quest_healing_interact_loop",{...xu}),_u("sfx_quest_sono_interact_loop",{...xu}),_u("sfx_quest_screwdriver_interact_loop",{...xu}),_u("sfx_quest_compas_interact_loop",{...xu}),_u("sfx_quest_lighthouse_interact_loop",{...xu}),_u("sfx_quest_Skatepark_interact_loop",{...xu}),_u("sfx_secret_interact_tamtam_loop",{...xu}),_u("sfx_quest_zipline_interact_loop",{...xu}),_u("sfx_travel_taxi_loop",{loop:!0}),_u("sfx_minigame_boat_loop",{loop:!0}),_u("sfx_quest_zipline_slide_loop",{loop:!0,fadein:200,fadeout:300}),_u("music_intro",{loop:!0,fadein:1e3,fadeout:1500}),_u("music_island_east",{loop:!0,fadein:1e3,fadeout:1500}),_u("music_island_west",{loop:!0,fadein:1e3,fadeout:1500}),_u("music_island_north",{loop:!0,fadein:1e3,fadeout:1500}),_u("music_island_four",{loop:!0,fadein:1e3,fadeout:1500}),_u("music_minigame_loop",{loop:!0,fadein:100,fadeout:700}),_u("sfx_quest_sono_loop",{loop:!0,fadein:200,fadeout:400}),_u("music_minigame_jingle",{volume:wu(-2)}),_u("sfx_minigame_result_win",{volume:wu(-2)});const Mu=(e,t)=>void 0!==e?e:t;const Tu=["INPUT","SELECT","TEXTAREA","A","BUTTON"].reduce(((e,t)=>(e[t]=1,e)),{}),Ou=void 0!==window.visualViewport&&void 0!==window.visualViewport.scale;function Pu(e){return!!e&&(!e.target||!function(e){if(!e)return!1;const t=e.tagName;return!!(!p.app.$router.currentRoute.value.meta.playerCanMove||Tu[t]||Ou&&1!==window.visualViewport.scale)||!!p.app.$store.isDialogVisible||!(!e.dataset||null==e.dataset.bypassTouch)}(e.target))}let Au,Iu,Cu=0;const Ru=()=>Au=!1;function ku(){Au=!0,clearTimeout(Iu),Iu=setTimeout(Ru,200)}const Du=["KeyS","KeyW","KeyD","KeyA","Space","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].reduce(((e,t)=>(e[t]=1,e)),{}),Lu=["TEXTAREA"].reduce(((e,t)=>(e[t]=1,e)),{}),Eu=void 0!==window.visualViewport&&void 0!==window.visualViewport.scale;function Fu(e){return!!e&&(!e.target||!function(e){if(!e)return!1;const t=e.tagName;return!!(!p.app.$router.currentRoute.value.meta.playerCanMove||Lu[t]||Eu&&1!==window.visualViewport.scale)||!!p.app.$store.isDialogVisible||!(!e.dataset||null==e.dataset.bypassKeyboard)}(e.target))}function Uu(e){const t={...Du},s={pressedKeys:t,unpressAllKeys:a,pressedCount:0};a(),s.pressedCount=0;const i={passive:!1};return window.addEventListener("keydown",(function(e){if(!Du[e.code])return;if(!Fu(e))return;e.preventDefault(),function(e){if(t[e])return;t[e]=!0,s.pressedCount++}(e.code)}),i),window.addEventListener("keyup",(function(e){if(!Du[e.code])return;o(e.code)}),i),window.addEventListener("mousedown",a,{passive:!0}),window.addEventListener("blur",a,!1),window.addEventListener("contextmenu",a,!1),v((()=>e.app.$store.isDialogVisible),a),v((()=>e.app.$store.isOverlayVisible),a),v((()=>e.app.$store.isApiErrorVisible),a),v((()=>e.app.$store.isTransitionActive),(e=>e&&a())),v((()=>e.app.$store.isFormOpen),a),v((()=>e.app.$store.isMenuOpen),a),s;function o(e){t[e]&&(t[e]=!1,s.pressedCount=Math.max(s.pressedCount-1,0))}function a(){for(let e in t)o(e)}}const zu=[function(e){const t=de(20),s=de(6);let i=!1,o=performance.now();const a=de(20);let n=0,r=0,l=0;const c=de(6);e.hooks.afterInit.watchOnce((()=>{e.viewport&&e.viewport.visible.watch((()=>i=!0))})),e.hooks.afterFrame.watchOnce((()=>{i=!0}));const h=e.time={dt:0,qualityDt:0,clampedDt:0,averageDt:16.6667,stableDt:16.6667,elapsed:0,pausedElapsed:0,frameNum:0,isPaused:!0,isStarted:!0,clampFps:0,set clampTo60Fps(e){h.clampFps=e?60:0},init:function(){h.customLoop?h.customLoop(u):ue.add(u);h.isStarted=!0,h.isPaused=!1},start:function(){h.isStarted=!0},stop:function(){h.isStarted=!1},resume:function(){h.isPaused=!1},pause:function(){h.isPaused=!0},customLoop:null};function u(u){const d=o;if(o=performance.now(),0===(u=o-d)&&(u=16.6667),i&&(i=!1,u=16.6667,t.reset(),s.reset(),c.reset(),r=n=l=0,a.reset()),h.clampFps>0){const e=a.push(u),t=1e3/h.clampFps,s=Math.max(0,t-e);if(r+=s,r>=t)return n=0,r=Math.max(0,r-t),void(l+=u);n>=10?r=n=0:n+=1,u+=l,l=0}h.qualityDt=c.push(u),h.clampedDt=U(void 0===u?16.6667:u,1,130),h.averageDt=t.push(u);let p=h.averageDt;for(let e=0,t=fa.length;e<t;e++){const t=fa[e];if(p>=t[2]){p<=t[0]&&(p=t[1]);break}}h.stableDt=s.push(p),h.dt=u,h.frameNum=(h.frameNum+1)%pa,h.elapsed+=u,h.isStarted&&(h.isPaused||(h.pausedElapsed+=u),e.frame())}},function(e){let t;const s=new V(16777215),i=pe(new r),o=pe(1);let n=1,l=2,c=ma["3k"];const h={antialias:!1,alpha:!1,depth:!0,stencil:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance"},u={beforeInit:a(),afterInit:a()},d=e.renderer={init:function(){h.canvas=e.options.canvas,u.beforeInit.emit();const o=d.forceWebGL1?fe:me;t=new o(h),t.debug={checkShaderErrors:!1},e.renderer.instance=t,e.threeRenderer=t,d.isWebGL2=!!t.capabilities.isWebGL2,t.getDrawingBufferSize(i.value),m(),t.setClearColor(s,1),t.autoClear=!1,t.shadowMap.enabled=!1,t.shadowMap.type=ge,t.info.autoReset=!1,e.hooks.beforeFrame.watch((()=>t.info.reset())),u.afterInit.emit(),e.viewport.changed.watch(m)},options:h,hooks:u,clearColor:s,resize:m,setMinPixelRatio:function(e){if(n===e)return;n=e,f()},setMaxPixelRatio:function(e){if(l===e)return;l=e,f()},setMaxPixelCount:function(e){if("string"==typeof e){if(!(e=ma[e.toLowerCase()]))return}else null==e&&(e=0);c=e,f()},drawingBufferSize:i,pixelRatio:o,forceWebGL1:!1};let p=!1;function f(){p||(p=!0,e.hooks.beforeFrame.watchOnce(m))}function m(){p=!1;let s=U(e.viewport.pixelRatio.value,n,l);const a=e.viewport.size.value,h=r.get();let u=s*a.x*a.y;c>0&&u>c&&(s/=u/c),t.getSize(h),t.getPixelRatio()!==s&&t.setPixelRatio(s),h.equals(a)||t.setSize(a.x,a.y),function(){const e=i.value,s=r.get();t.getDrawingBufferSize(s),ye(),s.equals(e)||i.set(e.copy(s),!0);o.set(t.getPixelRatio()),s.release(),be()}(),h.release()}},function(e){const t=e.app.$viewport,s=pe(new r(t.width,t.height)),i=pe(s.value.x/s.value.y),o=pe(t.pixelRatio),n=pe(t.visible),l=a();e.viewport={size:s,visible:n,ratio:i,pixelRatio:o,changed:l,resize:p,useManualResize:!1,frame:f};let c=0,h=0,u=0;const d=ve((()=>(c=t.width,h=t.height,void(u=t.pixelRatio))),150);function p(s,i){e.options.canvas.style.width=t.width+"px",e.options.canvas.style.height=t.height+"px",d()}function f(){const e=s.value,t=e.x!==c||e.y!==h,a=o.value!==u;(t||a)&&(ye(),t&&(e.set(c,h),s.set(e,!0),i.set(e.x/e.y)),a&&o.set(u),l.emit(),be())}v(t,(()=>{e.viewport.useManualResize||p(t.width,t.height)}),{immediate:!0}),we((()=>{n.set(t.visible)})),e.hooks.beforeFrame.watch(f)},function(e){const t="webgl_quality",s=300,i=2,o=5;let a=58,n=52,r=30,l=s,c=s,h=0,u=0,d=!1,p=!1,f=o,m=o,g=10;const y=new Float64Array(3);let b=0;const v=new Float64Array([-1,-1,-1]);let w=0,_=0,x=!1;const S=pe(60),M=pe(60),T=pe(1);function O(e,t){d=!0,p=p||e,t&&(l=t)}function P(){if(g>0)return g--;const t=e.time.qualityDt;if(d&&(h=0,u=0,p&&(f=o,b=0,w=0,_=0),c=l||s,d=p=!1,l=s),c>0)return c-=t;h+=t,u++,h>=1e3&&function(){x||(y[b++]=u,b%=y.length+1);S.set(u),u=0,h%=1e3,x||b!=y.length||I()}()}function A(e){v[2]=v[1],v[1]=v[0],v[0]=e,T.set(e)}function I(e){let t=v[0];const s=_e(y);e?t=e:s<=r?t-=2:s<n?t-=1:s>a&&(t+=1),t=U(t,0,Math.min(m,f)),t===v[0]?(w=Math.max(0,w-.2),_=Math.max(0,_-.2)):t!==v[0]&&t!==v[1]?w=0:t===v[1]&&(w+=1),t===v[2]&&t<v[0]&&_++,w>=i&&(f=Math.min(v[1],v[0],f,m),w=0),_>=i&&(f=Math.min(_e(v),f,m),_=0),t=Math.min(t,f,m),t!==T.value&&A(t),M.set(s)}return e.hooks.afterInit.watchOnce((function(){const s=e.app.$device,i=s&&s.gpu?s.gpu.qualityIndex:3,o=function(){const e=localStorage.getItem(t);return null==e||isNaN(e)?null:0|e}(),a=null!=o?o:i;T.watch((e=>{s&&s.updateQuality(e),function(e){localStorage.setItem(t,e)}(e)})),A(a),e.hooks.beforeFrame.watch(P)})),e.hooks.beforeStart.watchOnce((async function(){e.viewport.visible.watch((()=>O()));const t=e.viewport.size.value;let i=t.x*t.y;e.viewport.changed.watch((()=>{const t=e.viewport.size.value,o=t.x*t.y;Math.abs(i-o)<2e5?O(!1,s):(i=o,O(!0,s))}))})),e.quality={get pingPongScore(){return w},get bigPingPongScore(){return _},fps:S,fpsAverage:M,quality:T,current:T,pause:function(){x=!0},resume:function(e=150){x=!1,O(!1,e)},reset:(e=300)=>O(!1,e),hardReset:(e=300)=>O(!0,e),updateQuality:I,limitQuality:e=>{m=U(e,0,o),I()},setThresholds:function(e={}){e.high&&(a=e.high);e.low&&(n=e.low);e.critical&&(r=e.critical)}}},function(e){const t={createBuffer:function(e){return ba(e)},registerBuffer:Sa,unregisterBuffer:Sa};e.fbo=t},function(e,{log:t}){const s=e.resources={prepare:async function(){const t=e.app.$preloader.createTask({weigh:4}),i=s.manifest=e.app.$manifest.content;for(let e in Pt)i.scenes[e]||delete Pt[e];await s.supercache.init(),t.finish()},manifest:{},assets:{},scenes:{},actors:Tt,textures:{},use:M.use,unuse:M.unuse,disposeAll:M.disposeAll,geometries:{plane:new Ot}};!function(e,t,{log:s}){const i="__cache__";let o="65453426",a=null;Object.assign(t,{supercache:{init:async function(){if(!window.caches||!window.Cache)return;o+="_"+t.manifest.timestamp;const[e,i]=await Promise.all([caches.open(o),caches.keys()]);a=window.noSupercache?null:e,a&&s("Use supercache "+o),await Promise.all(i.map((e=>{if(window.noSupercache||e!==o)return caches.delete(e)})))},add:async function(e,t){if(a)return!(e=i+e).endsWith(".json")||"object"!=typeof t||t instanceof Blob||(t=new Blob([JSON.stringify(t)],{type:"application/json;charset=UTF-8"})),!e.endsWith(".dat")||"object"!=typeof t||t instanceof Blob||(t=new Blob([t.buffer],{type:"application/octet-stream"})),t instanceof Response||(t=new Response(t,{status:200,statusText:"ok"})),a.put(e,t)},get:async function(e,{type:t}={}){if(a){e=i+e;try{const s=await a.match(e);if(!s)return!1;let i=!1;return i="blob"===t?await s.blob():"json"===t?await s.json():"text"===t?await s.text():e.endsWith(".dat")?await s.arrayBuffer():e.endsWith(".json")?await s.json():await s.arrayBuffer(),i}catch(s){return!1}}}}})}(0,s,{log:t}),Vn(e,s,{log:t})},function(e,{log:t}){const s=new n(.5,.5),i={value:new j(0,0,1,-1)},o={value:0},a={circleParams:i,circleProgress:o};e.transitions={uniforms:a,update:l,circleIn:function(e,t){r&&r.isOut&&(r=r.destroy());return r&&!r.destroyed||(h(e,t,!1),r=x({target:o,property:"value",duration:500,from:0,to:1,easing:"inOutQuart",onComplete:u}),r.isIn=!0),r.finished},circleOut:function(e,t){r&&r.isIn&&(r=r.destroy());return r&&!r.destroyed||(h(e,t,!0),r=x({target:o,property:"value",duration:800,from:0,to:1,easing:"inOutQuart",onComplete:u}),r.isOut=!0),r.finished}};let r=null;function l(){if(e.time.isPaused)return;const t=e.time.dt;r&&r.update(t)}function c(){const{x:t,y:o}=e.viewport.size.value,a=s,n=i.value,r=n.x=a.x*t,l=n.y=a.y*o;n.z=Math.max(At(r,l,0,0),At(r,l,t,0),At(r,l,t,o),At(r,l,0,o))}function h(t,o,a){const{x:n,y:r}=e.viewport.size.value;t=null==t?.5:t/n,o=null==o?.5:o/r,s.set(t,o),i.value.w=a?1:-1,c()}function u(){o.value=1.01}e.hooks.afterInit.watch((()=>{e.viewport.size.watchImmediate(c),e.hooks.beforeUpdate.watch(l)}))},function(e,{log:t}){t=()=>{};let s="IslandWest",i=null,o=pe(Object.keys(Pt)[0]),a=Et();e.scenes={list:Pt,currentSceneID:o,get current(){return i},init:async function(){const t=e.savestate.game.currentScene;Pt[t]&&o.set(t);e.savestate.getVariable("isIntroCompleted")||o.set("IslandIntro");o.watch((t=>{const i=Pt[t];i.savePosition&&(e.savestate.game.currentScene=t),i.savePosition&&(s=t)}));const i=e.app.$store.overrideSpawnPoint;c(o.value,{point:i&&i.point,noAnimation:!0}),e.app.$store.overrideSpawnPoint=null,await a},start:function(){},update:function(){if(!i)return;i.triggerUpdate()},render:function(){if(!i)return;i.triggerRender()},teleportTo:c,backToIsland:function(e={}){c(s,e)}};let n=0,r=0,l=null;async function c(s,c={}){const h=Pt[s];if(!h)return;const u=s+"_"+(c.point||"Spawn");if(performance.now()-r<5e3&&u===l)return;l=u,e.store.isTransitionActive.set(!0);const d=++n,p=!i||c.noAnimations;if(i&&i.isCircuitScene&&e.app.$circuit.setStatus("Exiting"),c.delay&&await W(c.delay),d!==n)return;if(i&&i.props.id===s){if(p||await e.transitionScene.loaderIn("road"),d!==n)return;return i.teleportPlayer&&(await i.teleportPlayer(c.point),o.set(s)),p||await e.transitionScene.loaderOut(),void e.store.isTransitionActive.set(!1)}if(e.store.interactionButton.set(null),e.audio.bgm.stop(),!p){const t=Pt[o.value].props,s=h.props.transition||t.transition||"sea";await e.transitionScene.loaderIn(s)}if(h.props.bgm&&e.audio.bgm.preload(h.props.bgm),d!==n)return;if(p||await Ft.promise(50),i&&(i.destroy(),i=null,await Ft.promise(50),d!==n))return;if(await Er(h,{log:t}),d!==n)return;const f={...h.props};c.point&&(f.spawnPoint=c.point),f.alreadyVisited=e.savestate.getVariable("hasVisited"+h.props.id);const m=new h.class(f);m.load&&await m.load(),d===n&&(h.props.pageview&&e.app.$analytics.pageview(h.props.pageview),h.props.route&&e.app.$router.push({name:h.props.route}),i=m,i.triggerInit(),o.set(s),p||await Ft.promise(10),d===n&&(i.triggerUpdate(),p||await Ft.promise(20),d===n&&(await i.triggerPrerender(),p||await Ft.promise(50),i.beforeEnter&&i.beforeEnter(),p||await e.transitionScene.loaderOut(),i.afterEnter&&i.afterEnter(),r=performance.now(),e.store.isTransitionActive.set(!1),a.resolve())))}},function(e){let t=0;const s=e.app.$device.type.phone?4:8,i=s*s,o=e.store={chunkDivisor:s,renderOrder:{islandBase:t++,islandChunks:(t+=i)-i,grass:t++,vehicles:t++,character:t++,spritesUnderwater:t++,skybox:t++,water:t++,sprites:t++,bubbles:t++,fintechHalos:t++,transitionPlane:t++},islands:{lights:{directional:{target:new n(-1,2,.6)}}},npcMinDistance:pe(5400),npcMaxDistance:pe(6900),dynamicShadowSize:pe(2048),grass:{radius:1},characterScale:.89,interactionButton:pe(null),chunksCastShadow:pe(!0),windVisible:pe(!0),waterVisible:pe(!0),inDialog:pe(!1),joystickVisible:pe(!1),isTransitionActive:pe(!1),phoneVisible:pe(!1),isInCustomize:pe(!1),onPhone:pe(!1),cameraInsideSpatial:pe(!1),bgmVolumeScalar:pe(1),spatialMusicVolumeScalar:pe(0),miniGame:{countdown:pe(5),elapsedTime:pe(0),started:pe(!1),completed:pe(!1),replay:a()},circuitGame:{countdown:pe(5),elapsedTime:pe(0),started:pe(!1),completed:pe(!1),replay:a()},intro:{resetTimers:a(),ctaHover:a(),journeyStarted:pe(!1),startJourneyVisible:pe(!1),descentDone:pe(!1)},updatePlayerOutfit:a(),updatePlayerAttributes:a(),debounceInteractionDone:a(),isSoundUnlocked:pe(!1),playerPosition:new n,playerOrientation:0,isDuckingBgm:pe(!1),isMutingBgm:pe(!1),frozenPlayerDelay:0,outfitDebounce:50,isOnZipline:!1,biomes:Fr};o.isPreloaderHidden=pe(!1),Nt((()=>o.isPreloaderHidden.set(e.app.$preloader.hidden))),o.isMenuOpen=pe(),Nt((()=>o.isMenuOpen.set(e.app.$store.isMenuOpen)));let r=null;const l=()=>e.app.$store.isInteractionDone=!1;o.debounceInteractionDone.watch(((t=1500)=>{clearTimeout(r),e.app.$store.isInteractionDone=!0,r=setTimeout(l,t)})),o.renderStopped=jt([o.onPhone,o.isMenuOpen,o.isTransitionActive],((e,t,s)=>(e||t)&&!s)),o.renderPaused=jt([],(e=>!!e)),o.routeName=pe(),Nt((()=>o.routeName.set(e.app.$route.name))),o.isCustomizing=pe(),o.isConfettisActive=pe(!1);let c=null,h=()=>o.isConfettisActive.set(!1);Nt((()=>{const t=e.app.$store.isConfettisActive;clearTimeout(c),t?o.isConfettisActive.set(!0):c=setTimeout(h,2500)})),o.isNotifActive=pe(),Nt((()=>o.isNotifActive.set(e.app.$notifs.isNotifActive.value))),o.isStarted=pe(!1),o.qualityPaused=jt([o.isStarted,o.inDialog,o.isTransitionActive,o.routeName,o.isConfettisActive,o.isNotifActive,o.phoneVisible],((e,t,s,i,o,a,n)=>o||!e||t||s||a||n||"Customize"===i||"Phone"===i));let u=!0;o.qualityPaused.watch((t=>{t?e.quality.pause():(e.quality.resume(u?400:1e3),u=!1)})),o.isOverlayVisible=pe(!1),Nt((()=>o.isOverlayVisible.set(e.app.$store.isOverlayVisible)));const d=pe(),p=pe();Nt((()=>d.set(e.app.$notifs.isOverlayActive.value))),Nt((()=>p.set(e.app.$store.sceneState>=e.app.$store.sceneStates.Playing))),Nt((()=>{o.phoneVisible.set(!!e.app.$store.phone.isReady)})),o.interactionVisibles=jt([d,o.routeName,p,o.phoneVisible],((e,t,s,i)=>s&&!e&&"Home"==t&&!i)),Nt((()=>o.isInCustomize.set("Customize"===e.app.$route.name)));const f=()=>e.app.$store.isTransitionActive=!1;o.isTransitionActive.watch((t=>{clearTimeout(null),t?e.app.$store.isTransitionActive=!0:setTimeout(f,600)}))},function(e,{log:t}){e.initPhysics=async function(e=null){return await new bl(t)}},function(e){let t,s,i=!1;const o={},a={init:function(){if(i)return;i=!0;const a={renderOrder:e.store.renderOrder.sprites,material:qh,atlas:e.atlas,blending:"normal",transparent:!0,depthWrite:!1,depthTest:!1};Object.assign(o,{normal:new Gh({...a,blending:"normal",depthTest:!0,depthWrite:!1,count:1e3}),emissive:new Gh({...a,blending:"additive",depthTest:!0,depthWrite:!1,count:1e3}),noDepthEmissive:new Gh({...a,blending:"additive"}),noDepth:new Gh({...a}),depthSDF:new Gh({...a,useAlphaSDF:!0,depthTest:!0,depthWrite:!0,renderOrder:e.store.renderOrder.bubbles}),underwater:new Gh({...a,blending:"normal",depthTest:!0,renderOrder:e.store.renderOrder.spritesUnderwater,count:70})}),t=Object.values(o);for(let e in o)o[e].triggerInit(o[e].props);s=new Uh({batchers:o,count:3e3}),Kh.forEach((e=>s.registerPreset(e.id,e.module)))},emit:function(e,t={}){if(!s)return;const i=t.batcherID||"default";return s.emit(e,t,i)},update:function(){if(!i)return;for(let e=0,s=t.length;e<s;e++)t[e].update();s.update()},addTo:function(e){this.removeFromParent();for(let s=0,i=t.length;s<i;s++){const i=t[s].base;e.add(i),i.manualMatrixUpdate=!0,i.updateMatrixWorld()}},removeFromParent:function(){for(let e=0,s=t.length;e<s;e++){const s=t[e];s.base.parent&&s.base.parent.remove(s.base)}s.killAll()},batchers:o};e.particles=a},function(e){const t=pe(!1);let s,i,o,a=!1,n=!1;const r=e=>e.update(o),l={},c=new Set;let h=1;const u={main:1,fade:1,smoothMute:1,mute:1},d={muted:t,init:function(){if(a)return;a=!0,mu.debug=!0,mu.onUnlock=g,mu.onContextCreation=f,mu.onStuck=m,mu.init(),ue.add(b),Nt((()=>{const t=e.app.$store.isAudioMuted||e.app.$store.isVideoPlaying;d.muted.set(t)})),e.viewport.visible.watch(p),d.muted.watchImmediate(y)},unlocked:pe(!1),get masterVolume(){return h},getContext:()=>s,getInput:()=>i,list:bu,play:_,pause:x,stop:S,playSound:M,stopSound:function(e,t={}){const s=l[e];if(!s)return;s.forEach((e=>e.stop(t)))},preloadSound:function(e){const t=bu[e];if(!t)return;const i=t.path;return su(s,i)}};function p(e){s&&(e?(_(),u.fade=1):(x(),u.fade=0),w())}function f(e){s=e,i=e.createGain(),i.connect(e.destination);for(let t=0;t<20;t++){new iu(d).release()}}function m(){S(),d.unlocked.set(!1)}function g(){d.unlocked.set(!0),e.quality.reset(1e3)}function y(e){u.mute=e?0:1}function b(e){if(mu.isUnlocked()){o=e;for(const t of c)t.timer-=e,t.timer<=0&&(c.delete(t),M(t.id,t.opts));if(w(),!n)for(const e in l)l[e].forEach(r)}}d.bgm=Su(e,d),e.audio=d;let v=-1;function w(){const e=u;e.smoothMute=ae(e.smoothMute,e.mute,.1,.001),h=e.main*e.fade*e.smoothMute,h!==v&&(v=h,mu.setVolume(i,h))}function _(){if(n){n=!1;for(const e in l)l[e].forEach((e=>{e.loop||e.play()}))}}function x(){if(!n){n=!0;for(const e in l)l[e].forEach((e=>{e.loop||e.pause()}))}}function S(){for(const e in l)l[e].forEach((e=>e.stop()))}function M(e,t={}){if(t.delay,!mu.isUnlocked())return;const s=bu[e];if(!s)return;if(t.delay){const s=t.delay;return delete t.delay,void c.add({id:e,opts:t,timer:s})}if(l[e]||(l[e]=new Set),s.unique&&l[e].size>0){const t=l[e].values().next().value;return t.play(),t}if(t.id=e,t.path=s.path,t.onStop=T,t.autoplay=t.autoplay??!0,t.loop=Mu(t.loop,!!s.loop),t.fadein=t.fadein||s.fadein,t.fadeout=t.fadeout||s.fadeout,s.variations){let e=t.variation&&s.variations[t.variation-1];e||(e=Oo(s.variations)),t.start=Mu(t.start,e.start),t.duration=Mu(t.duration,e.duration),t.loopStart=Mu(t.loopStart,Mu(e.loopStart,t.start)),t.loopEnd=Mu(t.loopEnd,Mu(e.loopEnd,t.start+t.duration))}else t.start=Mu(t.start,s.start),t.duration=Mu(t.duration,s.duration),t.loopStart=Mu(t.loopStart,Mu(s.loopStart,t.start)),t.loopEnd=Mu(t.loopEnd,Mu(s.loopEnd,t.start+t.duration));var i,o;t.volume=Mu(t.volume,Mu(s.volume,1)),t.playbackRate=s.randomRate?(i=s.randomRate[0],o=s.randomRate[1],Math.random()*(o-i)+i):null!=t.playbackRate?t.playbackRate:1;const a=iu.get(d,t);return l[e].add(a),a}function T(e){const t=l;e.release();const s=t[e.id];s&&s.delete(e)}},function(e){e.input={init(){this.touch=function(e){let t;const s=e.viewport,i=pe({pressed:!1,clickIn:!1,clickOut:!1,pos:new r,relativePos:new r,delta:new r,normalizePos:new r,normalizeRelativePos:new r,firstPos:new r});i.togglePointer=function(e){document.body.classList.toggle("pointer",e)},i.swipe=pe();const o={firstPos:new r,prevPos:new r,clickIn:!1,clickOut:!1,pressed:!1,pos:new r(0,0),relativePos:new r(0,0),delta:new r(0,0),interactive:!1,active:!1,useTouch:!1};function a(e){return e.changedTouches[0]}function n(e){const s=!!e.changedTouches;if(s)ku();else if(Au)return;if(!s&&0!==e.button)return;if(!Pu(e))return;e.preventDefault(),Cu=performance.now();const i=s?a(e):e;o.useTouch=s||Au,o.delta.set(0,0),o.firstPos.set(i.clientX||0,i.clientY||0),o.prevPos.copy(o.firstPos),o.pos.copy(o.firstPos),o.pressed=!0,o.clickIn=!0,o.clickOut=!1,t=!0,h()}function l(e){const s=!!e.changedTouches,i=s?a(e):e;o.useTouch=s||Au,o.pos.set(i.clientX||0,i.clientY||0),o.pressed?o.relativePos.copy(o.pos).sub(o.firstPos):o.relativePos.set(0,0),t=!0}function c(e){const s=!!e.changedTouches;if(s)ku();else if(Au)return;if(!s&&0!==e.button)return;if(Pu(e))e.preventDefault();else if(!o.pressed)return;if(s){let e=0;const t=3;if(performance.now()-Cu<220){const s=o.relativePos.x,i=o.relativePos.y,a=180*Math.atan2(i,s)/Math.PI+90;a>=-45+t&&a<45-t?e=1:a>=45+t&&a<135-t?e=2:a>=135+t&&a<225-t?e=3:(a>=225+t||a<-45-t)&&(e=4)}i.swipe.set(e,!0)}else i.swipe.set(0);const n=s?a(e):e;o.useTouch=s||Au,o.pos.set(n.clientX||0,n.clientY||0),o.clickIn=!1,o.clickOut=o.pressed,t=!0,o.pressed=!1,h(),t=!0,o.relativePos.set(0,0)}function h(){const e=i.value;e.useTouch=o.useTouch,e.pressed=o.pressed,e.clickIn=o.clickIn,e.clickOut=o.clickOut,e.pos.copy(o.pos),e.relativePos.copy(o.relativePos),e.delta.copy(o.delta),e.firstPos.copy(o.firstPos);const t={x:s.size.value.x,y:s.size.value.y};e.normalizePos.set(cs(e.pos.x,0,t.x,-1,1),cs(e.pos.y,0,t.y,1,-1)),e.normalizeRelativePos.copy(e.relativePos).divide(t),i.set(e,!0)}Object.assign(i,{update:function(){(o.clickIn||o.clickOut)&&(t=!0),o.clickOut=o.clickIn=!1,o.delta.copy(o.pos).sub(o.prevPos),o.prevPos.copy(o.pos);const e=i.value.delta;t||(t=!o.delta.equals(e)||0!==o.delta),t&&h(),t=!1}});const u=window,d="addEventListener",p={passive:!1};return u[d]("touchstart",n,p),u[d]("touchmove",l,p),u[d]("touchend",c,p),u[d]("touchcancel",c,p),u[d]("mousedown",n,p),u[d]("mousemove",l,p),u[d]("mouseup",c,p),u[d]("gesturestart",(e=>e.preventDefault()),p),i}(e),this.keyboard=Uu(e),e.hooks.beforeFrame.watch((()=>{this.touch.update()}))}}}];function Bu(e={}){return hs({decorator:da,plugins:zu,...e})}export{Bu as loadWebGL};
